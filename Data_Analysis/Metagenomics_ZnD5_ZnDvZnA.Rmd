---
title: "Metagenomics_ZnD5_ZnDvZnA"
output: html_document
date: "2025-02-18"
---

#LOAD METADATA

```{r}

metadata_ZnD5 <- read.table("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/ZnD5_metadata.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)
metadata_ZnD5$Treatment <- as.factor(metadata_ZnD5$Treatment)
metadata_ZnD5$Treatment <- relevel(metadata_ZnD5$Treatment, ref = "ZnA")
metadata_ZnD5$Sample <- gsub("ZnD5\\.", "ZnD5-", metadata_ZnD5$Sample)
metadata_ZnD5
```

#COMBINED DATA FOR BRACKEN USING SPECIES NAMES AS THE ROW NAMES

```{r}

library(data.table)
library(dplyr)
# List of Bracken files
file_list <- list.files(path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/braken_outputs/ZnDvsZnA/Species_Level/", pattern = "_bracken_output.txt", full.names = TRUE)

# Read each file and process
bracken_ZnD5 <- lapply(file_list, function(file) {
  # Extract sample name from the file name
  sample_name <- gsub("_bracken_output.txt", "", basename(file))
  
  # Read the file and keep necessary columns
  data <- read.table(file, header = TRUE, sep = "\t") %>%
    select(name, new_est_reads) %>%
    rename_with(~ sample_name, .cols = new_est_reads)  # Correct way to rename dynamically

  return(data)
})

# Merge all data by the "Taxon" column
combined_bracken_ZnD5 <- Reduce(function(x, y) merge(x, y, by = "name", all = TRUE), bracken_ZnD5)

# Replace NA with 0 (if there are missing taxa in some samples)
combined_bracken_ZnD5[is.na(combined_bracken_ZnD5)] <- 0

rownames(combined_bracken_ZnD5) <- combined_bracken_ZnD5$name
combined_bracken_ZnD5 <- combined_bracken_ZnD5[, -1]

write.csv(combined_bracken_ZnD5, "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/combined_data_ZnDZnA.csv", row.names = TRUE)
combined_bracken_ZnD5 <- read.csv("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/combined_bracken_output/combined_data_ZnDZnA.csv", row.names = 1)
colnames(combined_bracken_ZnD5) <- gsub("^X", "", colnames(combined_bracken_ZnD5))
combined_bracken_ZnD5
```

#COMBINED DATA FOR BRACKEN USING GENUS NAMES AS THE ROW NAMES

```{r}

library(data.table)
library(dplyr)
# List of Bracken files
file_list <- list.files(path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/braken_outputs/ZnDvsZnA/Genus_Level/", pattern = "_bracken_output.txt", full.names = TRUE)

# Read each file and process
bracken_ZnD5 <- lapply(file_list, function(file) {
  # Extract sample name from the file name
  sample_name <- gsub("_bracken_output.txt", "", basename(file))
  
  # Read the file and keep necessary columns
  data <- read.table(file, header = TRUE, sep = "\t") %>%
    select(name, new_est_reads) %>%
    rename_with(~ sample_name, .cols = new_est_reads)  # Correct way to rename dynamically

  return(data)
})

# Merge all data by the "Taxon" column
combined_bracken_ZnD5_G <- Reduce(function(x, y) merge(x, y, by = "name", all = TRUE), bracken_ZnD5)

# Replace NA with 0 (if there are missing taxa in some samples)
combined_bracken_ZnD5_G[is.na(combined_bracken_ZnD5_G)] <- 0

rownames(combined_bracken_ZnD5_G) <- combined_bracken_ZnD5_G$name
combined_bracken_ZnD5_G <- combined_bracken_ZnD5_G[, -1]

write.csv(combined_bracken_ZnD5_G, "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/combined_data_ZnDZnA_G.csv", row.names = TRUE)
combined_bracken_ZnD5_G <- read.csv("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/combined_bracken_output/combined_data_ZnDZnA_G.csv", row.names = 1)
colnames(combined_bracken_ZnD5_G) <- gsub("^X", "", colnames(combined_bracken_ZnD5_G))
combined_bracken_ZnD5_G
```
#COMBINED DATA FOR BRACKEN USING FAMILY NAMES AS THE ROW NAMES

```{r}

library(data.table)
library(dplyr)
# List of Bracken files
file_list <- list.files(path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/braken_outputs/ZnDvsZnA/Family_Level/", pattern = "_bracken_output.txt", full.names = TRUE)

# Read each file and process
bracken_ZnD5 <- lapply(file_list, function(file) {
  # Extract sample name from the file name
  sample_name <- gsub("_bracken_output.txt", "", basename(file))
  
  # Read the file and keep necessary columns
  data <- read.table(file, header = TRUE, sep = "\t") %>%
    select(name, new_est_reads) %>%
    rename_with(~ sample_name, .cols = new_est_reads)  # Correct way to rename dynamically

  return(data)
})

# Merge all data by the "Taxon" column
combined_bracken_ZnD5_F <- Reduce(function(x, y) merge(x, y, by = "name", all = TRUE), bracken_ZnD5)

# Replace NA with 0 (if there are missing taxa in some samples)
combined_bracken_ZnD5_F[is.na(combined_bracken_ZnD5_F)] <- 0

rownames(combined_bracken_ZnD5_F) <- combined_bracken_ZnD5_F$name
combined_bracken_ZnD5_F <- combined_bracken_ZnD5_F[, -1]

write.csv(combined_bracken_ZnD5_F, "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/combined_data_ZnDZnA_F.csv", row.names = TRUE)
combined_bracken_ZnD5_F <- read.csv("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/combined_bracken_output/combined_data_ZnDZnA_F.csv", row.names = 1)
colnames(combined_bracken_ZnD5_F) <- gsub("^X", "", colnames(combined_bracken_ZnD5_F))
combined_bracken_ZnD5_F
```

#COMBINED DATA FOR BRACKEN USING PHYLUM NAMES AS THE ROW NAMES

```{r}

library(data.table)
library(dplyr)
# List of Bracken files
file_list <- list.files(path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/braken_outputs/ZnDvsZnA/Phylum_Level/", pattern = "_bracken_output.txt", full.names = TRUE)

# Read each file and process
bracken_ZnD5 <- lapply(file_list, function(file) {
  # Extract sample name from the file name
  sample_name <- gsub("_bracken_output.txt", "", basename(file))
  
  # Read the file and keep necessary columns
  data <- read.table(file, header = TRUE, sep = "\t") %>%
    select(name, new_est_reads) %>%
    rename_with(~ sample_name, .cols = new_est_reads)  # Correct way to rename dynamically

  return(data)
})

# Merge all data by the "Taxon" column
combined_bracken_ZnD5_P <- Reduce(function(x, y) merge(x, y, by = "name", all = TRUE), bracken_ZnD5)

# Replace NA with 0 (if there are missing taxa in some samples)
combined_bracken_ZnD5_P[is.na(combined_bracken_ZnD5_P)] <- 0

rownames(combined_bracken_ZnD5_P) <- combined_bracken_ZnD5_P$name
combined_bracken_ZnD5_P <- combined_bracken_ZnD5_P[, -1]

write.csv(combined_bracken_ZnD5_P, "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/combined_data_ZnDZnA_P.csv", row.names = TRUE)
combined_bracken_ZnD5_P <- read.csv("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/combined_bracken_output/combined_data_ZnDZnA_P.csv", row.names = 1)
colnames(combined_bracken_ZnD5_P) <- gsub("^X", "", colnames(combined_bracken_ZnD5_P))
combined_bracken_ZnD5_P
```

#COMBINED DATA FOR BRACKEN USING KINGDOM NAMES AS THE ROW NAMES

```{r}

library(data.table)
library(dplyr)
# List of Bracken files
file_list <- list.files(path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/braken_outputs/ZnDvsZnA/Kingdom_Level/", pattern = "_bracken_output.txt", full.names = TRUE)

# Read each file and process
bracken_ZnD5 <- lapply(file_list, function(file) {
  # Extract sample name from the file name
  sample_name <- gsub("_bracken_output.txt", "", basename(file))
  
  # Read the file and keep necessary columns
  data <- read.table(file, header = TRUE, sep = "\t") %>%
    select(name, new_est_reads) %>%
    rename_with(~ sample_name, .cols = new_est_reads)  # Correct way to rename dynamically

  return(data)
})

# Merge all data by the "Taxon" column
combined_bracken_ZnD5_K <- Reduce(function(x, y) merge(x, y, by = "name", all = TRUE), bracken_ZnD5)

# Replace NA with 0 (if there are missing taxa in some samples)
combined_bracken_ZnD5_K[is.na(combined_bracken_ZnD5_K)] <- 0

rownames(combined_bracken_ZnD5_K) <- combined_bracken_ZnD5_K$name
combined_bracken_ZnD5_K <- combined_bracken_ZnD5_K[, -1]

write.csv(combined_bracken_ZnD5_K, "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/combined_data_ZnDZnA_K.csv", row.names = TRUE)
combined_bracken_ZnD5_K <- read.csv("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/combined_bracken_output/combined_data_ZnDZnA_K.csv", row.names = 1)
colnames(combined_bracken_ZnD5_K) <- gsub("^X", "", colnames(combined_bracken_ZnD5_K))
combined_bracken_ZnD5_K
```

#GENERATE A READS BOXPLOT TO IDENTIFY ANY MAJOR CHANGES IN READ NUMBERS BETWEEN GROUPS. BASED ON THE RESULTS BELOW, THERE ARE NO SIGNIFICANT DIFFERENCES BETWEEN OUR TOTAL READS IN THE DIFFERENT TREATMENT GROUPS. THEREFORE, I WILL NOT BE RAREFYING MY READS

```{r}
library(ggplot2)
library(dplyr)
library(ggpubr)
library(tidyr)  # for pivot_longer
library(tibble) # for rownames_to_column

# Define your custom group colors
group_colors <- c(
  "ZnD colon" = "#E8B31A",
  "ZnD intestine" = "#56B4E9",
  "ZnD cecum" = "#009E73",
  "ZnA colon" = "#F0E442",
  "ZnA intestine" = "#75AE33",
  "ZnA cecum" = "#D55E00"
)

# Reshape and merge with metadata
bracken_long <- combined_bracken_ZnD5 %>%
  as.data.frame() %>%
  rownames_to_column(var = "Species") %>%
  pivot_longer(cols = -Species, names_to = "Sample", values_to = "Reads") %>%
  left_join(metadata_ZnD5, by = c("Sample" = "Sample")) %>%
  mutate(Group = paste(Treatment, Location, sep = " "))

# Summarize total reads per sample
total_reads_per_sample <- bracken_long %>%
  group_by(Sample, Treatment, Location) %>%
  summarise(Total_Reads = sum(Reads, na.rm = TRUE), .groups = "drop") %>%
  mutate(Group = paste(Treatment, Location, sep = " "))

# Create the plot
read_dist_ZnD5 <- ggplot(total_reads_per_sample, aes(x = Group, y = Total_Reads, fill = Group)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.6, width=0.4) +
  geom_jitter(width = 0.2, size = 2, alpha = 0.8) +
  scale_y_log10() +
  scale_fill_manual(values = group_colors) +
  stat_compare_means(
    method = "wilcox.test", label = "p.signif",
    comparisons = list(
      c("ZnA colon", "ZnA cecum"),
      c("ZnA intestine", "ZnA cecum"),
      c("ZnD cecum", "ZnA cecum"),
      c("ZnD colon", "ZnA cecum"),
      c("ZnD intestine", "ZnA cecum"),
      c("ZnA colon", "ZnA intestine"),
      c("ZnA colon", "ZnD cecum"),
      c("ZnD colon", "ZnA colon"),
      c("ZnA colon", "ZnD intestine"),
      c("ZnD cecum", "ZnA intestine"),
      c("ZnD colon", "ZnA intestine"),
      c("ZnD intestine", "ZnA intestine"),
      c("ZnD colon", "ZnD cecum"),
      c("ZnD intestine", "ZnD cecum"),
      c("ZnD colon", "ZnD intestine")
    )
  ) +
  labs(
    title = "Total Read Counts per Sample by\n Treatment and Location",
    x = "Group",
    y = "Total Reads (log10 scale)",
    fill = "Group"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 18),
    axis.title.x = element_text(face = "bold", size = 16),
    axis.text.x = element_text(size = 14, face = "bold", angle = 45, hjust = 1),
    axis.title.y = element_text(face = "bold", size = 16),
    legend.position = "none"
  )

# Display the plot
read_dist_ZnD5

# Save the plot
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/read_dist_ZnD5.png",
      plot = read_dist_ZnD5, width = 5, height = 6, dpi = 300)

```

#MAKE PCA PLOT GRAPHING BRAY CURTIS DISSIMILARITY FOR DIMENSIONALITY REDUCTION

```{r}
# Load required libraries
library(ggplot2)
library(vegan)  # For Bray-Curtis distance
library(dplyr)  # Data manipulation
library(janitor) # Cleaning column names
library(ggrepel) # For sample labels

# 🔹 Merge Bracken data with metadata
pcoa_input_ZnD5 <- merge(t(combined_bracken_ZnD5), metadata_ZnD5, by.x = "row.names", by.y = "Sample")
colnames(pcoa_input_ZnD5)[1] <- "Sample"  # Ensure first column is Sample
pcoa_input_ZnD5
# 🔹 Select only numerical abundance data
pcoa_numeric_ZnD5 <- pcoa_input_ZnD5[, !(colnames(pcoa_input_ZnD5) %in% c("Sample", "Treatment", "Location"))]

# Convert the matrix to character (in case some columns are factors)
pcoa_numeric_ZnD5 <- apply(pcoa_numeric_ZnD5, 2, as.character)

# Trim leading/trailing spaces and convert to numeric
pcoa_numeric_ZnD5 <- apply(pcoa_numeric_ZnD5, 2, function(x) as.numeric(trimws(x)))

# Ensure it is a numeric matrix
pcoa_numeric_ZnD5 <- as.matrix(pcoa_numeric_ZnD5)
pcoa_numeric_ZnD5
# Check that the conversion worked
str(pcoa_numeric_ZnD5)  # Should display 'num' type

# Replace NA values with 0 to avoid division errors
pcoa_numeric_ZnD5[is.na(pcoa_numeric_ZnD5)] <- 0

# Compute row sums
row_sums <- rowSums(pcoa_numeric_ZnD5)

# Check if there are any zero row sums
print(sum(row_sums == 0))  # If this prints >0, you have zero-sum rows!


# 🔹 Normalize by total reads per sample (relative abundance)
pcoa_numeric_ZnD5 <- pcoa_numeric_ZnD5 / rowSums(pcoa_numeric_ZnD5)
pcoa_numeric_ZnD5
# 🔹 Compute Bray-Curtis distance matrix
bray_curtis_dist <- vegdist(pcoa_numeric_ZnD5, method = "bray")

# 🔹 Perform PCoA (Principal Coordinates Analysis)
pcoa_result_ZnD5 <- cmdscale(bray_curtis_dist, k = 2, eig = TRUE)  # Compute eigenvalues

# 🔹 Convert PCoA results into a data frame
pcoa_scores_ZnD5 <- as.data.frame(pcoa_result_ZnD5$points)
colnames(pcoa_scores_ZnD5) <- c("PC1", "PC2")
pcoa_scores_ZnD5$Sample <- pcoa_input_ZnD5$Sample

# 🔹 Merge PCoA scores with metadata
pcoa_scores_ZnD5 <- merge(pcoa_scores_ZnD5, metadata_ZnD5, by = "Sample")

# 🔹 Calculate variance explained
pc1_variance_ZnD5 <- round(100 * (pcoa_result_ZnD5$eig[1] / sum(pcoa_result_ZnD5$eig)), 1)
pc2_variance_ZnD5 <- round(100 * (pcoa_result_ZnD5$eig[2] / sum(pcoa_result_ZnD5$eig)), 1)

# 🔹 Print variance explained
cat("PC1 Variance:", pc1_variance_ZnD5, "%\n")
cat("PC2 Variance:", pc2_variance_ZnD5, "%\n")

# 🔹 Create a new Grouping variable: "ZnD/ZnA" + "Location"
pcoa_scores_ZnD5$Group <- paste(pcoa_scores_ZnD5$Treatment, pcoa_scores_ZnD5$Location, sep = " ")

# 🔹 Define colors for the 6 groups
group_colors <- c(
  "ZnD colon" = "#E8B31A", "ZnD intestine" = "#56B4E9", "ZnD cecum" = "#009E73",
  "ZnA colon" = "#F0E442", "ZnA intestine" = "#75AE33", "ZnA cecum" = "#D55E00"
)

pcoa_scores_ZnD5
# 🔹 PCoA Plot: ZnD/ZnA Groups
pcoa_plot_ZnD5 <- ggplot(pcoa_scores_ZnD5, aes(x = PC1, y = PC2, color = Group, fill = Group)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.2) +  # Add filled ellipses
  scale_color_manual(values = group_colors) +
  scale_fill_manual(values = group_colors) +
  theme_minimal() +
  labs(
    title = "PCoA (Bray-Curtis) - ZnD5 Groups",
    x = paste0("PC1 (", pc1_variance_ZnD5, "%)"),
    y = paste0("PC2 (", pc2_variance_ZnD5, "%)"),
    color = "Group"
  ) +
  theme(
    legend.position = "right",
    legend.title = element_text(size = 22, face = "bold"),
    legend.text = element_text(size = 20),
    panel.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(face = "bold", size = 24),
    axis.title.x = element_text(face = "bold", size = 20),
    axis.title.y = element_text(face = "bold", size = 20)
  )

# 🔹 Save and print the plot
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/PCoA/pcoa_ZnD5.png",
       plot = pcoa_plot_ZnD5, width = 8, height = 6, dpi = 300)
pcoa_plot_ZnD5

```

```{r}
# 🔹 PCoA Plot: ZnD vs ZnA (ignoring location)
pcoa_plot_treatment <- ggplot(pcoa_scores_ZnD5, aes(x = PC1, y = PC2, color = Treatment, fill = Treatment)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.2) +  # Add filled ellipses
  scale_color_manual(values = c("ZnD" = "#E8B31A", "ZnA" = "#75AE33")) +
  scale_fill_manual(values = c("ZnD" = "#E8B31A", "ZnA" = "#75AE33")) +
  theme_minimal() +
  labs(
    title = "PCoA (Bray-Curtis) - ZnD vs ZnA",
    x = paste0("PC1 (", pc1_variance_ZnD5, "%)"),
    y = paste0("PC2 (", pc2_variance_ZnD5, "%)"),
    color = "Treatment"
  ) +
  theme(
    legend.position = "right",
    legend.title = element_text(size = 22, face = "bold"),
    legend.text = element_text(size = 20),
    panel.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(face = "bold", size = 24),
    axis.title.x = element_text(face = "bold", size = 20),
    axis.title.y = element_text(face = "bold", size = 20)
  )

# 🔹 Save the ZnD vs ZnA plot
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/PCoA/pcoa_treatment.png",
       plot = pcoa_plot_treatment, width = 8, height = 6, dpi = 300)

# 🔹 Display the plot
pcoa_plot_treatment

```

```{r}
# 🔹 PCoA Plot: Colon vs Intestine vs Cecum (ignoring treatment)
pcoa_plot_location <- ggplot(pcoa_scores_ZnD5, aes(x = PC1, y = PC2, color = Location, fill = Location)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.2) +  # Add filled ellipses
  scale_color_manual(values = c("colon" = "#D55E00", "intestine" = "#56B4E9", "cecum" = "#009E73")) +
  scale_fill_manual(values = c("colon" = "#D55E00", "intestine" = "#56B4E9", "cecum" = "#009E73")) +
  theme_minimal() +
  labs(
    title = "PCoA (Bray-Curtis)",
    x = paste0("PC1 (", pc1_variance_ZnD5, "%)"),
    y = paste0("PC2 (", pc2_variance_ZnD5, "%)"),
    color = "Location"
  ) +
  theme(
    legend.position = "right",
    legend.title = element_text(size = 22, face = "bold"),
    legend.text = element_text(size = 20),
    panel.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(face = "bold", size = 24),
    axis.title.x = element_text(face = "bold", size = 20),
    axis.title.y = element_text(face = "bold", size = 20)
  )

# 🔹 Save the Colon vs Intestine vs Cecum plot
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/pcoa_location.png",
       plot = pcoa_plot_location, width = 8, height = 6, dpi = 300)

# 🔹 Display the plot
pcoa_plot_location

```

```{r}
# 🔹 Subset data for Intestine only
pcoa_scores_intestine <- pcoa_scores_ZnD5 %>% filter(Location == "intestine")

# 🔹 PCoA Plot: Intestine ZnA vs. ZnD
pcoa_plot_intestine <- ggplot(pcoa_scores_intestine, aes(x = PC1, y = PC2, color = Treatment, fill = Treatment)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.2) +  
  scale_color_manual(values = c("ZnD" = "#E8B31A", "ZnA" = "#75AE33")) +
  scale_fill_manual(values = c("ZnD" = "#E8B31A", "ZnA" = "#75AE33")) +
  theme_minimal() +
  labs(
    title = "PCoA (Bray-Curtis) - Intestine",
    x = paste0("PC1 (", pc1_variance_ZnD5, "%)"),
    y = paste0("PC2 (", pc2_variance_ZnD5, "%)"),
    color = "Treatment"
  ) +
  theme(
    legend.position = "right",
    legend.title = element_text(size = 22, face = "bold"),
    legend.text = element_text(size = 20),
    panel.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(face = "bold", size = 24),
    axis.title.x = element_text(face = "bold", size = 20),
    axis.title.y = element_text(face = "bold", size = 20)
  )

# 🔹 Save the Intestine plot
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/PCoA/pcoa_intestine.png",
       plot = pcoa_plot_intestine, width = 8, height = 6, dpi = 300)

# 🔹 Display the plot
pcoa_plot_intestine

```

```{r}
# 🔹 Subset data for Colon only
pcoa_scores_colon <- pcoa_scores_ZnD5 %>% filter(Location == "colon")

# 🔹 PCoA Plot: Colon ZnA vs. ZnD
pcoa_plot_colon <- ggplot(pcoa_scores_colon, aes(x = PC1, y = PC2, color = Treatment, fill = Treatment)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.2) +  
  scale_color_manual(values = c("ZnD" = "#E8B31A", "ZnA" = "#75AE33")) +
  scale_fill_manual(values = c("ZnD" = "#E8B31A", "ZnA" = "#75AE33")) +
  theme_minimal() +
  labs(
    title = "PCoA (Bray-Curtis) - Colon",
    x = paste0("PC1 (", pc1_variance_ZnD5, "%)"),
    y = paste0("PC2 (", pc2_variance_ZnD5, "%)"),
    color = "Treatment"
  ) +
  theme(
    legend.position = "right",
    legend.title = element_text(size = 22, face = "bold"),
    legend.text = element_text(size = 20),
    panel.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(face = "bold", size = 24),
    axis.title.x = element_text(face = "bold", size = 20),
    axis.title.y = element_text(face = "bold", size = 20)
  )

# 🔹 Save the Colon plot
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/PCoA/pcoa_colon.png",
       plot = pcoa_plot_colon, width = 8, height = 6, dpi = 300)

# 🔹 Display the plot
pcoa_plot_colon


```

```{r}
# 🔹 Subset data for Cecum only
pcoa_scores_cecum <- pcoa_scores_ZnD5 %>% filter(Location == "cecum")

# 🔹 PCoA Plot: Cecum ZnA vs. ZnD
pcoa_plot_cecum <- ggplot(pcoa_scores_cecum, aes(x = PC1, y = PC2, color = Treatment, fill = Treatment)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.2) +  
  scale_color_manual(values = c("ZnD" = "#E8B31A", "ZnA" = "#75AE33")) +
  scale_fill_manual(values = c("ZnD" = "#E8B31A", "ZnA" = "#75AE33")) +
  theme_minimal() +
  labs(
    title = "PCoA (Bray-Curtis) - Cecum",
    x = paste0("PC1 (", pc1_variance_ZnD5, "%)"),
    y = paste0("PC2 (", pc2_variance_ZnD5, "%)"),
    color = "Treatment"
  ) +
  theme(
    legend.position = "right",
    legend.title = element_text(size = 22, face = "bold"),
    legend.text = element_text(size = 20),
    panel.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(face = "bold", size = 24),
    axis.title.x = element_text(face = "bold", size = 20),
    axis.title.y = element_text(face = "bold", size = 20)
  )

# 🔹 Save the Cecum plot
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/PCoA/pcoa_cecum.png",
       plot = pcoa_plot_cecum, width = 8, height = 6, dpi = 300)

# 🔹 Display the plot
pcoa_plot_cecum

```

#DATAFRAME FROM KRAKEN OUTPUT TO CALCULATE THE ABUNDANCE OF BACTERIA, FUNGI, AND VIRUSES ACROSS SAMPLES

```{r}
library(dplyr)

# Set the folder path
input_folder <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/kraken_outputs/ZnDvsZnA/kraken/"

# List all Kraken report files in the folder
file_list <- list.files(path = input_folder, pattern = "*_report.txt", full.names = TRUE)

# Initialize an empty list to store results
taxon_counts <- list()

# Loop through each Kraken report file
for (file in file_list) {
  
  # Read the Kraken report file
  kraken_report <- read.delim(file, header = FALSE, sep = "\t", stringsAsFactors = FALSE)
  
  # Rename columns (adjust as needed based on the structure of your file)
  colnames(kraken_report) <- c("Percent_Reads", "Reads_This_Taxon", "Reads_Clade", "Rank_Code", "Taxonomy_ID", "Taxon_Name")
  
  # Filter for taxa of interest
  filtered_taxa <- kraken_report %>%
    filter(Taxon_Name %in% c("    Bacteria", "  Viruses", "        Fungi"))
  
  # Aggregate counts for each taxon
  taxon_summary <- filtered_taxa %>%
    group_by(Taxon_Name) %>%
    summarize(Read_Count = sum(Reads_This_Taxon), .groups = "drop")
  
  # Add the sample name (derived from the filename)
  taxon_summary$Sample <- gsub("_report.txt", "", basename(file))
  
  # Append to the list
  taxon_counts[[file]] <- taxon_summary
}

# Combine all results into a single dataframe
combined_taxon_counts <- bind_rows(taxon_counts)

# Normalize counts by total reads per sample
# Calculate total reads per sample
total_reads <- combined_taxon_counts %>%
  group_by(Sample) %>%
  summarize(Total_Reads = sum(Read_Count))

# Join total reads with the combined taxon counts
normalized_taxon_counts <- combined_taxon_counts %>%
  left_join(total_reads, by = "Sample") %>%
  mutate(Relative_Abundance = Read_Count / Total_Reads * 100)

transformed_df_PF <- normalized_taxon_counts %>%
  select(Taxon_Name, Sample, Read_Count) %>% # Keep relevant columns
  pivot_wider(
    names_from = Sample,           # Columns become Sample names
    values_from = Read_Count, # Values are from Relative_Abundance
    values_fill = 0                # Fill missing values with 0
  )

transformed_df_PF <- as.data.frame(transformed_df_PF)
rownames(transformed_df_PF) <- transformed_df_PF$Taxon_Name
transformed_df_PF <- transformed_df_PF[, -1]
# Rename columns: replace "-" with "." and remove "_kraken"
colnames(transformed_df_PF) <- gsub("-", ".", colnames(transformed_df_PF))  # Replace "-" with "."
colnames(transformed_df_PF) <- gsub("_kraken$", "", colnames(transformed_df_PF))  # Remove "_kraken" at the end
transformed_df_PF <- transformed_df_PF[, colnames(transformed_df_PF) %in% metadata_ZnD5$Sample]


write.csv(transformed_df_PF, "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/kingdom_classification_ZnD5.csv", row.names = TRUE)

kingdom_classification_ZnD5 <- read.csv("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/kingdom_classification_ZnD5.csv", row.names = 1)
kingdom_classification_ZnD5

colnames(kingdom_classification_ZnD5) <- gsub("^X", "", colnames(kingdom_classification_ZnD5))
rownames(kingdom_classification_ZnD5)

```

#PLOT SIMPLE RELATIVE ABUNDANCE GRAPH VISUALIZING THE PRESENCE OF BACTERIAL, FUNGAL, AND VIRAL READS
```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggbreak)  # Import the package for axis breaks

# Convert read counts to relative abundance (%)
relative_abundance_df <- kingdom_classification_ZnD5 %>%
  mutate(across(everything(), ~ . / sum(.) * 100)) %>%
  tibble::rownames_to_column(var = "Kingdom") %>%
  pivot_longer(cols = -Kingdom, names_to = "Sample", values_to = "Relative_Abundance")

# Merge with metadata to get treatment groups
relative_abundance_df <- relative_abundance_df %>%
  left_join(metadata_ZnD5, by = c("Sample" = "Sample"))

relative_abundance_df

relative_abundance_df$Kingdom <- factor(relative_abundance_df$Kingdom, levels = c("    Bacteria", "        Fungi", "  Viruses"))
# Create boxplot with a y-axis break
boxplot_relative_abundance <- ggplot(relative_abundance_df, aes(x = Kingdom, y = Relative_Abundance, fill = Kingdom)) +
  geom_boxplot(outlier.shape = NA, width = 0.8) +
  geom_jitter(width = 0.15, alpha = 0.1) +  # Adds individual points for better visualization
  scale_fill_manual(values = c("    Bacteria" = "#1f78b4", "        Fungi" = "#6a3d9a", "  Viruses" = "#33a02c")) +
  theme_minimal() +
  labs(title = "",
       x = "",
       y = "Relative Abundance (%)") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
    axis.title.x = element_text(size = 16, face = "bold"),
    axis.title.y = element_text(size = 16, face = "bold"),
    axis.text.x = element_text(size = 14, face = "bold", angle = 45, hjust = 1),
    axis.text.y = element_text(size = 14, face = "bold"),
    legend.position = "none"
  ) +
  scale_y_break(c(2, 95))  # Breaks y-axis between 5 and 90

relative_abundance_df$Kingdom <- factor(relative_abundance_df$Kingdom, levels = c("    Bacteria", "        Fungi", "  Viruses"))# Save plot
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/relative_abundance_boxplot_with_break.png",
       plot = boxplot_relative_abundance, width = 1.8, height = 5.5)

# Display plot
print(boxplot_relative_abundance)

unique(relative_abundance_df$Kingdom)

```


#CALCULATE SHANNON DIVERSITY, CHAO1 DIVERSITY, AND OBSERVED SPECIES IN PLUSPF DATABASE
#Generate phyloseq object and make plots for diversity 

```{r fig.height= 8}
library(phyloseq)
library(dplyr)
library(tidyr)

metadata_ZnD5 <- read.table("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/ZnD5_metadata.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)
metadata_ZnD5$Treatment <- as.factor(metadata_ZnD5$Treatment)
metadata_ZnD5$Treatment <- relevel(metadata_ZnD5$Treatment, ref = "ZnA")
#metadata_ZnD5$Sample <- gsub("ZnD5\\.", "ZnD5-", metadata_ZnD5$Sample)
metadata_ZnD5

metadata_ZnD5_phy <- metadata_ZnD5
rownames(metadata_ZnD5_phy) <- metadata_ZnD5_phy$Sample
metadata_ZnD5_phy <- metadata_ZnD5_phy[, -which(colnames(metadata_ZnD5_phy) == "Sample")]
head(metadata_ZnD5_phy)
metadata_ZnD5_phy <- sample_data(metadata_ZnD5_phy)

otu_phy_ZnD5 <- combined_bracken_ZnD5
otu_phy_ZnD5 <- as.matrix(otu_phy_ZnD5)
otu_phy_ZnD5 <- otu_table(otu_phy_ZnD5, taxa_are_rows = TRUE)

physeq_ZnD5 <- phyloseq(otu_phy_ZnD5, metadata_ZnD5_phy)
diversity_data_ZnD5 <- estimate_richness(physeq_ZnD5, measures = c("Observed", "Shannon", "Chao1"))
metadata_ZnD5 <- sample_data(physeq_ZnD5)  # Extract sample metadata
diversity_data_ZnD5 <- cbind(metadata_ZnD5, diversity_data_ZnD5)  


metadata_ZnD5

```

#DIVERSITY PLOTS SEPARATED BY LOCATION, BUT NOT BY TREATMENT

```{r}
library(phyloseq)
library(dplyr)
library(ggplot2)
library(ggpubr)

# Compute diversity metrics
diversity_data_ZnD5 <- estimate_richness(physeq_ZnD5, measures = c("Observed", "Shannon", "Chao1"))

# Merge with metadata
metadata_ZnD5_df <- as.data.frame(sample_data(physeq_ZnD5))
diversity_data_ZnD5 <- cbind(metadata_ZnD5_df, diversity_data_ZnD5)

# Reorder Location factor levels
diversity_data_ZnD5$Location <- factor(diversity_data_ZnD5$Location, levels = c("intestine", "cecum", "colon"))


# Define colors for locations
location_colors <- c(
  "colon" = "#D55E00",
  "intestine" = "#56B4E9",
  "cecum" = "#009E73"
)

# Define significant comparisons for each metric
signif_comparisons_observed <- list(
  c("colon", "intestine")
)

signif_comparisons_shannon <- list(
  c("cecum", "intestine"),
  c("colon", "intestine")
  # assuming only this pair is significant for Shannon
)

signif_comparisons_chao1 <- list(
  c("colon", "intestine")
  # assuming only this pair is significant for Chao1
)

# Generalized function to plot diversity by location with selected comparisons
plot_diversity_filtered_comparisons <- function(metric, y_label, title, significant_comparisons) {
  ggplot(diversity_data_ZnD5, aes(x = Location, y = get(metric), fill = Location)) +
    geom_boxplot(alpha = 0.7, outlier.shape = NA, width = 0.8) +
    geom_jitter(width = 0.15, alpha = 0.5, size = 1.5) +
    scale_fill_manual(values = location_colors) +
    stat_compare_means(
      method = "wilcox.test",
      comparisons = significant_comparisons,
      label = "p.signif",
      size = 5
    ) +
    theme_minimal() +
    labs(title = title, x = "", y = y_label) +
    theme(
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
      axis.title.x = element_text(size = 16, face = "bold"),
      axis.title.y = element_text(size = 16, face = "bold"),
      axis.text.x = element_text(size = 14, face = "bold", color = "black", angle = 45, hjust = 1),
      axis.text.y = element_text(size = 14, color = "black"),
      legend.position = "none"
    )
}

# Generate the plots with only significant comparisons
shannon_plot <- plot_diversity_filtered_comparisons(
  metric = "Shannon",
  y_label = "Shannon Diversity Index",
  title = "",
  significant_comparisons = signif_comparisons_shannon
)

observed_plot <- plot_diversity_filtered_comparisons(
  metric = "Observed",
  y_label = "Number of Observed Species",
  title = "",
  significant_comparisons = signif_comparisons_observed
)

chao1_plot <- plot_diversity_filtered_comparisons(
  metric = "Chao1",
  y_label = "Chao1 Richness Estimate",
  title = "",
  significant_comparisons = signif_comparisons_chao1
)

output_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/DiversityPlots/ALL_KINGDOMS/"

# Save plots
ggsave(paste0(output_dir, "shannon_filtered_by_location_notreat.png"), plot = shannon_plot, width = 1.6, height = 5.5, dpi = 300)
ggsave(paste0(output_dir, "chao1_filtered_by_location_notreat.png"), plot = chao1_plot, width = 1.6, height = 5.5, dpi = 300)
ggsave(paste0(output_dir, "observed_filtered_by_location_notreat.png"), plot = observed_plot, width = 1.6, height = 5.5, dpi = 300)

# Print them
print(shannon_plot)
print(observed_plot)
print(chao1_plot)

```


#DIVERSITY PLOTS SEPARATED BY LOCATION
```{r}
library(phyloseq)
library(dplyr)
library(ggplot2)
library(ggpubr)

# Compute Diversity Metrics
diversity_data_ZnD5 <- estimate_richness(physeq_ZnD5, measures = c("Observed", "Shannon", "Chao1"))

# Extract Sample Metadata
metadata_ZnD5_df <- as.data.frame(sample_data(physeq_ZnD5))

# Merge Diversity Data with Metadata
diversity_data_ZnD5 <- cbind(metadata_ZnD5_df, diversity_data_ZnD5)

custom_colors <- c(
  "ZnD" = "#E8B31A",
  "ZnA" = "#75AE33"
)

plot_diversity_metric <- function(metric, y_label, title, subset_location) {
  
  # Subset the data for the specific location
  subset_data <- diversity_data_ZnD5 %>% filter(Location == subset_location)
  stat_result <- subset_data %>%
    wilcox_test(as.formula(paste(metric, "~ Treatment"))) %>%
    add_xy_position(x = "Treatment")
  
  p <- ggplot(subset_data, aes(x = Treatment, y = get(metric), fill = Treatment)) +
    geom_boxplot(alpha = 0.7, outlier.shape = NA, width = 0.6) +
    geom_jitter(width = 0.15, alpha = 0.5, size = 1.5) +  
    scale_fill_manual(values = custom_colors) +
    theme_minimal() +
    labs(title = subset_location, x = "", y = y_label) +
    theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.4),
      axis.title.x = element_text(size = 16, face = "bold"),
      axis.title.y = element_text(size = 16, face = "bold"),
      axis.text.x = element_text(size = 14, face = "bold", color = "black", angle = 45, hjust = 1),
      axis.text.y = element_text(size = 14, color = "black"),
      #legend.title = element_text(size = 18, face = "bold"),
     # legend.text = element_text(size = 16)
     legend.position = "none"
    ) +
    #stat_compare_means(method = "kruskal.test", label = "p.format", label.y = max(subset_data[[metric]], na.rm = TRUE) * 1.1, size = 5, font.label = c("bold", "black"), parse = FALSE) +
    stat_compare_means(method = "wilcox.test", label = "p.signif", size = 5, comparisons = list(c("ZnA", "ZnD")), hide.ns = TRUE)
  
}

# Shannon Diversity
shannon_colon <- plot_diversity_metric("Shannon", "Shannon Diversity Index", "\n", "colon")
shannon_intestine <- plot_diversity_metric("Shannon", "Shannon Diversity Index", "\n", "intestine")
shannon_cecum <- plot_diversity_metric("Shannon", "Shannon Diversity Index", "\n", "cecum")

# Chao1 Index
chao1_colon <- plot_diversity_metric("Chao1", "Chao1 Index", "\n", "colon")
chao1_intestine <- plot_diversity_metric("Chao1", "Chao1 Index", "\n", "intestine")
chao1_cecum <- plot_diversity_metric("Chao1", "Chao1 Index", "\n", "cecum")

# Observed Species
observed_colon <- plot_diversity_metric("Observed", "Number of Observed Species", "\n", "colon")
observed_intestine <- plot_diversity_metric("Observed", "Number of Observed Species", "\n", "intestine")
observed_cecum <- plot_diversity_metric("Observed", "Number of Observed Species", "\n", "cecum")

# Define output directory
output_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/DiversityPlots/"

# Save all plots
ggsave(paste0(output_dir, "shannon_colon.png"), plot = shannon_colon, width = 1.6, height = 5.5, dpi = 300)
ggsave(paste0(output_dir, "shannon_intestine.png"), plot = shannon_intestine, width = 1.6, height = 5.5, dpi = 300)
ggsave(paste0(output_dir, "shannon_cecum.png"), plot = shannon_cecum, width = 1.6, height = 5.5, dpi = 300)

ggsave(paste0(output_dir, "chao1_colon.png"), plot = chao1_colon, width = 1.6, height = 5.5, dpi = 300)
ggsave(paste0(output_dir, "chao1_intestine.png"), plot = chao1_intestine, width = 1.6, height = 5.5, dpi = 300)
ggsave(paste0(output_dir, "chao1_cecum.png"), plot = chao1_cecum, width = 1.6, height = 5.5, dpi = 300)

ggsave(paste0(output_dir, "observed_colon.png"), plot = observed_colon, width = 1.6, height = 5.5, dpi = 300)
ggsave(paste0(output_dir, "observed_intestine.png"), plot = observed_intestine, width = 1.6, height = 5.5, dpi = 300)
ggsave(paste0(output_dir, "observed_cecum.png"), plot = observed_cecum, width = 1.6, height = 5.5, dpi = 300)

print(shannon_colon)
print(shannon_intestine)
print(shannon_cecum)

print(chao1_colon)
print(chao1_intestine)
print(chao1_cecum)

print(observed_colon)
print(observed_intestine)
print(observed_cecum)

```

#DIVERSITY PLOTS NOT SEPARATED BY LOCATION 
```{r}
# Shannon Diversity (not separated by location)
plot_diversity_all <- function(metric, y_label, title) {
  ggplot(diversity_data_ZnD5, aes(x = Treatment, y = get(metric), fill = Treatment)) +
    geom_boxplot(alpha = 0.7, outlier.shape = NA, width = 0.6) +
    geom_jitter(width = 0.15, alpha = 0.5, size = 1.5) +  
    scale_fill_manual(values = custom_colors) +
    theme_minimal() +
    labs(title = "", x = "", y = y_label) +
    theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      axis.title.x = element_text(size = 16, face = "bold"),
      axis.title.y = element_text(size = 16, face = "bold"),
      axis.text.x = element_text(size = 14, face = "bold", color = "black", hjust = 1, angle = 45),
      axis.text.y = element_text(size = 14, color = "black"),
      #legend.title = element_text(size = 18, face = "bold"),
      #legend.text = element_text(size = 16)
      legend.position = "none"
    ) #+
    #stat_compare_means(method = "kruskal.test", label.y = max(diversity_data_ZnD5[[metric]], na.rm = TRUE) * 1.1, size = 5, label = "p.format")
}

# Generate plots
shannon_all <- plot_diversity_all("Shannon", "Shannon Diversity Index", "Shannon Diversity")
chao1_all <- plot_diversity_all("Chao1", "Chao1 Index", "Chao1 Index")
observed_all <- plot_diversity_all("Observed", "Number of Observed Species", "Observed Species")

# Save plots
ggsave(paste0(output_dir, "shannon_all.png"), plot = shannon_all, width = 1.6, height = 5.5, dpi = 300)
ggsave(paste0(output_dir, "chao1_all.png"), plot = chao1_all, width = 1.6, height = 5.5, dpi = 300)
ggsave(paste0(output_dir, "observed_all.png"), plot = observed_all, width = 1.6, height = 5.5, dpi = 300)

# Optionally print them
print(shannon_all)
print(chao1_all)
print(observed_all)

```


#GENERATE KRAKEN REPORT FILES FOR BACTERIA, FUNGI, AND VIRUSES SEPARATED. THEN I WILL USE THE SPECIES INFORMATION FROM THE PARSED KRAKEN FILES TO SUBSET THE BRACKEN DATA. THEN I WILL CLUSTER THEM IN A PCA PLOT AND MAKE GRAPHS AND DO DIFFERENTIAL EXPRESSION ANALYSIS ON THEM SEPARATELY.


```{r}
# Load necessary library
library(fs)  # For file handling

# Define input and output directories
input_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/kraken_outputs/ZnDvsZnA/kraken/"
output_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/kraken_output_kingdom_separated/"

# Create output directory if it doesn't exist
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}

# Function to extract full sections for bacteria, fungi, and viruses
extract_section <- function(data, keyword) {
  start_index <- grep(keyword, data)
  if (length(start_index) == 0) return(character(0))  # Return empty if keyword not found
  
  extracted_lines <- c()
  collecting <- FALSE
  
  for (line in data) {
    if (grepl(keyword, line)) collecting <- TRUE  # Start collecting when we find the keyword
    if (collecting) extracted_lines <- c(extracted_lines, line)
    
    # Stop collecting when a new domain appears (but not in the same category)
    if (collecting && grepl("D\\t", line) && !grepl(keyword, line)) break
  }
  
  return(extracted_lines)
}

# Get all Kraken report files (only those that match the expected report pattern)
kraken_files <- list.files(input_dir, pattern = ".*_report.txt$", full.names = TRUE)

# Loop through each file and process it
for (file in kraken_files) {
  # Read the Kraken report file
  kraken_data <- readLines(file)
  
  # Extract full sections for each domain
  bacteria_lines <- extract_section(kraken_data, "D\\t2\\t")  # Bacteria
  fungi_lines <- extract_section(kraken_data, "K\\t4751\\t")  # Fungi
  virus_lines <- extract_section(kraken_data, "D\\t10239\\t")  # Viruses

  # Generate output file names
  file_name <- basename(file)
  output_bacteria <- file.path(output_dir, paste0(tools::file_path_sans_ext(file_name), "_bacteria.txt"))
  output_fungi <- file.path(output_dir, paste0(tools::file_path_sans_ext(file_name), "_fungi.txt"))
  output_virus <- file.path(output_dir, paste0(tools::file_path_sans_ext(file_name), "_virus.txt"))

  # Write results to files only if data exists
  if (length(bacteria_lines) > 0) writeLines(bacteria_lines, output_bacteria)
  if (length(fungi_lines) > 0) writeLines(fungi_lines, output_fungi)
  if (length(virus_lines) > 0) writeLines(virus_lines, output_virus)

  # Print confirmation message
  cat("Processed:", file_name, "\n")
}

cat("All Kraken reports have been processed. Separated files are saved in:\n", output_dir, "\n")
hi
```


```{r}
# Load necessary libraries
library(dplyr)
library(readr)
library(tools)

# Define directories
bracken_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/braken_outputs/ZnDvsZnA/Species_Level/"
kraken_sep_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/kraken_output_kingdom_separated"
output_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/bracken_output_separated"

# Create output directory if it doesn't exist
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}

# Function to extract taxonomic IDs from a Kraken-separated report
extract_tax_ids <- function(kraken_file) {
  if (!file.exists(kraken_file)) return(character(0))  # Return empty if file does not exist
  kraken_data <- read_tsv(kraken_file, col_names = FALSE, show_col_types = FALSE)
  return(unique(kraken_data$X5))  # Extract taxonomic ID column (assumed in column 5)
}

# Function to subset Bracken output by kingdom
subset_bracken <- function(bracken_data, tax_ids, output_name) {
  filtered_data <- bracken_data %>% filter(taxonomy_id %in% tax_ids)
  write_tsv(filtered_data, output_name)
}

# Get all Bracken files
bracken_files <- list.files(bracken_dir, pattern = "_bracken_output.txt$", full.names = TRUE)

# Process each Bracken file
for (bracken_file in bracken_files) {
  # Extract the base name by removing "_bracken_output" from the filename
  base_name <- gsub("_bracken_output", "", tools::file_path_sans_ext(basename(bracken_file)))
  # Extract base name without extension

  # Define corresponding Kraken-separated files
  kraken_bacteria_file <- file.path(kraken_sep_dir, paste0(base_name, "_kraken_report_bacteria.txt"))
  kraken_fungi_file <- file.path(kraken_sep_dir, paste0(base_name, "_kraken_report_fungi.txt"))
  kraken_virus_file <- file.path(kraken_sep_dir, paste0(base_name, "_kraken_report_virus.txt"))


  # Extract taxonomic IDs for each kingdom
  bacteria_ids <- extract_tax_ids(kraken_bacteria_file)
  fungi_ids <- extract_tax_ids(kraken_fungi_file)
  virus_ids <- extract_tax_ids(kraken_virus_file)

  # Read Bracken output file
  bracken_data <- read_tsv(bracken_file, show_col_types = FALSE)

  # Generate output file paths
  bacteria_output <- file.path(output_dir, paste0(base_name, "_bacteria.tsv"))
  fungi_output <- file.path(output_dir, paste0(base_name, "_fungi.tsv"))
  virus_output <- file.path(output_dir, paste0(base_name, "_virus.tsv"))

  # Filter and save Bracken output for each kingdom
  if (length(bacteria_ids) > 0) subset_bracken(bracken_data, bacteria_ids, bacteria_output)
  if (length(fungi_ids) > 0) subset_bracken(bracken_data, fungi_ids, fungi_output)
  if (length(virus_ids) > 0) subset_bracken(bracken_data, virus_ids, virus_output)

  # Print status message
  cat("Processed:", bracken_file, "\n")
}

cat("All Bracken outputs separated by kingdom saved in:", output_dir, "\n")
```

```{r}
# Load necessary libraries
library(data.table)
library(dplyr)

# Define directories
bracken_sep_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/bracken_output_separated/"
output_file_bacteria <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/combined_bacteria.csv"
output_file_fungi <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/combined_fungi.csv"
output_file_virus <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/combined_virus.csv"

# Function to process and merge Bracken files by kingdom
combine_bracken_files <- function(pattern) {
  # List all files matching the pattern (e.g., "_bacteria.tsv")
  file_list <- list.files(path = bracken_sep_dir, pattern = pattern, full.names = TRUE)

  # Read each file and extract relevant columns
  bracken_data <- lapply(file_list, function(file) {
    sample_name <- gsub(pattern, "", basename(file))  # Extract sample name
    data <- read.table(file, header = TRUE, sep = "\t") %>%
      select(name, new_est_reads) %>%
      rename_with(~ sample_name, .cols = new_est_reads)  # Rename column with sample name
    return(data)
  })

  # Merge all data by the "Taxon" column (name)
  combined_data <- Reduce(function(x, y) merge(x, y, by = "name", all = TRUE), bracken_data)

  # Replace NA with 0 (if there are missing taxa in some samples)
  combined_data[is.na(combined_data)] <- 0

  # Set row names as taxa names and remove the "name" column
  rownames(combined_data) <- combined_data$name
  combined_data <- combined_data[, -1]

  return(combined_data)
}

# Process and merge files for each kingdom
combined_bacteria <- combine_bracken_files("_bacteria.tsv")
combined_fungi <- combine_bracken_files("_fungi.tsv")
combined_virus <- combine_bracken_files("_virus.tsv")

# Save as CSV
write.csv(combined_bacteria, output_file_bacteria, row.names = TRUE)
write.csv(combined_fungi, output_file_fungi, row.names = TRUE)
write.csv(combined_virus, output_file_virus, row.names = TRUE)

# Read files back to clean column names
combined_bacteria <- read.csv(output_file_bacteria, row.names = 1)
combined_fungi <- read.csv(output_file_fungi, row.names = 1)
combined_virus <- read.csv(output_file_virus, row.names = 1)

# Remove extra "X" added to column names
colnames(combined_bacteria) <- gsub("^X", "", colnames(combined_bacteria))
colnames(combined_fungi) <- gsub("^X", "", colnames(combined_fungi))
colnames(combined_virus) <- gsub("^X", "", colnames(combined_virus))

# Print confirmation
cat("Combined Bracken data saved:\n",
    output_file_bacteria, "\n",
    output_file_fungi, "\n",
    output_file_virus, "\n")

# Return dataframes
list(
  bacteria = combined_bacteria,
  fungi = combined_fungi,
  virus = combined_virus
)

```

#PERFORM THE SAME STRATIFICATION FOR BRACKEN FILES AT THE PHYLUM, GENUS, AND FAMILY LEVELS

```{r}
# Load necessary libraries
library(dplyr)
library(readr)
library(tools)

combined_bracken_ZnD5
combined_bracken_ZnD5_F
combined_bracken_ZnD5_G
combined_bracken_ZnD5_K
combined_bracken_ZnD5_P

# Define directories
bracken_dir_G <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/braken_outputs/ZnDvsZnA/Genus_Level/"
bracken_dir_P <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/braken_outputs/ZnDvsZnA/Phylum_Level/"
bracken_dir_F <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/braken_outputs/ZnDvsZnA/Family_Level/"
#kraken_sep_dir_K <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/braken_outputs/ZnDvsZnA/Kingdom_Level/"

output_dir_G <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/bracken_output_separated/bracken_output_separated_G/"
output_dir_P <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/bracken_output_separated/bracken_output_separated_P/"
output_dir_F <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/bracken_output_separated/bracken_output_separated_F/"


# Ensure output directories exist

# Function to extract taxonomic IDs at a given level from Kraken report
extract_tax_ids <- function(kraken_file, tax_level) {
  if (!file.exists(kraken_file)) {
    cat("⚠️ File does not exist:", kraken_file, "\n")
    return(character(0))
  }
  
  kraken_data <- read_tsv(kraken_file, col_names = FALSE, show_col_types = FALSE)
  
  # Mapping taxonomic levels to Kraken codes
  level_map <- list(
    "Phylum" = c("P", "P1"),
    "Family" = c("F", "F1", "F2", "F3"),
    "Genus" = c("G", "G1", "G2", "G3")
  )
  
  if (!tax_level %in% names(level_map)) {
    cat("⚠️ Invalid taxonomic level:", tax_level, "\n")
    return(character(0))
  }
  
  cat("🔹 Unique taxonomy levels in file:", unique(kraken_data$X4), "\n")
  
  if (!any(level_map[[tax_level]] %in% kraken_data$X4)) {
    cat("⚠️ No matches found for taxonomic level:", tax_level, "\n")
    return(character(0))
  }
  
  # Filter data to include all variations of the specified taxonomic level
  filtered_data <- kraken_data %>% filter(X4 %in% level_map[[tax_level]])
  extracted_ids <- unique(filtered_data$X5)
  
  cat("✅ Extracted", length(extracted_ids), "taxa at level:", tax_level, "\n")
  return(extracted_ids)
}

# Function to process Bracken files for a given taxonomic level
# Function to process Bracken files for a given taxonomic level
process_bracken_level <- function(bracken_dir, output_dir, tax_level) {
  # Get all Bracken files
  bracken_files <- list.files(bracken_dir, pattern = "_bracken_output.txt$", full.names = TRUE)

  for (bracken_file in bracken_files) {
    # Extract sample name correctly
    base_name <- gsub("_bracken_output.txt", "", basename(bracken_file))  # Remove _bracken_output.txt
    base_name <- gsub(".txt$", "", base_name)  # Remove extra .txt if present

    # Correct file name reference for Kraken outputs
    kraken_bacteria_file <- file.path(kraken_sep_dir, paste0(base_name, "_kraken_report_bacteria.txt"))
    kraken_fungi_file <- file.path(kraken_sep_dir, paste0(base_name, "_kraken_report_fungi.txt"))
    kraken_virus_file <- file.path(kraken_sep_dir, paste0(base_name, "_kraken_report_virus.txt"))
    
    # Debugging Output - Check File Paths
    cat("🔍 Processing Bracken file:", bracken_file, "\n")
    cat("📂 Expected Kraken bacteria file:", kraken_bacteria_file, "\n")
    cat("📂 Expected Kraken fungi file:", kraken_fungi_file, "\n")
    cat("📂 Expected Kraken virus file:", kraken_virus_file, "\n")

    # Extract taxonomic IDs for each level
    bacteria_ids <- extract_tax_ids(kraken_bacteria_file, tax_level)
    fungi_ids <- extract_tax_ids(kraken_fungi_file, tax_level)
    virus_ids <- extract_tax_ids(kraken_virus_file, tax_level)
    
    # Read Bracken output
    bracken_data <- read_tsv(bracken_file, show_col_types = FALSE)

    # Generate output file paths
    bacteria_output <- file.path(output_dir, paste0(base_name, "_bacteria.tsv"))
    fungi_output <- file.path(output_dir, paste0(base_name, "_fungi.tsv"))
    virus_output <- file.path(output_dir, paste0(base_name, "_virus.tsv"))

    # Filter and save Bracken output for each kingdom
    if (length(bacteria_ids) > 0) write_tsv(bracken_data %>% filter(taxonomy_id %in% bacteria_ids), bacteria_output)
    if (length(fungi_ids) > 0) write_tsv(bracken_data %>% filter(taxonomy_id %in% fungi_ids), fungi_output)
    if (length(virus_ids) > 0) write_tsv(bracken_data %>% filter(taxonomy_id %in% virus_ids), virus_output)

    # Print status message
    cat("✅ Processed:", bracken_file, "\n\n")
  }
}


# Run processing for Genus, Family, and Phylum
process_bracken_level(bracken_dir_G, output_dir_G, "Genus")
process_bracken_level(bracken_dir_F, output_dir_F, "Family")
process_bracken_level(bracken_dir_P, output_dir_P, "Phylum")

cat("✅ Bracken outputs separated for Genus, Family, and Phylum saved in respective directories.\n")



```

#COMBINE BRACKEN FILES FOR THE PHYLUM, KINGDOM, FAMILY LEVELS FOR BACTERIA, FUNGI, AND VIRUSES


```{r}
# Load necessary libraries
library(data.table)
library(dplyr)

# Define directories for each taxonomic level
bracken_dirs <- list(
  "Genus" = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/bracken_output_separated/bracken_output_separated_G/",
  "Family" = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/bracken_output_separated/bracken_output_separated_F/",
  "Phylum" = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/bracken_output_separated/bracken_output_separated_P/"
)

# Define output file paths for each taxonomic level and kingdom
output_files <- list(
  "Genus" = list(
    "Bacteria" = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/Bracken_Data_Sep_Kingdom/combined_bacteria_G.csv",
    "Fungi" = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/Bracken_Data_Sep_Kingdom/combined_fungi_G.csv",
    "Virus" = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/Bracken_Data_Sep_Kingdom/combined_virus_G.csv"
  ),
  "Family" = list(
    "Bacteria" = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/Bracken_Data_Sep_Kingdom/combined_bacteria_F.csv",
    "Fungi" = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/Bracken_Data_Sep_Kingdom/combined_fungi_F.csv",
    "Virus" = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/Bracken_Data_Sep_Kingdom/combined_virus_F.csv"
  ),
  "Phylum" = list(
    "Bacteria" = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/Bracken_Data_Sep_Kingdom/combined_bacteria_P.csv",
    "Fungi" = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/Bracken_Data_Sep_Kingdom/combined_fungi_P.csv",
    "Virus" = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/Bracken_Data_Sep_Kingdom/combined_virus_P.csv"
  )
)


# Load necessary libraries
library(data.table)
library(dplyr)

# Load necessary libraries
library(data.table)
library(dplyr)

# Function to process and merge Bracken files for a given taxonomic level and kingdom
combine_bracken_files <- function(bracken_dir, pattern) {
  # Get all files matching the pattern (e.g., "_fungi.tsv")
  file_list <- list.files(path = bracken_dir, pattern = pattern, full.names = TRUE)

  # If no files found, return an empty dataframe
  if (length(file_list) == 0) {
    cat("⚠️ No files found for pattern:", pattern, "in", bracken_dir, "\n")
    return(data.frame())
  }

  # Store all sample names, including those with empty files
  all_sample_names <- gsub(pattern, "", basename(file_list))

  # Read and process each file
  bracken_data <- lapply(file_list, function(file) {
    sample_name <- gsub(pattern, "", basename(file))  # Extract sample name
    data <- fread(file, header = TRUE, sep = "\t")

    # If file only has headers or is empty, create a placeholder
    if (nrow(data) == 0 || ncol(data) == 0) {
      cat("⚠️ Empty file detected, adding placeholder for:", sample_name, "\n")
      return(data.frame(name = "Placeholder_Taxa", sample = 0, stringsAsFactors = FALSE))
    }

    # Ensure the "name" column exists
    if (!"name" %in% colnames(data)) {
      cat("⚠️ Skipping file (missing 'name' column):", file, "\n")
      return(NULL)
    }

    # Extract relevant columns
    data <- data %>%
      select(name, new_est_reads) %>%
      rename(!!sample_name := new_est_reads)  # Rename column with sample name

    return(data)
  })

  # Remove NULL elements (failed files)
  bracken_data <- Filter(Negate(is.null), bracken_data)

  # If all files failed or were empty, return an empty dataframe
  if (length(bracken_data) == 0) {
    return(data.frame())
  }

  # Merge all data by "name" column (taxa)
  combined_data <- Reduce(function(x, y) merge(x, y, by = "name", all = TRUE), bracken_data)

  # Replace NA with 0 (handle missing taxa)
  combined_data[is.na(combined_data)] <- 0

  # Ensure all sample columns exist, adding missing ones
  for (sample in all_sample_names) {
    if (!sample %in% colnames(combined_data)) {
      combined_data[[sample]] <- 0
    }
  }

  # Set row names as taxon names
  rownames(combined_data) <- combined_data$name

  return(combined_data)
}


# Process and save merged Bracken files for each taxonomic level
for (tax_level in names(bracken_dirs)) {
  for (kingdom in c("Bacteria", "Fungi", "Virus")) {
    # Define correct directory and output file
    bracken_dir <- bracken_dirs[[tax_level]]
    output_file <- output_files[[tax_level]][[kingdom]]

    # Determine file pattern for each kingdom
    pattern <- paste0("_", tolower(kingdom), ".tsv")

    # Combine Bracken files
    combined_data <- combine_bracken_files(bracken_dir, pattern)

    # Save to CSV if data exists
    if (nrow(combined_data) > 0) {
      fwrite(combined_data, output_file, row.names = FALSE)
      cat("✅ Saved:", output_file, "\n")
    } else {
      cat("⚠️ No data to save for:", kingdom, "at level:", tax_level, "\n")
    }
  }
}

# Print final confirmation
cat("✅ All taxonomic level Bracken files combined and saved!\n")



```

#GENERATE DIVERSITY PLOTS FROM THE STRATIFIED OUTPUT FOR BACTERIA, FUNGI, AND VIRUSES

```{r}

combined_bacteria_gut <- read.csv("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_bacteria_S.csv", check.names = FALSE, row.names = 1)
combined_fungi_gut <- read.csv("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_fungi_S.csv", check.names = FALSE, row.names = 1)
combined_virus_gut <- read.csv("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_virus_S.csv", check.names = FALSE, row.names = 1)

metadata_ZnD5 <- read.table("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/ZnD5_metadata.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)
metadata_ZnD5$Treatment <- as.factor(metadata_ZnD5$Treatment)
metadata_ZnD5$Treatment <- relevel(metadata_ZnD5$Treatment, ref = "ZnA")
metadata_ZnD5
metadata_ZnD5$Sample <- sub("ZnD5\\.", "ZnD5-", metadata_ZnD5$Sample)

combined_virus_gut
metadata_ZnD5

# Load required libraries
library(ggplot2)
library(vegan)
library(dplyr)
library(janitor)
library(ggrepel)
library(phyloseq)
library(tidyr)
library(ggpubr)

# Define directories
data_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/"
figures_dir <- file.path(data_dir, "figures")
pcoa_fig_dir <- file.path(figures_dir, "PCA")
diversity_fig_dir <- file.path(figures_dir, "DiversityPlots")

# Load metadata
metadata <- metadata_ZnD5

compute_diversity <- function(data, kingdom) {
  # **Check and Fix Sample Names**
  sample_names_data <- colnames(data)  # Extract sample names from Bracken data
  sample_names_metadata <- metadata$Sample  # Extract sample names from metadata

  # Find mismatches
  mismatched_samples <- setdiff(sample_names_data, sample_names_metadata)
  if (length(mismatched_samples) > 0) {
    stop("Error: Mismatched sample names found. Check and rename metadata sample names.")
  }

  # Convert data into a numeric matrix
  data_matrix <- as.matrix(data)  # Keep taxa as rows, samples as columns
  mode(data_matrix) <- "numeric"  # Ensure numeric conversion

  # Ensure metadata row names match Bracken sample names
  rownames(metadata) <- metadata$Sample
  metadata_phy <- sample_data(metadata)  # Convert metadata to phyloseq object

  # Convert OTU table into a `phyloseq` format
  otu_table_phy <- otu_table(data_matrix, taxa_are_rows = TRUE)
  physeq <- phyloseq(otu_table_phy, metadata_phy)

  # Check if sample names match
  if (!all(sample_names(metadata_phy) %in% sample_names(otu_table_phy))) {
    stop("Error: Sample names in metadata do not match sample names in OTU table.")
  }

  # Compute diversity metrics
  diversity_data <- estimate_richness(physeq, measures = c("Observed", "Shannon", "Chao1"))
  diversity_data <- cbind(metadata, diversity_data)
  

  # **Define function to plot diversity metrics**
  plot_diversity_metric <- function(metric, y_label, title) {
    ggplot(diversity_data, aes(x = Treatment, y = get(metric), fill = Treatment)) +
      geom_boxplot(alpha = 0.7, outlier.shape = NA, width = 0.6) +
      scale_fill_manual(values = custom_colors) +
      geom_jitter(width = 0.15, alpha = 0.5, size = 1.5) +
      theme_minimal() +
      labs(title = title, x = "", y = y_label) +
      theme(
        plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      axis.title.x = element_text(size = 16, face = "bold"),
      axis.title.y = element_text(size = 16, face = "bold"),
      axis.text.x = element_text(size = 14, face = "bold", color = "black", hjust = 1, angle = 45),
      axis.text.y = element_text(size = 14, color = "black"),
      #legend.title = element_text(size = 18, face = "bold"),
      #legend.text = element_text(size = 16),
      legend.position = "none"
      ) #+
      #stat_compare_means(method = "wilcox.test", label = "p.signif", size = 5, comparisons = list(c("ZnA", "ZnD")), hide.ns = TRUE) #+
      #stat_compare_means(method = "kruskal.test", label.y = max(diversity_data[[metric]], na.rm = TRUE) * 1.1, size = 5, label = "p.format")  # Kruskal-Wallis test
  }

  # Generate plots
  shannon_plot <- plot_diversity_metric("Shannon", "Shannon Diversity Index", paste("\n", kingdom))
  chao1_plot <- plot_diversity_metric("Chao1", "Chao1 Index", paste("\n", kingdom))
  observed_plot <- plot_diversity_metric("Observed", "Number of Observed Species", paste("\n", kingdom))

  # Save plots
  ggsave(file.path(diversity_fig_dir, paste0("shannon_", kingdom, ".png")), plot = shannon_plot, width = 1.6, height = 5.5, dpi = 300)
  ggsave(file.path(diversity_fig_dir, paste0("chao1_", kingdom, ".png")), plot = chao1_plot, width = 1.6, height = 5.5, dpi = 300)
  ggsave(file.path(diversity_fig_dir, paste0("observed_", kingdom, ".png")), plot = observed_plot, width = 1.6, height = 5.5, dpi = 300)

  return(list(shannon_plot, chao1_plot, observed_plot))
}

# Compute and plot diversity for each dataset
diversity_bacteria <- compute_diversity(combined_bacteria_gut, "Bacteria")
diversity_fungi <- compute_diversity(combined_fungi_gut, "Fungi")
diversity_virus <- compute_diversity(combined_virus_gut, "Virus")

combined_bacteria_gut
combined_fungi_gut
combined_virus_gut
metadata_ZnD5

# Print plots
print(diversity_bacteria)
print(diversity_fungi)
print(diversity_virus)

```

```{r}
# Load required libraries
library(ggplot2)
library(vegan)
library(dplyr)
library(janitor)
library(ggrepel)
library(phyloseq)
library(tidyr)
library(ggpubr)

# Define directories
data_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/"
figures_dir <- file.path(data_dir, "figures")
diversity_fig_dir <- file.path(figures_dir, "DiversityPlots")

# Load metadata
metadata <- metadata_ZnD5

# Define a function to compute diversity and generate plots per kingdom and location
compute_diversity_by_location <- function(data, kingdom) {
  # Convert data into a numeric matrix
  data_matrix <- as.matrix(data)  # Keep taxa as rows, samples as columns
  mode(data_matrix) <- "numeric"  # Ensure numeric conversion

  # Ensure metadata row names match Bracken sample names
  rownames(metadata) <- metadata$Sample
  metadata_phy <- sample_data(metadata)  # Convert metadata to phyloseq object

  # Convert OTU table into a `phyloseq` format
  otu_table_phy <- otu_table(data_matrix, taxa_are_rows = TRUE)
  physeq <- phyloseq(otu_table_phy, metadata_phy)

  # Compute diversity metrics
  diversity_data <- estimate_richness(physeq, measures = c("Observed", "Shannon", "Chao1"))
  diversity_data <- cbind(metadata, diversity_data)

  # Locations to analyze
  locations <- c("colon", "intestine", "cecum")

  # Define function to generate diversity plots for each location
  plot_diversity_metric <- function(metric, y_label, title, location_data, location) {
    ggplot(location_data, aes(x = Treatment, y = get(metric), fill = Treatment)) +
      geom_boxplot(alpha = 0.7, outlier.shape = NA, width = 0.6) +
      scale_fill_manual(values = custom_colors) +
      geom_jitter(width = 0.15, alpha = 0.5, size = 1.5) +
      theme_minimal() +
      labs(title = paste(title, "\n", location), x = "", y = y_label) +
      theme(
        plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      axis.title.x = element_text(size = 16, face = "bold"),
      axis.title.y = element_text(size = 16, face = "bold"),
      axis.text.x = element_text(size = 14, face = "bold", color = "black", hjust = 1, angle = 45),
      axis.text.y = element_text(size = 14, color = "black"),
      #legend.title = element_text(size = 18, face = "bold"),
      #legend.text = element_text(size = 16),
      legend.position = "none"
      ) #+
      #stat_compare_means(method = "wilcox.test", label = "p.signif", size = 5, comparisons = list(c("ZnA", "ZnD")), hide.ns = TRUE) #+
      #stat_compare_means(method = "kruskal.test", label.y = max(location_data[[metric]]*1.1, na.rm = TRUE), size = 5, label = "p.format")  # Kruskal-Wallis test
  }

  # Loop through locations to generate separate plots
  for (loc in locations) {
    location_data <- diversity_data %>% filter(Location == loc)

    # Generate plots
    shannon_plot <- plot_diversity_metric("Shannon", "Shannon Diversity Index", paste(kingdom), location_data, loc)
    chao1_plot <- plot_diversity_metric("Chao1", "Chao1 Index", paste(kingdom), location_data, loc)
    observed_plot <- plot_diversity_metric("Observed", "Number of Observed Species", paste(kingdom), location_data, loc)

    # Save plots
    ggsave(file.path(diversity_fig_dir, paste0("shannon_", kingdom, "_", loc, ".png")), plot = shannon_plot, width = 1.6, height = 5.5, dpi = 300)
    ggsave(file.path(diversity_fig_dir, paste0("chao1_", kingdom, "_", loc, ".png")), plot = chao1_plot, width = 1.6, height = 5.5, dpi = 300)
    ggsave(file.path(diversity_fig_dir, paste0("observed_", kingdom, "_", loc, ".png")), plot = observed_plot, width = 1.6, height = 5.5, dpi = 300)

    # Print plots for verification
    print(shannon_plot)
    print(chao1_plot)
    print(observed_plot)
  }
}

# Compute and plot diversity for each dataset across colon, intestine, and cecum
compute_diversity_by_location(combined_bacteria_gut, "Bacteria")
compute_diversity_by_location(combined_fungi_gut, "Fungi")
compute_diversity_by_location(combined_virus_gut, "Virus")

```

#DIVERSITY PLOT FOR BACTERIA, FUNGI, AND VIRUSES SEPARATED BY LOCATION ONLY AND NOT BY TREATMENT


```{r}
# Load required libraries
library(ggplot2)
library(vegan)
library(dplyr)
library(janitor)
library(ggrepel)
library(phyloseq)
library(tidyr)
library(ggpubr)

# Define directories
data_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/"
figures_dir <- file.path(data_dir, "figures")
diversity_fig_dir <- file.path(figures_dir)

# Load metadata
metadata <- metadata_ZnD5

# Define color palette for Location
location_colors <- c(
  "colon" = "#D55E00",
  "intestine" = "#56B4E9",
  "cecum" = "#009E73"
)

# Define significant pairwise comparisons
signif_comparisons_observed_B <- list(c("colon", "intestine"))
signif_comparisons_shannon_B <- list(c("cecum", "intestine"), c("colon", "intestine"))
signif_comparisons_chao1_B <- list(c("colon", "intestine"))

signif_comparisons_observed_F <- list(c("cecum", "intestine"), c("colon", "intestine"))
signif_comparisons_shannon_F <- list(c("cecum", "intestine"), c("colon", "intestine"))
signif_comparisons_chao1_F <- list(c("cecum", "intestine"), c("colon", "intestine"))

signif_comparisons_observed_V <- list(c("cecum", "intestine"), c("colon", "intestine"))
signif_comparisons_shannon_V <- list()
signif_comparisons_chao1_V <- list(c("cecum", "intestine"), c("colon", "intestine"))

# Define function to compute diversity and generate location-wise plots
compute_diversity_by_location <- function(data, kingdom,
                                          signif_comparisons_observed,
                                          signif_comparisons_shannon,
                                          signif_comparisons_chao1) {
  # Convert to numeric matrix
  data_matrix <- as.matrix(data)
  mode(data_matrix) <- "numeric"

  # Ensure sample names match
  rownames(metadata) <- metadata$Sample
  metadata_phy <- sample_data(metadata)

  # Create phyloseq object
  otu_table_phy <- otu_table(data_matrix, taxa_are_rows = TRUE)
  physeq <- phyloseq(otu_table_phy, metadata_phy)

  # Compute diversity metrics
  diversity_data <- estimate_richness(physeq, measures = c("Observed", "Shannon", "Chao1"))
  diversity_data <- cbind(as.data.frame(sample_data(physeq)), diversity_data)

  # Reorder location levels
  diversity_data$Location <- factor(diversity_data$Location, levels = c("intestine", "cecum", "colon"))

  # Internal function for plotting
  plot_diversity_metric <- function(metric, y_label, title_prefix, significant_comparisons) {
    ggplot(diversity_data, aes(x = Location, y = get(metric), fill = Location)) +
      geom_boxplot(alpha = 0.7, outlier.shape = NA, width = 0.8) +
      geom_jitter(width = 0.15, alpha = 0.5, size = 1.5) +
      scale_fill_manual(values = location_colors) +
      stat_compare_means(
        method = "wilcox.test",
        comparisons = significant_comparisons,
        label = "p.signif",
        size = 5
      ) +
      theme_minimal() +
      labs(
        title = paste0(""),
        x = "",
        y = y_label
      ) +
      theme(
        plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold", color = "black", angle = 45, hjust = 1),
        axis.text.y = element_text(size = 14, color = "black"),
        legend.position = "none"
      ) + 
      coord_cartesian(clip = "off", expand = FALSE)
  }

  # Generate plots
  observed_plot <- plot_diversity_metric("Observed", "Number of Observed Species", "", signif_comparisons_observed)
  shannon_plot <- plot_diversity_metric("Shannon", "Shannon Diversity Index", "", signif_comparisons_shannon)
  chao1_plot <- plot_diversity_metric("Chao1", "Chao1 Index", "", signif_comparisons_chao1)

  # Save plots
  ggsave(file.path(diversity_fig_dir, paste0("observed_", kingdom, "_by_location.png")), plot = observed_plot, width = 1.6, height = 5.5, dpi = 300, units = "in")
  ggsave(file.path(diversity_fig_dir, paste0("shannon_", kingdom, "_by_location.png")), plot = shannon_plot, width = 1.6, height = 5.5, dpi = 300, units = "in")
  ggsave(file.path(diversity_fig_dir, paste0("chao1_", kingdom, "_by_location.png")), plot = chao1_plot, width = 1.6, height = 5.5, dpi = 300, units = "in")

  # Print plots
  print(observed_plot)
  print(shannon_plot)
  print(chao1_plot)
}

# Run for each domain
compute_diversity_by_location(combined_bacteria_gut, "Bacteria",
                              signif_comparisons_observed_B,
                              signif_comparisons_shannon_B,
                              signif_comparisons_chao1_B)

compute_diversity_by_location(combined_fungi_gut, "Fungi",
                              signif_comparisons_observed_F,
                              signif_comparisons_shannon_F,
                              signif_comparisons_chao1_F)

compute_diversity_by_location(combined_virus_gut, "Virus",
                              signif_comparisons_observed_V,
                              signif_comparisons_shannon_V,
                              signif_comparisons_chao1_V)

```

#CREATE BRAY-CURTIS PCOA PLOTS OF THE BACTERIA, VIRAL, AND FUNGAL SUBSET READS FROM THE PLUSPF DATABASE

#BACTERIA SEPARATED BY LOCATION
```{r}

# Load required libraries
library(ggplot2)
library(vegan)  # For Bray-Curtis distance
library(dplyr)  # Data manipulation
library(janitor) # Cleaning column names
library(ggrepel) # For sample labels

# 🔹 Merge Bracken data with metadata
pcoa_input_ZnD5_bacteria <- merge(t(combined_bacteria_gut), metadata_ZnD5, by.x = "row.names", by.y = "Sample")
colnames(pcoa_input_ZnD5_bacteria)[1] <- "Sample"  # Ensure first column is Sample
pcoa_input_ZnD5_bacteria
# 🔹 Select only numerical abundance data
pcoa_numeric_ZnD5 <- pcoa_input_ZnD5_bacteria[, !(colnames(pcoa_input_ZnD5_bacteria) %in% c("Sample", "Treatment", "Location"))]

# Convert the matrix to character (in case some columns are factors)
pcoa_numeric_ZnD5 <- apply(pcoa_numeric_ZnD5, 2, as.character)

# Trim leading/trailing spaces and convert to numeric
pcoa_numeric_ZnD5 <- apply(pcoa_numeric_ZnD5, 2, function(x) as.numeric(trimws(x)))

# Ensure it is a numeric matrix
pcoa_numeric_ZnD5 <- as.matrix(pcoa_numeric_ZnD5)
pcoa_numeric_ZnD5
# Check that the conversion worked
str(pcoa_numeric_ZnD5)  # Should display 'num' type

# Replace NA values with 0 to avoid division errors
pcoa_numeric_ZnD5[is.na(pcoa_numeric_ZnD5)] <- 0

# Compute row sums
row_sums <- rowSums(pcoa_numeric_ZnD5)

# Check if there are any zero row sums
print(sum(row_sums == 0))  # If this prints >0, you have zero-sum rows!


# 🔹 Normalize by total reads per sample (relative abundance)
pcoa_numeric_ZnD5 <- pcoa_numeric_ZnD5 / rowSums(pcoa_numeric_ZnD5)
pcoa_numeric_ZnD5
# 🔹 Compute Bray-Curtis distance matrix
bray_curtis_dist <- vegdist(pcoa_numeric_ZnD5, method = "bray")

# 🔹 Perform PCoA (Principal Coordinates Analysis)
pcoa_result_ZnD5 <- cmdscale(bray_curtis_dist, k = 2, eig = TRUE)  # Compute eigenvalues

# 🔹 Convert PCoA results into a data frame
pcoa_scores_ZnD5 <- as.data.frame(pcoa_result_ZnD5$points)
colnames(pcoa_scores_ZnD5) <- c("PC1", "PC2")
pcoa_scores_ZnD5$Sample <- pcoa_input_ZnD5_bacteria$Sample

# 🔹 Merge PCoA scores with metadata
pcoa_scores_ZnD5 <- merge(pcoa_scores_ZnD5, metadata_ZnD5, by = "Sample")

# 🔹 Calculate variance explained
pc1_variance_ZnD5 <- round(100 * (pcoa_result_ZnD5$eig[1] / sum(pcoa_result_ZnD5$eig)), 1)
pc2_variance_ZnD5 <- round(100 * (pcoa_result_ZnD5$eig[2] / sum(pcoa_result_ZnD5$eig)), 1)

# 🔹 Print variance explained
cat("PC1 Variance:", pc1_variance_ZnD5, "%\n")
cat("PC2 Variance:", pc2_variance_ZnD5, "%\n")

desired_order <- c(
  "ZnA intestine",
  "ZnD intestine",
  "ZnA cecum",
  "ZnD cecum",
  "ZnA colon",
  "ZnD colon"
)

pcoa_scores_ZnD5$Group <- paste(pcoa_scores_ZnD5$Treatment, pcoa_scores_ZnD5$Location, sep = " ")

pcoa_scores_ZnD5$Group <- factor(pcoa_scores_ZnD5$Group, levels = desired_order)

# 🔹 Create a new Grouping variable: "ZnD/ZnA" + "Location"


# 🔹 Define colors for the 6 groups
group_colors <- c(
  "ZnA intestine" = "#3E89BF",
  "ZnD intestine" = "#56B4E9",
  "ZnA cecum" = "#D55E00",
  "ZnD cecum" = "#009E73",
  "ZnA colon" = "#F0E442",
  "ZnD colon" = "#E8B31A"
)

# 🔹 PCoA Plot: ZnD/ZnA Groups
pcoa_plot_ZnD5_bacteria <- ggplot(pcoa_scores_ZnD5, aes(x = PC1, y = PC2, color = Group, fill = Group)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.2) +  # Add filled ellipses
  scale_color_manual(values = group_colors) +
  scale_fill_manual(values = group_colors) +
  theme_minimal() +
  labs(
    title = "PCoA (Bray-Curtis) - Bacteria",
    x = paste0("PC1 (", pc1_variance_ZnD5, "%)"),
    y = paste0("PC2 (", pc2_variance_ZnD5, "%)"),
    color = "Group"
  ) +
  theme(
    legend.position = "right",
    legend.title = element_text(size = 22, face = "bold"),
    legend.text = element_text(size = 20),
    panel.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(face = "bold", size = 24),
    axis.title.x = element_text(face = "bold", size = 20),
    axis.title.y = element_text(face = "bold", size = 20)
  )

# 🔹 Save and print the plot
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/pcoa_ZnD5_bacteria.png", plot = pcoa_plot_ZnD5_bacteria, width = 8, height = 6, dpi = 300)
pcoa_plot_ZnD5_bacteria
```
#BACTERIA SEPARATED BY LOCATION BUT NOT TREATMENT
```{r}
# 🔹 Update color palette for Location only
location_colors <- c(
  "colon" = "#D55E00",
  "intestine" = "#56B4E9",
  "cecum" = "#009E73"
)

# 🔹 PCoA Plot by Location only
pcoa_bacteria_location_only <- ggplot(pcoa_scores_ZnD5, aes(x = PC1, y = PC2, color = Location, fill = Location)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.2) +
  scale_color_manual(values = location_colors) +
  scale_fill_manual(values = location_colors) +
  theme_minimal() +
  labs(
    title = "PCoA (Bray-Curtis) - Bacterial Reads",
    x = paste0("PC1 (", pc1_variance_ZnD5, "%)"),
    y = paste0("PC2 (", pc2_variance_ZnD5, "%)"),
    color = "Location"
  ) +
  theme(
    legend.position = "right",
    legend.title = element_text(size = 22, face = "bold"),
    legend.text = element_text(size = 20),
    panel.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(face = "bold", size = 24),
    axis.title.x = element_text(face = "bold", size = 20),
    axis.title.y = element_text(face = "bold", size = 20)
  )

# 🔹 Save and display
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/PCoA/pcoa_ZnD5_bacteria_location.png",
       plot = pcoa_bacteria_location_only, width = 8, height = 6, dpi = 300)

pcoa_bacteria_location_only

```

#BACTERIA, NOT SEPARATED BY LOCATION

```{r}
# Load required libraries
library(ggplot2)
library(vegan)  # For Bray-Curtis distance
library(dplyr)  # Data manipulation
library(janitor) # Cleaning column names
library(ggrepel) # For sample labels
metadata_ZnD5
combined_bacteria_gut
# 🔹 Merge Bracken data with metadata
pcoa_input_ZnD5_bacteria <- merge(t(combined_bacteria_gut), metadata_ZnD5, by.x = "row.names", by.y = "Sample")
colnames(pcoa_input_ZnD5_bacteria)[1] <- "Sample"  # Ensure first column is Sample
pcoa_input_ZnD5_bacteria
# 🔹 Select only numerical abundance data
pcoa_numeric_ZnD5 <- pcoa_input_ZnD5_bacteria[, !(colnames(pcoa_input_ZnD5_bacteria) %in% c("Sample", "Treatment", "Location"))]

# Convert the matrix to character (in case some columns are factors)
pcoa_numeric_ZnD5 <- apply(pcoa_numeric_ZnD5, 2, as.character)

# Trim leading/trailing spaces and convert to numeric
pcoa_numeric_ZnD5 <- apply(pcoa_numeric_ZnD5, 2, function(x) as.numeric(trimws(x)))

# Ensure it is a numeric matrix
pcoa_numeric_ZnD5 <- as.matrix(pcoa_numeric_ZnD5)
pcoa_numeric_ZnD5
# Check that the conversion worked
str(pcoa_numeric_ZnD5)  # Should display 'num' type

# Replace NA values with 0 to avoid division errors
pcoa_numeric_ZnD5[is.na(pcoa_numeric_ZnD5)] <- 0

# Compute row sums
row_sums <- rowSums(pcoa_numeric_ZnD5)

# Check if there are any zero row sums
print(sum(row_sums == 0))  # If this prints >0, you have zero-sum rows!


# 🔹 Normalize by total reads per sample (relative abundance)
pcoa_numeric_ZnD5 <- pcoa_numeric_ZnD5 / rowSums(pcoa_numeric_ZnD5)
pcoa_numeric_ZnD5
# 🔹 Compute Bray-Curtis distance matrix
bray_curtis_dist <- vegdist(pcoa_numeric_ZnD5, method = "bray")

# 🔹 Perform PCoA (Principal Coordinates Analysis)
pcoa_result_ZnD5 <- cmdscale(bray_curtis_dist, k = 2, eig = TRUE)  # Compute eigenvalues

# 🔹 Convert PCoA results into a data frame
pcoa_scores_ZnD5 <- as.data.frame(pcoa_result_ZnD5$points)
colnames(pcoa_scores_ZnD5) <- c("PC1", "PC2")
pcoa_scores_ZnD5$Sample <- pcoa_input_ZnD5_bacteria$Sample

# 🔹 Merge PCoA scores with metadata
pcoa_scores_ZnD5 <- merge(pcoa_scores_ZnD5, metadata_ZnD5, by = "Sample")

# 🔹 Calculate variance explained
pc1_variance_ZnD5 <- round(100 * (pcoa_result_ZnD5$eig[1] / sum(pcoa_result_ZnD5$eig)), 1)
pc2_variance_ZnD5 <- round(100 * (pcoa_result_ZnD5$eig[2] / sum(pcoa_result_ZnD5$eig)), 1)

# 🔹 Print variance explained
cat("PC1 Variance:", pc1_variance_ZnD5, "%\n")
cat("PC2 Variance:", pc2_variance_ZnD5, "%\n")


treatment_colors <- c("ZnD" = "#E8B31A", "ZnA" = "#75AE33")

# PCoA Plot: Treatment only
pcoa_plot_ZnD5_bacteria_no_location <- ggplot(pcoa_scores_ZnD5, aes(x = PC1, y = PC2, color = Treatment, fill = Treatment)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.2) +
  scale_color_manual(values = treatment_colors) +
  scale_fill_manual(values = treatment_colors) +
  theme_minimal() +
  labs(
    title = "PCoA (Bray-Curtis) - Bacteria",
    x = paste0("PC1 (", pc1_variance_ZnD5, "%)"),
    y = paste0("PC2 (", pc2_variance_ZnD5, "%)"),
    color = "Treatment"
  ) +
  theme(
    legend.position = "right",
    legend.title = element_text(size = 22, face = "bold"),
    legend.text = element_text(size = 20),
    panel.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(face = "bold", size = 24),
    axis.title.x = element_text(face = "bold", size = 20),
    axis.title.y = element_text(face = "bold", size = 20)
  )

# Save and print the plot
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/PCoA/pcoa_plot_ZnD5_bacteria_no_location.png",
       plot = pcoa_plot_ZnD5_bacteria_no_location, width = 8, height = 6, dpi = 300)
pcoa_plot_ZnD5_bacteria_no_location
```

```{r}
# Define treatment colors
treatment_colors <- c("ZnD" = "#E8B31A", "ZnA" = "#75AE33")

# Function to generate PCoA plot for a specific location
plot_pcoa_by_location <- function(location_name) {
  df_subset <- filter(pcoa_scores_ZnD5, Location == location_name)
  
  ggplot(df_subset, aes(x = PC1, y = PC2, color = Treatment, fill = Treatment)) +
    geom_point(size = 3, alpha = 0.8) +
    stat_ellipse(geom = "polygon", alpha = 0.2) +
    scale_color_manual(values = treatment_colors) +
    scale_fill_manual(values = treatment_colors) +
    theme_minimal() +
    labs(
      title = paste("PCoA (Bray-Curtis) -", location_name),
      x = paste0("PC1 (", pc1_variance_ZnD5, "%)"),
      y = paste0("PC2 (", pc2_variance_ZnD5, "%)"),
      color = "Treatment"
    ) +
    theme(
      legend.position = "right",
    legend.title = element_text(size = 22, face = "bold"),
    legend.text = element_text(size = 20),
    panel.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(face = "bold", size = 24),
    axis.title.x = element_text(face = "bold", size = 20),
    axis.title.y = element_text(face = "bold", size = 20)
  )
    
}

# Generate plots
p_intestine <- plot_pcoa_by_location("intestine")
p_colon <- plot_pcoa_by_location("colon")
p_cecum <- plot_pcoa_by_location("cecum")

# Save plots

# Display one as preview
p_intestine
p_colon
p_cecum

# Save Intestine PCoA plot
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/PCoA/acteria_intestine_pcoa.png",
       plot = p_intestine, width = 8, height = 6, dpi = 300)

# Save Colon PCoA plot
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/PCoA/bacteria_colon_pcoa.png",
       plot = p_colon, width = 8, height = 6, dpi = 300)

# Save Cecum PCoA plot
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/PCoA/bacteria_cecum_pcoa.png",
       plot = p_cecum, width = 8, height = 6, dpi = 300)

```


#FUNGI, SEPARATED BY LOCATION, NOT SEPARATED BY TREATMENT

```{r}
# Define color palette by location
location_colors <- c(
  "colon" = "#D55E00",
  "intestine" = "#56B4E9",
  "cecum" = "#009E73"
)

# Transpose and merge metadata
pcoa_input_ZnD5_fungi <- merge(t(combined_fungi_gut), metadata_ZnD5, by.x = "row.names", by.y = "Sample")
colnames(pcoa_input_ZnD5_fungi)[1] <- "Sample"

# Extract numeric matrix and clean
numeric_data <- pcoa_input_ZnD5_fungi[, !(colnames(pcoa_input_ZnD5_fungi) %in% c("Sample", "Treatment", "Location"))]
numeric_data <- apply(numeric_data, 2, function(x) as.numeric(trimws(as.character(x))))
numeric_data <- as.matrix(numeric_data)
rownames(numeric_data) <- pcoa_input_ZnD5_fungi$Sample
numeric_data[is.na(numeric_data)] <- 0

# Filter zero-sum rows and normalize
row_totals <- rowSums(numeric_data)
nonzero_rows <- row_totals != 0
numeric_data_clean <- numeric_data[nonzero_rows, , drop = FALSE]
numeric_data_clean <- numeric_data_clean / rowSums(numeric_data_clean)
numeric_data_clean[!is.finite(numeric_data_clean)] <- 0

# Bray-Curtis distance & PCoA
bray_curtis_dist <- vegdist(numeric_data_clean, method = "bray")
pcoa_result <- cmdscale(bray_curtis_dist, k = 2, eig = TRUE)

# Extract and merge scores
pcoa_scores <- as.data.frame(pcoa_result$points)
colnames(pcoa_scores) <- c("PC1", "PC2")
pcoa_scores$Sample <- rownames(pcoa_scores)
metadata_matched <- metadata_ZnD5[metadata_ZnD5$Sample %in% pcoa_scores$Sample, ]
pcoa_scores <- merge(pcoa_scores, metadata_matched, by = "Sample")

# Calculate variance explained
pc1_var <- round(100 * (pcoa_result$eig[1] / sum(pcoa_result$eig)), 1)
pc2_var <- round(100 * (pcoa_result$eig[2] / sum(pcoa_result$eig)), 1)

# PCoA Plot grouped by Location
pcoa_plot_ZnD5_fungi_location <- ggplot(pcoa_scores, aes(x = PC1, y = PC2, color = Location, fill = Location)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.2) +
  scale_color_manual(values = location_colors) +
  scale_fill_manual(values = location_colors) +
  theme_minimal() +
  labs(
    title = "PCoA (Bray-Curtis) - Fungal Reads",
    x = paste0("PC1 (", pc1_var, "%)"),
    y = paste0("PC2 (", pc2_var, "%)"),
    color = "Location"
  ) +
  theme(
    legend.position = "right",
    legend.title = element_text(size = 22, face = "bold"),
    legend.text = element_text(size = 20),
    panel.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(face = "bold", size = 24),
    axis.title.x = element_text(face = "bold", size = 20),
    axis.title.y = element_text(face = "bold", size = 20)
  )

# Save the plot
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/PCoA/pcoa_ZnD5_fungi_by_location.png",
       plot = pcoa_plot_ZnD5_fungi_location, width = 8, height = 6, dpi = 300)

# Display the plot
pcoa_plot_ZnD5_fungi_location

```


```{r}
# Transpose and merge metadata
pcoa_input_ZnD5_fungi <- merge(t(combined_fungi_gut), metadata_ZnD5, by.x = "row.names", by.y = "Sample")


pcoa_input_ZnD5_fungi
colnames(pcoa_input_ZnD5_fungi)[1] <- "Sample"

# Extract numeric matrix
numeric_data <- pcoa_input_ZnD5_fungi[, !(colnames(pcoa_input_ZnD5_fungi) %in% c("Sample", "Treatment", "Location"))]
numeric_data <- apply(numeric_data, 2, function(x) as.numeric(trimws(as.character(x))))
numeric_data <- as.matrix(numeric_data)
rownames(numeric_data) <- pcoa_input_ZnD5_fungi$Sample  # 🔹 Keep sample names

# Replace NAs
numeric_data[is.na(numeric_data)] <- 0

# Filter rows with zero sums
row_totals <- rowSums(numeric_data)
nonzero_rows <- row_totals != 0
numeric_data_clean <- numeric_data[nonzero_rows, , drop = FALSE]

# Normalize rows
row_totals_clean <- rowSums(numeric_data_clean)
numeric_data_clean <- numeric_data_clean / row_totals_clean
numeric_data_clean[!is.finite(numeric_data_clean)] <- 0

# Bray-Curtis & PCoA
bray_curtis_dist <- vegdist(numeric_data_clean, method = "bray")
pcoa_result <- cmdscale(bray_curtis_dist, k = 2, eig = TRUE)

# Extract scores and match sample names
pcoa_scores <- as.data.frame(pcoa_result$points)
colnames(pcoa_scores) <- c("PC1", "PC2")
pcoa_scores$Sample <- rownames(pcoa_scores)
metadata_matched <- metadata_ZnD5[metadata_ZnD5$Sample %in% pcoa_scores$Sample, ]

# Merge with metadata
pcoa_scores <- merge(pcoa_scores, metadata_matched, by = "Sample")
pcoa_scores
# Variance explained
pc1_var <- round(100 * (pcoa_result$eig[1] / sum(pcoa_result$eig)), 1)
pc2_var <- round(100 * (pcoa_result$eig[2] / sum(pcoa_result$eig)), 1)

# Group column
pcoa_scores$Group <- paste(pcoa_scores$Treatment, pcoa_scores$Location, sep = " ")
custom_colors <- c(
  "ZnD" = "#E8B31A",
  "ZnA" = "#75AE33"
)

# Plot
pcoa_plot_ZnD5_fungi <- ggplot(pcoa_scores, aes(x = PC1, y = PC2, color = Treatment, fill = Treatment)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.2) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_minimal() +
  labs(
    title = "PCoA (Bray-Curtis) - Fungi",
    x = paste0("PC1 (", pc1_var, "%)"),
    y = paste0("PC2 (", pc2_var, "%)"),
    color = "Treatment"
  ) +
  theme(
    legend.position = "right",
    legend.title = element_text(size = 22, face = "bold"),
    legend.text = element_text(size = 20),
    panel.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(face = "bold", size = 24),
    axis.title.x = element_text(face = "bold", size = 20),
    axis.title.y = element_text(face = "bold", size = 20)
  )

# Save plot
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/pcoa_ZnD5_fungi_bytreatment.png",
       plot = pcoa_plot_ZnD5_fungi, width = 8, height = 6, dpi = 300)

pcoa_plot_ZnD5_fungi


```

```{r}
# Filter data by each location
pcoa_fungi_intestine <- pcoa_scores %>% filter(Location == "intestine")
pcoa_fungi_colon <- pcoa_scores %>% filter(Location == "colon")
pcoa_fungi_cecum <- pcoa_scores %>% filter(Location == "cecum")

# Define colors again (optional)
custom_colors <- c("ZnD" = "#E8B31A", "ZnA" = "#75AE33")
pcoa_fungi_intestine
pcoa_fungi_colon
pcoa_fungi_cecum
# PCoA Plot - Intestine
p_fungi_intestine <- ggplot(pcoa_fungi_intestine, aes(x = PC1, y = PC2, color = Treatment, fill = Treatment)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.2) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_minimal() +
  labs(
    title = "PCoA (Bray-Curtis) - Fungi (Intestine)",
    x = paste0("PC1 (", pc1_var, "%)"),
    y = paste0("PC2 (", pc2_var, "%)"),
    color = "Treatment"
  ) +
  theme(
    legend.position = "right",
    legend.title = element_text(size = 22, face = "bold"),
    legend.text = element_text(size = 20),
    panel.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(face = "bold", size = 24),
    axis.title.x = element_text(face = "bold", size = 20),
    axis.title.y = element_text(face = "bold", size = 20)
  )

# PCoA Plot - Colon
p_fungi_colon <- ggplot(pcoa_fungi_colon, aes(x = PC1, y = PC2, color = Treatment, fill = Treatment)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.2) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_minimal() +
  labs(
    title = "PCoA (Bray-Curtis) - Fungi (Colon)",
    x = paste0("PC1 (", pc1_var, "%)"),
    y = paste0("PC2 (", pc2_var, "%)"),
    color = "Treatment"
  ) +
  theme(
    legend.position = "right",
    legend.title = element_text(size = 22, face = "bold"),
    legend.text = element_text(size = 20),
    panel.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(face = "bold", size = 24),
    axis.title.x = element_text(face = "bold", size = 20),
    axis.title.y = element_text(face = "bold", size = 20)
  )

# PCoA Plot - Cecum
p_fungi_cecum <- ggplot(pcoa_fungi_cecum, aes(x = PC1, y = PC2, color = Treatment, fill = Treatment)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.2) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_minimal() +
  labs(
    title = "PCoA (Bray-Curtis) - Fungi (Cecum)",
    x = paste0("PC1 (", pc1_var, "%)"),
    y = paste0("PC2 (", pc2_var, "%)"),
    color = "Treatment"
  ) +
  theme(
    legend.position = "right",
    legend.title = element_text(size = 22, face = "bold"),
    legend.text = element_text(size = 20),
    panel.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(face = "bold", size = 24),
    axis.title.x = element_text(face = "bold", size = 20),
    axis.title.y = element_text(face = "bold", size = 20)
  )

# Save the plots
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/PCoA/pcoa_fungi_intestine.png",
       plot = p_fungi_intestine, width = 8, height = 6, dpi = 300)

ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/PCoA/pcoa_fungi_colon.png",
       plot = p_fungi_colon, width = 8, height = 6, dpi = 300)

ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/PCoA/pcoa_fungi_cecum.png",
       plot = p_fungi_cecum, width = 8, height = 6, dpi = 300)
p_fungi_colon
p_fungi_cecum
```
```{r}
sum(row_totals == 0)  # How many samples had 0 sum?
setdiff(rownames(numeric_data), rownames(numeric_data_clean))  # Which samples got dropped?

```


```{r}
# Transpose and merge metadata
pcoa_input_ZnD5_virus <- merge(t(combined_virus_gut), metadata_ZnD5, by.x = "row.names", by.y = "Sample")

pcoa_input_ZnD5_virus
colnames(pcoa_input_ZnD5_virus)[1] <- "Sample"

# Extract numeric matrix
numeric_data <- pcoa_input_ZnD5_virus[, !(colnames(pcoa_input_ZnD5_virus) %in% c("Sample", "Treatment", "Location"))]
numeric_data <- apply(numeric_data, 2, function(x) as.numeric(trimws(as.character(x))))
numeric_data <- as.matrix(numeric_data)
rownames(numeric_data) <- pcoa_input_ZnD5_virus$Sample  # 🔹 Keep sample names

# Replace NAs
numeric_data[is.na(numeric_data)] <- 0

# Filter rows with zero sums
row_totals <- rowSums(numeric_data)
nonzero_rows <- row_totals != 0
numeric_data_clean <- numeric_data[nonzero_rows, , drop = FALSE]

# Normalize rows
row_totals_clean <- rowSums(numeric_data_clean)
numeric_data_clean <- numeric_data_clean / row_totals_clean
numeric_data_clean[!is.finite(numeric_data_clean)] <- 0

# Bray-Curtis & PCoA
bray_curtis_dist <- vegdist(numeric_data_clean, method = "bray")
pcoa_result <- cmdscale(bray_curtis_dist, k = 2, eig = TRUE)

# Extract scores and match sample names
pcoa_scores <- as.data.frame(pcoa_result$points)
colnames(pcoa_scores) <- c("PC1", "PC2")
pcoa_scores$Sample <- rownames(pcoa_scores)
metadata_matched <- metadata_ZnD5[metadata_ZnD5$Sample %in% pcoa_scores$Sample, ]

# Merge with metadata
pcoa_scores <- merge(pcoa_scores, metadata_matched, by = "Sample")
pcoa_scores
# Variance explained
pc1_var <- round(100 * (pcoa_result$eig[1] / sum(pcoa_result$eig)), 1)
pc2_var <- round(100 * (pcoa_result$eig[2] / sum(pcoa_result$eig)), 1)

# Group column
pcoa_scores$Group <- paste(pcoa_scores$Treatment, pcoa_scores$Location, sep = " ")
custom_colors <- c(
  "ZnD" = "#E8B31A",
  "ZnA" = "#75AE33"
)

# Plot
pcoa_plot_ZnD5_virus <- ggplot(pcoa_scores, aes(x = PC1, y = PC2, color = Treatment, fill = Treatment)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.2) +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  theme_minimal() +
  labs(
    title = "PCoA (Bray-Curtis) - Virus",
    x = paste0("PC1 (", pc1_var, "%)"),
    y = paste0("PC2 (", pc2_var, "%)"),
    color = "Treatment"
  ) +
  theme(
    legend.position = "right",
    legend.title = element_text(size = 22, face = "bold"),
    legend.text = element_text(size = 20),
    panel.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(face = "bold", size = 24),
    axis.title.x = element_text(face = "bold", size = 20),
    axis.title.y = element_text(face = "bold", size = 20)
  )

# Save plot
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/pcoa_ZnD5_virus_bytreatment.png",
       plot = pcoa_plot_ZnD5_virus, width = 8, height = 6, dpi = 300)

pcoa_plot_ZnD5_virus

```

```{r}
# Define color palette by location
location_colors <- c(
  "colon" = "#D55E00",
  "intestine" = "#56B4E9",
  "cecum" = "#009E73"
)

# Transpose and merge metadata
pcoa_input_ZnD5_virus <- merge(t(combined_virus_gut), metadata_ZnD5, by.x = "row.names", by.y = "Sample")
colnames(pcoa_input_ZnD5_virus)[1] <- "Sample"

# Extract numeric matrix
numeric_data <- pcoa_input_ZnD5_virus[, !(colnames(pcoa_input_ZnD5_virus) %in% c("Sample", "Treatment", "Location"))]
numeric_data <- apply(numeric_data, 2, function(x) as.numeric(trimws(as.character(x))))
numeric_data <- as.matrix(numeric_data)
rownames(numeric_data) <- pcoa_input_ZnD5_virus$Sample
numeric_data[is.na(numeric_data)] <- 0

# Filter zero-sum rows and normalize
row_totals <- rowSums(numeric_data)
nonzero_rows <- row_totals != 0
numeric_data_clean <- numeric_data[nonzero_rows, , drop = FALSE]
numeric_data_clean <- numeric_data_clean / rowSums(numeric_data_clean)
numeric_data_clean[!is.finite(numeric_data_clean)] <- 0

# Compute Bray-Curtis and PCoA
bray_curtis_dist <- vegdist(numeric_data_clean, method = "bray")
pcoa_result <- cmdscale(bray_curtis_dist, k = 2, eig = TRUE)

# Extract PCoA scores and merge with metadata
pcoa_scores <- as.data.frame(pcoa_result$points)
colnames(pcoa_scores) <- c("PC1", "PC2")
pcoa_scores$Sample <- rownames(pcoa_scores)
metadata_matched <- metadata_ZnD5[metadata_ZnD5$Sample %in% pcoa_scores$Sample, ]
pcoa_scores <- merge(pcoa_scores, metadata_matched, by = "Sample")

# Calculate percent variance explained
pc1_var <- round(100 * (pcoa_result$eig[1] / sum(pcoa_result$eig)), 1)
pc2_var <- round(100 * (pcoa_result$eig[2] / sum(pcoa_result$eig)), 1)

# Plot by location only
pcoa_plot_ZnD5_virus_location <- ggplot(pcoa_scores, aes(x = PC1, y = PC2, color = Location, fill = Location)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.2) +
  scale_color_manual(values = location_colors) +
  scale_fill_manual(values = location_colors) +
  theme_minimal() +
  labs(
    title = "PCoA (Bray-Curtis) - Viral Reads",
    x = paste0("PC1 (", pc1_var, "%)"),
    y = paste0("PC2 (", pc2_var, "%)"),
    color = "Location"
  ) +
  theme(
    legend.position = "right",
    legend.title = element_text(size = 22, face = "bold"),
    legend.text = element_text(size = 20),
    panel.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(face = "bold", size = 24),
    axis.title.x = element_text(face = "bold", size = 20),
    axis.title.y = element_text(face = "bold", size = 20)
  )

# Save plot
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/PCoA/pcoa_ZnD5_virus_by_location.png",
       plot = pcoa_plot_ZnD5_virus_location, width = 8, height = 6, dpi = 300)

# Display
pcoa_plot_ZnD5_virus_location

```


```{r}
# Group column: Treatment + Location
pcoa_scores$Group <- paste(pcoa_scores$Treatment, pcoa_scores$Location, sep = " ")

# Define custom colors for each Group
group_colors <- c(
  "ZnD colon" = "#E8B31A",
  "ZnD intestine" = "#56B4E9",
  "ZnD cecum" = "#009E73",
  "ZnA colon" = "#F0E442",
  "ZnA intestine" = "#75AE33",
  "ZnA cecum" = "#D55E00"
)

# Updated Plot
pcoa_plot_ZnD5_virus_location <- ggplot(pcoa_scores, aes(x = PC1, y = PC2, color = Group, fill = Group)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(geom = "polygon", alpha = 0.2) +
  scale_color_manual(values = group_colors) +
  scale_fill_manual(values = group_colors) +
  theme_minimal() +
  labs(
    title = "PCoA (Bray-Curtis) - Virus",
    x = paste0("PC1 (", pc1_var, "%)"),
    y = paste0("PC2 (", pc2_var, "%)"),
    color = "Group"
  ) +
  theme(
    legend.position = "right",
    legend.title = element_text(size = 22, face = "bold"),
    legend.text = element_text(size = 20),
    panel.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(face = "bold", size = 24),
    axis.title.x = element_text(face = "bold", size = 20),
    axis.title.y = element_text(face = "bold", size = 20)
  )

# Save updated plot
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/pcoa_ZnD5_virus_grouped_location.png",
       plot = pcoa_plot_ZnD5_virus_location, width = 8, height = 6, dpi = 300)

pcoa_plot_ZnD5_virus

```


#CALCULATE FUNGAL:BACTERIAL RATIO AND VIRAL:BACTERIAL RATIO


```{r}
library(tibble)  # This contains column_to_rownames()
library(readr)
library(ggplot2)
ann_colors <- c(
  "ZnD" = "#E8B31A",
  "ZnA" = "#75AE33"
)

combined_bacteria_S <- read_csv("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_bacteria_S.csv", col_names = TRUE) %>% 
  column_to_rownames(var = colnames(.)[1]) %>%
  rename_with(~ gsub("_report", "", .))
colnames(combined_bacteria_S) <- gsub("-", ".", colnames(combined_bacteria_S))

combined_virus_S <- read_csv("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_virus_S.csv", col_names = TRUE) %>% 
  column_to_rownames(var = colnames(.)[1]) %>%
  rename_with(~ gsub("_report", "", .))
colnames(combined_virus_S) <- gsub("-", ".", colnames(combined_virus_S))

combined_fungi_S <- read_csv("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_fungi_S.csv", col_names = TRUE) %>% 
  column_to_rownames(var = colnames(.)[1]) %>%
  rename_with(~ gsub("_report", "", .))
colnames(combined_fungi_S) <- gsub("-", ".", colnames(combined_fungi_S))

combined_bacteria_gut
metadata_ZnD5
combined_virus_S
combined_fungi_S

#USING OBSERVED SPECIES COUNTS 
# Calculate observed species richness per sample (number of unique taxa)
bacteria_richness <- colSums(combined_bacteria_gut[,-ncol(combined_bacteria_gut)] > 0)  # Count nonzero bacterial taxa
fungi_richness <- colSums(combined_fungi_gut[,-ncol(combined_fungi_gut)] > 0)  # Count nonzero fungal taxa
virus_richness <- colSums(combined_virus_gut[,-ncol(combined_virus_gut)] > 0)  # Count nonzero viral taxa

# Create a data frame with richness ratios
richness_ratio_df <- data.frame(
  Sample = names(bacteria_richness),
  Fungi_Bacteria_Richness_Ratio = fungi_richness / bacteria_richness,
  Virus_Bacteria_Richness_Ratio = virus_richness / bacteria_richness
)

# Merge with metadata to add treatment groups
#richness_ratio_df$Sample <- sub("ZnD5\\-", "ZnD5.", richness_ratio_df$Sample)
richness_ratio_df <- merge(richness_ratio_df, metadata_ZnD5, by = "Sample")
metadata_ZnD5
richness_ratio_df

fungi_bacteria_richness_plot <- ggplot(richness_ratio_df, aes(x = Treatment, y = Fungi_Bacteria_Richness_Ratio, fill = Treatment)) +
  geom_boxplot(alpha = 0.7, width = 0.8) +
  scale_fill_manual(values = ann_colors) +
  theme_minimal() +
  labs(
    title = "",
    x = "",
    y = "Fungi/Bacteria Richness Ratio"
  ) +
  theme(
        plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold", color = "black", angle = 45, hjust = 1),
        axis.text.y = element_text(size = 14, color = "black"),
        legend.position = "none"
      ) #+ 
  #stat_compare_means(method = "kruskal.test", label.y = 0.28, size = 5, label = "p.format") 
  #stat_compare_means(method = "wilcox.test", label = "p.signif", size = 5, comparisons = list(c("ZnA", "ZnD")), hide.ns = TRUE)

virus_bacteria_richness_plot <- ggplot(richness_ratio_df, aes(x = Treatment, y = Virus_Bacteria_Richness_Ratio, fill = Treatment)) +
  geom_boxplot(alpha = 0.7, width = 0.8) +
  scale_fill_manual(values = ann_colors) +
  theme_minimal() +
  labs(
    title = "",
    x = "",
    y = "Virus/Bacteria Richness Ratio"
  ) +
  theme(
        plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold", color = "black", angle = 45, hjust = 1),
        axis.text.y = element_text(size = 14, color = "black"),
        legend.position = "none"
      ) #+ 
  #stat_compare_means(method = "kruskal.test", label.y = 0.28, size = 5, label = "p.format") 
  #stat_compare_means(method = "wilcox.test", label = "p.signif", size = 5, comparisons = list(c("ZnA", "ZnD")), hide.ns = TRUE)

# Print
print(fungi_bacteria_richness_plot)
print(virus_bacteria_richness_plot)
richness_ratio_df$Location <- factor(richness_ratio_df$Location, levels = c("intestine", "cecum", "colon"))


fungi_bacteria_plot_byloc <- ggplot(richness_ratio_df, aes(x = Location, y = Fungi_Bacteria_Richness_Ratio, fill = Location)) +
  scale_fill_manual(values = location_colors) +
  geom_boxplot(alpha = 0.7, width = 0.8) +
  theme_minimal() +
  labs(
    title = "",
    x = "",
    y = "Fungi/Bacteria Richness Ratio"
  ) +
  theme(
        plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold", color = "black", angle = 45, hjust = 1),
        axis.text.y = element_text(size = 14, color = "black"),
        legend.position = "none"
      ) + 
  #stat_compare_means(method = "kruskal.test", label.y = 0.28, size = 5, label = "p.format") 
  stat_compare_means(method = "wilcox.test", label = "p.signif", size = 5, comparisons = list(c("cecum", "intestine"),c("colon", "intestine")), hide.ns = TRUE)

# Plot 2: Virus/Bacteria by Location
virus_bacteria_plot_byloc <- ggplot(richness_ratio_df, aes(x = Location, y = Virus_Bacteria_Richness_Ratio, fill = Location)) +
  scale_fill_manual(values = location_colors) +
  geom_boxplot(alpha = 0.7, width = 0.8) +
  theme_minimal() +
  labs(
    title = "",
    x = "",
    y = "Virus/Bacteria Richness Ratio"
  ) +
  theme(
        plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold", color = "black", angle = 45, hjust = 1),
        axis.text.y = element_text(size = 14, color = "black"),
        legend.position = "none"
      ) + 
  #stat_compare_means(method = "kruskal.test", label.y = 0.28, size = 5, label = "p.format") 
  stat_compare_means(method = "wilcox.test", label = "p.signif", size = 5, comparisons = list(c("cecum", "intestine"), c("colon", "intestine")), hide.ns = TRUE)


# Print
print(fungi_bacteria_plot_byloc)
print(virus_bacteria_plot_byloc)




# Save
ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/fungi_bacteria_richness_ratio_thin.png",
       plot = fungi_bacteria_richness_plot, width = 1.6, height = 5.5, dpi = 300)

ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/virus_bacteria_richness_ratio_thin.png",
       plot = virus_bacteria_richness_plot, width = 1.6, height = 5.5, dpi = 300)

ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/fungi_bacteria_plot_byloc_thin.png",
       plot = fungi_bacteria_plot_byloc, width = 1.7, height = 5.5, dpi = 300)

ggsave("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/virus_bacteria_plot_byloc_thin.png",
       plot = virus_bacteria_plot_byloc, width = 1.6, height = 5.5, dpi = 300)

```


#DIFFERENTIAL EXPRESSION ANALYSIS USING Maaslin2 FOR ALL TAXONOMIC LEVELS, SEPARATED BY BACTERIA, FUNGI, AND VIRUSES

```{r}
# Convert metadata to a data frame (if not already)
metadata_phy_ZnD5 <- metadata_ZnD5
metadata_phy_ZnD5 <- as.data.frame(metadata_phy_ZnD5)
rownames(metadata_phy_ZnD5) <- metadata_phy_ZnD5$Sample
metadata_phy_ZnD5$Treatment <- factor(metadata_phy_ZnD5$Treatment, levels = c("ZnA", "ZnD"))
levels(metadata_phy_ZnD5$Treatment)
metadata_phy_ZnD5
#metadata_ZnD5_phy

metadata_phy_ZnD5 <- metadata_phy_ZnD5[order(rownames(metadata_phy_ZnD5)), ]
sample_order <- make.names(rownames(metadata_phy_ZnD5))
sample_order <- gsub("^X(?=\\d)", "", sample_order, perl = TRUE)
sample_order
metadata_phy_ZnD5 <- as.data.frame(metadata_phy_ZnD5)
```

```{r}
read_and_reorder <- function(filepath, sample_order) {
  df <- readr::read_csv(filepath, col_names = TRUE) %>%
    column_to_rownames(var = colnames(.)[1]) %>%
    rename_with(~ gsub("_report", "", .))
  
  # Replace hyphens with periods
  colnames(df) <- gsub("-", ".", colnames(df))
  
  # Reorder to match metadata
  df <- df[, sample_order[sample_order %in% colnames(df)], drop = FALSE]
  return(df)
}
#combined_bacteria_S 
combined_bacteria_S <- read_and_reorder("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_bacteria_S.csv", sample_order)
combined_virus_S    <- read_and_reorder("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_virus_S.csv", sample_order)
combined_fungi_S    <- read_and_reorder("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_fungi_S.csv", sample_order)

combined_bacteria_G <- read_and_reorder("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_bacteria_G.csv", sample_order)
combined_virus_G    <- read_and_reorder("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_virus_G.csv", sample_order)
combined_fungi_G    <- read_and_reorder("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_fungi_G.csv", sample_order)

combined_bacteria_F <- read_and_reorder("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_bacteria_F.csv", sample_order)
combined_virus_F    <- read_and_reorder("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_virus_F.csv", sample_order)
combined_fungi_F    <- read_and_reorder("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_fungi_F.csv", sample_order)

combined_bacteria_P <- read_and_reorder("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_bacteria_P.csv", sample_order)
combined_virus_P    <- read_and_reorder("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_virus_P.csv", sample_order)
combined_fungi_P    <- read_and_reorder("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_fungi_P.csv", sample_order)
```

```{r}
metadata_ZnD5 <- read.table("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/ZnD5_metadata.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)
metadata_ZnD5$Treatment <- as.factor(metadata_ZnD5$Treatment)
metadata_ZnD5$Treatment <- relevel(metadata_ZnD5$Treatment, ref = "ZnA")
#metadata_ZnD5$Sample <- gsub("ZnD5\\.", "ZnD5-", metadata_ZnD5$Sample)
metadata_ZnD5
combined_bacteria_S

library(dplyr)
library(tidyr)

# Example: Rank taxa for each location in the species-level bacteria dataframe
rank_taxa_by_location <- function(bacteria_df, metadata_df) {
  
  # Transpose to long format
  bacteria_long <- bacteria_df %>%
    tibble::rownames_to_column("Taxon") %>%
    pivot_longer(-Taxon, names_to = "Sample", values_to = "Abundance")
  
  # Merge with metadata to get location
  bacteria_long <- bacteria_long %>%
    left_join(metadata_df, by = "Sample")
  
  # Group by Location and Taxon, calculate mean abundance, then rank
  ranked <- bacteria_long %>%
    group_by(Location, Taxon) %>%
    summarise(Mean_Abundance = mean(Abundance), .groups = "drop") %>%
    group_by(Location) %>%
    arrange(Location, desc(Mean_Abundance)) %>%
    mutate(Rank = row_number())
  
  return(ranked)
}

# Run for each bacterial level
ranked_bacteria_S <- rank_taxa_by_location(combined_bacteria_S, metadata_ZnD5)
ranked_bacteria_G <- rank_taxa_by_location(combined_bacteria_G, metadata_ZnD5)
ranked_bacteria_F <- rank_taxa_by_location(combined_bacteria_F, metadata_ZnD5)
ranked_bacteria_P <- rank_taxa_by_location(combined_bacteria_P, metadata_ZnD5)

# Define output directory
output_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/"

# Write each ranked dataframe to CSV
write.csv(ranked_bacteria_S, file = file.path(output_dir, "ranked_bacteria_S.csv"), row.names = FALSE)
write.csv(ranked_bacteria_G, file = file.path(output_dir, "ranked_bacteria_G.csv"), row.names = FALSE)
write.csv(ranked_bacteria_F, file = file.path(output_dir, "ranked_bacteria_F.csv"), row.names = FALSE)
write.csv(ranked_bacteria_P, file = file.path(output_dir, "ranked_bacteria_P.csv"), row.names = FALSE)


ranked_bacteria_S
ranked_bacteria_G
ranked_bacteria_F
ranked_bacteria_P
```





```{r}
library(phyloseq)
library(data.table)
library(readr)
library(tibble)
library(Maaslin2)



# Print a message to confirm
print("Column names cleaned in all four dataframes.")

filter_sparse_taxa <- function(data, threshold = 1) {
  zero_counts <- rowSums(data == 0)  # Count number of zeros per taxa
  keep_taxa <- zero_counts / ncol(data) < threshold  # Keep taxa with <50% zeros
  return(data[keep_taxa, , drop = FALSE])
}

# Filter bacteria, fungi, and viruses before transposing for Maaslin2
filtered_bacteria_S <- filter_sparse_taxa(combined_bacteria_S)
filtered_bacteria_G <- filter_sparse_taxa(combined_bacteria_G)
filtered_bacteria_F <- filter_sparse_taxa(combined_bacteria_F)
filtered_bacteria_P <- filter_sparse_taxa(combined_bacteria_P)

filtered_fungi_S <- filter_sparse_taxa(combined_fungi_S)
filtered_fungi_G <- filter_sparse_taxa(combined_fungi_G)
filtered_fungi_F <- filter_sparse_taxa(combined_fungi_F)
filtered_fungi_P <- filter_sparse_taxa(combined_fungi_P)

filtered_virus_S <- filter_sparse_taxa(combined_virus_S)
filtered_virus_G <- filter_sparse_taxa(combined_virus_G)
filtered_virus_F <- filter_sparse_taxa(combined_virus_F)
filtered_virus_P <- filter_sparse_taxa(combined_virus_P)

filtered_bacteria_S
combined_bacteria_S
filtered_fungi_S
combined_fungi_S
filtered_virus_S
combined_virus_S
filtered_fungi_S
# Transpose for Maaslin2




bacteria_transposed <- as.data.frame(t(filtered_bacteria_S))
bacteria_transposed_G <- as.data.frame(t(filtered_bacteria_G))
bacteria_transposed_F <- as.data.frame(t(filtered_bacteria_F))
bacteria_transposed_P <- as.data.frame(t(filtered_bacteria_P))

# Function to clean column names
clean_rownames <- function(df) {
  rownames(df) <- gsub("-", ".", rownames(df))

  return(df)
}

# Clean the column names in the four dataframes
bacteria_transposed <- clean_rownames(bacteria_transposed)
bacteria_transposed_G <- clean_rownames(bacteria_transposed_G)
bacteria_transposed_P <- clean_rownames(bacteria_transposed_P)
bacteria_transposed_F <- clean_rownames(bacteria_transposed_F)

bacteria_transposed


fungi_transposed <- as.data.frame(t(filtered_fungi_S))
fungi_transposed_G <- as.data.frame(t(filtered_fungi_G))
fungi_transposed_F <- as.data.frame(t(filtered_fungi_F))
fungi_transposed_P <- as.data.frame(t(filtered_fungi_P))

virus_transposed <- as.data.frame(t(filtered_virus_S))
virus_transposed_G <- as.data.frame(t(filtered_virus_G))
virus_transposed_F <- as.data.frame(t(filtered_virus_F))
virus_transposed_P <- as.data.frame(t(filtered_virus_P))

# Ensure numeric mode for Maaslin2
bacteria_transposed <- as.matrix(bacteria_transposed)
mode(bacteria_transposed) <- "numeric"
bacteria_transposed_G <- as.matrix(bacteria_transposed_G)
mode(bacteria_transposed_G) <- "numeric"
bacteria_transposed_P <- as.matrix(bacteria_transposed_P)
mode(bacteria_transposed_P) <- "numeric"
bacteria_transposed_F <- as.matrix(bacteria_transposed_F)
mode(bacteria_transposed_F) <- "numeric"

fungi_transposed <- as.matrix(fungi_transposed)
mode(fungi_transposed) <- "numeric"
fungi_transposed_G <- as.matrix(fungi_transposed_G)
mode(fungi_transposed_G) <- "numeric"
fungi_transposed_F <- as.matrix(fungi_transposed_F)
mode(fungi_transposed_F) <- "numeric"
fungi_transposed_P <- as.matrix(fungi_transposed_P)
mode(fungi_transposed_P) <- "numeric"

virus_transposed <- as.matrix(virus_transposed)
mode(virus_transposed) <- "numeric"
virus_transposed_G <- as.matrix(virus_transposed_G)
mode(virus_transposed_G) <- "numeric"
virus_transposed_F <- as.matrix(virus_transposed_F)
mode(virus_transposed_F) <- "numeric"
virus_transposed_P <- as.matrix(virus_transposed_P)
mode(virus_transposed_P) <- "numeric"

bacteria_transposed 
fungi_transposed 
virus_transposed

# Run Maaslin2 for Bacteria
masalin_results_bacteria_S <- Maaslin2(
  bacteria_transposed,
  metadata_phy_ZnD5,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/masalin_results_bacteria_S", 
  fixed_effects = c("Location")
)

masalin_results_bacteria_G <- Maaslin2(
  bacteria_transposed_G,
  metadata_phy_ZnD5,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/masalin_results_bacteria_G", 
  fixed_effects = c("Location")
)

masalin_results_bacteria_F <- Maaslin2(
  bacteria_transposed_F,
  metadata_phy_ZnD5,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/masalin_results_bacteria_F", 
  fixed_effects = c("Location")
)

masalin_results_bacteria_P <- Maaslin2(
  bacteria_transposed_P,
  metadata_phy_ZnD5,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/masalin_results_bacteria_P", 
  fixed_effects = c("Treatment")
)

#BY LOCATION 
masalin_results_bacteria_S_location <- Maaslin2(
  bacteria_transposed,
  metadata_phy_ZnD5,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/masalin_results_bacteria_S_location", 
  fixed_effects = c("Location")
)

masalin_results_bacteria_G_location <- Maaslin2(
  bacteria_transposed_G,
  metadata_phy_ZnD5,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/masalin_results_bacteria_G_location", 
  fixed_effects = c("Location")
)

masalin_results_bacteria_F_location <- Maaslin2(
  bacteria_transposed_F,
  metadata_phy_ZnD5,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/masalin_results_bacteria_F_location", 
  fixed_effects = c("Location")
)

masalin_results_bacteria_P_location <- Maaslin2(
  bacteria_transposed_P,
  metadata_phy_ZnD5,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/masalin_results_bacteria_P_location", 
  fixed_effects = c("Location")
)

######

# Run Maaslin2 for Fungi
masalin_results_fungi_S <- Maaslin2(
  fungi_transposed,
  metadata_phy_ZnD5,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/masalin_results_fungi_S", 
  fixed_effects = c("Treatment")
)

masalin_results_fungi_G <- Maaslin2(
  fungi_transposed_G,
  metadata_phy_ZnD5,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/masalin_results_fungi_G", 
  fixed_effects = c("Treatment")
)

metadata_phy_ZnD5$Location <- factor(metadata_phy_ZnD5$Location, levels = c("intestine", "colon", "cecum"))

masalin_results_fungi_G_location <- Maaslin2(
  fungi_transposed_G,
  metadata_phy_ZnD5,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/masalin_results_fungi_G_location", 
  fixed_effects = c("Location")
)

masalin_results_fungi_F <- Maaslin2(
  fungi_transposed_F,
  metadata_phy_ZnD5,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/masalin_results_fungi_F", 
  fixed_effects = c("Treatment")
)

masalin_results_fungi_P <- Maaslin2(
  fungi_transposed_P,
  metadata_phy_ZnD5,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/masalin_results_fungi_P", 
  fixed_effects = c("Treatment")
)

# Run Maaslin2 for Virus
masalin_results_virus_S <- Maaslin2(
  virus_transposed,
  metadata_phy_ZnD5,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/masalin_results_virus_S", 
  fixed_effects = c("Treatment")
)

masalin_results_virus_G <- Maaslin2(
  virus_transposed_G,
  metadata_phy_ZnD5,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/masalin_results_virus_G", 
  fixed_effects = c("Treatment")
)

masalin_results_virus_F <- Maaslin2(
  virus_transposed_F,
  metadata_phy_ZnD5,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/masalin_results_virus_F", 
  fixed_effects = c("Treatment")
)

masalin_results_virus_P <- Maaslin2(
  virus_transposed_P,
  metadata_phy_ZnD5,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/masalin_results_virus_P", 
  fixed_effects = c("Treatment")
)

print(hi)

```

#DIFFERENTIAL EXPRESSION FILTERING BEFORE TO REMOVE ROWS WHERE 80% OF THE TAXA IS 0

```{r}
# Load Maaslin2
library(Maaslin2)
library(dplyr)

metadata_phy_ZnD5
metadata_colon
fungi_transposed

# 1️⃣ **Filter metadata for each location**
metadata_colon <- metadata_phy_ZnD5 %>% filter(Location == "colon")
metadata_intestine <- metadata_phy_ZnD5 %>% filter(Location == "intestine")
metadata_cecum <- metadata_phy_ZnD5 %>% filter(Location == "cecum")

filter_data_by_location <- function(data, metadata) {
  data_filtered <- data[rownames(data) %in% metadata$Sample, ]
  return(data_filtered)
}

# **Filter Bacteria**
bacteria_colon <- filter_data_by_location(bacteria_transposed, metadata_colon)
bacteria_intestine <- filter_data_by_location(bacteria_transposed, metadata_intestine)
bacteria_cecum <- filter_data_by_location(bacteria_transposed, metadata_cecum)
bacteria_colon_G <- filter_data_by_location(bacteria_transposed_G, metadata_colon)
bacteria_intestine_G <- filter_data_by_location(bacteria_transposed_G, metadata_intestine)
bacteria_cecum_G <- filter_data_by_location(bacteria_transposed_G, metadata_cecum)
bacteria_colon_F <- filter_data_by_location(bacteria_transposed_F, metadata_colon)
bacteria_intestine_F <- filter_data_by_location(bacteria_transposed_F, metadata_intestine)
bacteria_cecum_F <- filter_data_by_location(bacteria_transposed_F, metadata_cecum)
bacteria_colon_P <- filter_data_by_location(bacteria_transposed_P, metadata_colon)
bacteria_intestine_P <- filter_data_by_location(bacteria_transposed_P, metadata_intestine)
bacteria_cecum_P <- filter_data_by_location(bacteria_transposed_P, metadata_cecum)

# **Filter Fungi**
fungi_colon <- filter_data_by_location(fungi_transposed, metadata_colon)
fungi_intestine <- filter_data_by_location(fungi_transposed, metadata_intestine)
fungi_cecum <- filter_data_by_location(fungi_transposed, metadata_cecum)
fungi_colon_G <- filter_data_by_location(fungi_transposed_G, metadata_colon)
fungi_intestine_G <- filter_data_by_location(fungi_transposed_G, metadata_intestine)
fungi_cecum_G <- filter_data_by_location(fungi_transposed_G, metadata_cecum)
fungi_colon_F <- filter_data_by_location(fungi_transposed_F, metadata_colon)
fungi_intestine_F <- filter_data_by_location(fungi_transposed_F, metadata_intestine)
fungi_cecum_F <- filter_data_by_location(fungi_transposed_F, metadata_cecum)
fungi_colon_P <- filter_data_by_location(fungi_transposed_P, metadata_colon)
fungi_intestine_P <- filter_data_by_location(fungi_transposed_P, metadata_intestine)
fungi_cecum_P <- filter_data_by_location(fungi_transposed_P, metadata_cecum)


# **Filter Virus**
virus_colon <- filter_data_by_location(virus_transposed, metadata_colon)
virus_intestine <- filter_data_by_location(virus_transposed, metadata_intestine)
virus_cecum <- filter_data_by_location(virus_transposed, metadata_cecum)
virus_colon_G <- filter_data_by_location(virus_transposed_G, metadata_colon)
virus_intestine_G <- filter_data_by_location(virus_transposed_G, metadata_intestine)
virus_cecum_G <- filter_data_by_location(virus_transposed_G, metadata_cecum)
virus_colon_F <- filter_data_by_location(virus_transposed_F, metadata_colon)
virus_intestine_F <- filter_data_by_location(virus_transposed_F, metadata_intestine)
virus_cecum_F <- filter_data_by_location(virus_transposed_F, metadata_cecum)
virus_colon_P <- filter_data_by_location(virus_transposed_P, metadata_colon)
virus_intestine_P <- filter_data_by_location(virus_transposed_P, metadata_intestine)
virus_cecum_P <- filter_data_by_location(virus_transposed_P, metadata_cecum)

# 3️⃣ **Run Maaslin2 for Each Intestinal Site**
run_maaslin2 <- function(data, metadata, output_dir, label) {
  Maaslin2(
    input_data = data,
    input_metadata = metadata,
    output = paste0(output_dir, "_", label),
    min_prevalence = 0.05,
    fixed_effects = c("Treatment")
  )
}

# **Define output directory**
output_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression"

dir.create(file.path(output_dir, "bacteria_colon"), recursive = TRUE, showWarnings = FALSE)
dir.create(file.path(output_dir, "bacteria_intestine"), recursive = TRUE, showWarnings = FALSE)
dir.create(file.path(output_dir, "bacteria_cecum"), recursive = TRUE, showWarnings = FALSE)
dir.create(file.path(output_dir, "fungi_colon"), recursive = TRUE, showWarnings = FALSE)
dir.create(file.path(output_dir, "fungi_intestine"), recursive = TRUE, showWarnings = FALSE)
dir.create(file.path(output_dir, "fungi_cecum"), recursive = TRUE, showWarnings = FALSE)
dir.create(file.path(output_dir, "virus_colon"), recursive = TRUE, showWarnings = FALSE)
dir.create(file.path(output_dir, "virus_intestine"), recursive = TRUE, showWarnings = FALSE)
dir.create(file.path(output_dir, "virus_cecum"), recursive = TRUE, showWarnings = FALSE)


# Ensure the output directory exists
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)

# 3️⃣ **Run Maaslin2 Individually for Each Dataset**

bacteria_colon <- as.data.frame(bacteria_colon)
metadata_colon

# **Bacteria**

Maaslin2(
  bacteria_colon,
  metadata_colon,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_colon/",
  fixed_effects = c("Treatment")
)


Maaslin2(
  bacteria_intestine,
  metadata_intestine,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_intestine/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  bacteria_cecum,
  metadata_cecum,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_cecum/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  bacteria_colon_G,
  metadata_colon,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_colon_G/",
  fixed_effects = c("Treatment")
)


Maaslin2(
  bacteria_intestine_G,
  metadata_intestine,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_intestine_G/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  bacteria_cecum_G,
  metadata_cecum,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_cecum_G/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  bacteria_colon_F,
  metadata_colon,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_colon_F/",
  fixed_effects = c("Treatment")
)


Maaslin2(
  bacteria_intestine_F,
  metadata_intestine,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_intestine_F/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  bacteria_cecum_F,
  metadata_cecum,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_cecum_F/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  bacteria_colon_P,
  metadata_colon,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_colon_P/",
  fixed_effects = c("Treatment")
)


Maaslin2(
  bacteria_intestine_P,
  metadata_intestine,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_intestine_P/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  bacteria_cecum_P,
  metadata_cecum,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_cecum_P/",
  fixed_effects = c("Treatment")
)

# **Fungi**
Maaslin2(
  fungi_colon,
  metadata_colon,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/fungi_colon/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  fungi_intestine,
  metadata_intestine,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/fungi_intestine/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  fungi_cecum,
  metadata_cecum,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/fungi_cecum/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  fungi_colon_G,
  metadata_colon,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/fungi_colon_G/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  fungi_intestine_G,
  metadata_intestine,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/fungi_intestine_G/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  fungi_cecum_G,
  metadata_cecum,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/fungi_cecum_G/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  fungi_colon_F,
  metadata_colon,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/fungi_colon_F/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  fungi_intestine_F,
  metadata_intestine,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/fungi_intestine_F/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  fungi_cecum_F,
  metadata_cecum,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/fungi_cecum_F/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  fungi_colon_P,
  metadata_colon,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/fungi_colon_P/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  fungi_intestine_P,
  metadata_intestine,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/fungi_intestine_P/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  fungi_cecum_P,
  metadata_cecum,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/fungi_cecum_P/",
  fixed_effects = c("Treatment")
)

# **Virus**
Maaslin2(
  virus_colon,
  metadata_colon,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/virus_colon/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  virus_intestine,
  metadata_intestine,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/virus_intestine/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  virus_cecum,
  metadata_cecum,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/virus_cecum/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  virus_colon_G,
  metadata_colon,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/virus_colon_G/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  virus_intestine_G,
  metadata_intestine,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/virus_intestine_G/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  virus_cecum_G,
  metadata_cecum,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/virus_cecum_G/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  virus_colon_F,
  metadata_colon,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/virus_colon_F/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  virus_intestine_F,
  metadata_intestine,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/virus_intestine_F/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  virus_cecum_F,
  metadata_cecum,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/virus_cecum_F/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  virus_colon_P,
  metadata_colon,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/virus_colon_P/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  virus_intestine_P,
  metadata_intestine,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/virus_intestine_P/",
  fixed_effects = c("Treatment")
)

Maaslin2(
  virus_cecum_P,
  metadata_cecum,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/virus_cecum_P/",
  fixed_effects = c("Treatment")
)

```

#DIFFERENTIAL EXPRESSION MAY 2025 TO LOOK AT DIFF EXP BY LOCATION, STILL FILTERING 80% of TAXA

```{r}

clean_rownames <- function(df) {
  rownames(df) <- gsub("(ZnD5)\\.", "\\1-", rownames(df))
  return(df)
}

# Clean the row names in the four dataframes
bacteria_transposed <- clean_rownames(bacteria_transposed)
bacteria_transposed_G <- clean_rownames(bacteria_transposed_G)
bacteria_transposed_P <- clean_rownames(bacteria_transposed_P)
bacteria_transposed_F <- clean_rownames(bacteria_transposed_F)


library(Maaslin2)
# Set output directory
output_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/"

dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)

# Run Maaslin2 with Location as the fixed effect and intestine as reference
run_location_maaslin2 <- function(data, metadata, tax_level) {
  Maaslin2(
    input_data = data,
    input_metadata = metadata,
    output = file.path(output_dir, paste0("bacteria_", tax_level)),
    fixed_effects = c("Location"),
    #reference = list("Location,intestine"),
    min_prevalence = 0.2
  )
}

metadata_phy_ZnD5
bacteria_transposed
# Run for species, genus, family, phylum
run_location_maaslin2(bacteria_transposed, metadata_phy_ZnD5, "species")
run_location_maaslin2(bacteria_transposed_G, metadata_phy_ZnD5, "genus")
run_location_maaslin2(bacteria_transposed_F, metadata_phy_ZnD5, "family")
run_location_maaslin2(bacteria_transposed_P, metadata_phy_ZnD5, "phylum")
metadata_phy_ZnD5$Location
bacteria_transposed
```

#HEATMAP WITH AGGREGATED COLUMNS BY TREATMENT

```{r}
library(ComplexHeatmap)
library(dplyr)
library(readr)
library(tibble)
library(RColorBrewer)
library(tidyr)

generate_aggregated_location_heatmap <- function(results_path, expression_path, metadata, output_path = NULL, tax_level) {
  
  # 🧼 Clean metadata inside the function
  metadata$Sample <- gsub("\\.", "-", metadata$Sample)
  rownames(metadata) <- gsub("\\.", "-", rownames(metadata))
  metadata$Sample <- gsub("^downsampled_", "", metadata$Sample)
  rownames(metadata) <- metadata$Sample
  metadata <- as_tibble(metadata)
  
  # 📊 Load Maaslin2 results and filter significant taxa
  results_data <- read.delim(results_path)
  sig_taxa <- results_data %>% filter(qval < 0.05) %>% pull(feature)
  
  if (length(sig_taxa) == 0) {
    message("❌ No significant taxa with qval < 0.05.")
    return(NULL)
  }
  
  # 🧬 Load and filter expression matrix
  expr <- read_csv(expression_path, show_col_types = FALSE)
  expr <- column_to_rownames(expr, var = colnames(expr)[1])
  colnames(expr) <- gsub("^downsampled_", "", colnames(expr))
  expr <- expr[rownames(expr) %in% sig_taxa, ]
  
  # 🔗 Match metadata
  original_colnames <- colnames(expr)
  shared_samples <- intersect(original_colnames, metadata$Sample)
  expr <- expr[, shared_samples]
  
  # 🧽 Clean sample names in expression and metadata
  cleaned_colnames <- gsub("^.*?ZnD5-([^-_]+).*", "\\1", shared_samples)
  colnames(expr) <- cleaned_colnames
  
  matched_metadata <- metadata %>%
    dplyr::filter(Sample %in% shared_samples) %>%
    dplyr::mutate(Sample_clean = gsub("^.*?ZnD5-([^-_]+).*", "\\1", Sample)) %>%
    dplyr::select(Sample_clean, Location) %>%
    dplyr::distinct(Sample_clean, .keep_all = TRUE)
  
  shared_cleaned <- gsub("^.*?ZnD5-([^-_]+).*", "\\1", shared_samples)
  matched_metadata <- matched_metadata %>%
    filter(Sample_clean %in% shared_cleaned)
  
  # 🔬 Z-score transformation
  z_scores <- t(apply(expr, 1, function(x) (x - mean(x)) / sd(x)))
  
  z_df <- as.data.frame(z_scores) %>%
    rownames_to_column("Taxon") %>%
    pivot_longer(-Taxon, names_to = "Sample_clean", values_to = "Zscore") %>%
    left_join(matched_metadata, by = "Sample_clean")
  
  # 📈 Aggregate by Location
  z_avg <- z_df %>%
    group_by(Taxon, Location) %>%
    summarise(MeanZ = mean(Zscore, na.rm = TRUE), .groups = "drop") %>%
    pivot_wider(names_from = Location, values_from = MeanZ) %>%
    column_to_rownames("Taxon")
  
  preferred_order <- c("intestine", "cecum", "colon")
  existing_cols <- intersect(preferred_order, colnames(z_avg))
  z_avg <- z_avg[, existing_cols, drop = FALSE]
  
  # 🔥 Generate heatmap
  heatmap_colors <- colorRampPalette(rev(brewer.pal(9, "RdBu")))(100)
  
  heatmap_plot <- Heatmap(
    as.matrix(z_avg),
    name = "Z-score",
    col = heatmap_colors,
    cluster_rows = TRUE,
    cluster_columns = FALSE,
    show_row_names = TRUE,
    show_column_names = TRUE,
    column_order = colnames(z_avg),
    column_title = paste("Bacterial", tax_level),
    column_title_gp = gpar(fontsize = 18, fontface = "bold"),
    row_names_gp = gpar(fontsize = 11),
    column_names_gp = gpar(fontsize = 16, fontface = "bold")
  )
  
  n_rows <- nrow(z_avg)
  height_px <- max(400, n_rows * 20)  # Minimum height of 600 to avoid overly small plots

# Save heatmap to PNG
  if (!is.null(output_path)) {
    png(output_path, width = 700, height = height_px, res = 150)
    draw(heatmap_plot)
    dev.off()
    message("✅ Heatmap saved to ", output_path)
} else {
    draw(heatmap_plot)
}
  
  return(heatmap_plot)
}

```

```{r}
generate_aggregated_location_heatmap(
  results_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/ByLocation/bacteria_species/all_results.tsv",
  expression_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/combined_bacteria_S.csv",
  metadata = metadata_phy_ZnD5,
  output_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/Heatmaps_Location/bacteria_species_location_aggregated_heatmap.png",
  tax_level = "Species"
)

generate_aggregated_location_heatmap(
  results_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/ByLocation/bacteria_genus/all_results.tsv",
  expression_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/combined_bacteria_G.csv",
  metadata = metadata_phy_ZnD5,
  output_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/Heatmaps_Location/bacteria_genus_location_aggregated_heatmap.png",
  tax_level = "Genus"
)

generate_aggregated_location_heatmap(
  results_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/ByLocation/bacteria_family/all_results.tsv",
  expression_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/combined_bacteria_F.csv",
  metadata = metadata_phy_ZnD5,
  output_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/Heatmaps_Location/bacteria_family_location_aggregated_heatmap.png",
  tax_level = "Family"
)

generate_aggregated_location_heatmap(
  results_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/ByLocation/bacteria_phylum/all_results.tsv",
  expression_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/combined_bacteria_P.csv",
  metadata = metadata_phy_ZnD5,
  output_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/Heatmaps_Location/bacteria_phylum_location_aggregated_heatmap.png", 
  tax_level = "Phyla"
)
```

#HEATMAPS WITH AGGREGATED COLUMNS BY TREATMMENT, SEPARATED BY LOCATION 

```{r}
library(ComplexHeatmap)
library(dplyr)
library(readr)
library(tibble)
library(RColorBrewer)
library(tidyr)

generate_heatmap_per_location <- function(results_path, expression_path, metadata, output_path = NULL, tax_level, location_name) {
  
  # 🧼 Clean metadata
  metadata$Sample <- gsub("\\.", "-", metadata$Sample)
  rownames(metadata) <- metadata$Sample
  metadata <- as_tibble(metadata)
  
  # 📊 Load Maaslin2 results and filter significant taxa
  results_data <- read.delim(results_path)
  sig_taxa <- results_data %>% filter(pval < 0.05) %>% pull(feature)
  
  if (length(sig_taxa) == 0) {
    message("❌ No significant taxa with qval < 0.05 for ", location_name)
    return(NULL)
  }
  
  # 🧬 Load and filter expression data
  expr <- read_csv(expression_path, show_col_types = FALSE)
  expr <- column_to_rownames(expr, var = colnames(expr)[1])
  colnames(expr) <- gsub("^downsampled_", "", colnames(expr))
  expr <- expr[rownames(expr) %in% sig_taxa, , drop = FALSE]
  
  # 🔗 Match metadata
  shared_samples <- intersect(colnames(expr), metadata$Sample)
  expr <- expr[, shared_samples]
  metadata <- metadata %>% filter(Sample %in% shared_samples)
  
  # 🧪 Step 1️⃣ Calculate Z-scores **across ALL samples**
  z_scores <- t(apply(expr, 1, function(x) (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)))
  z_scores <- as.data.frame(z_scores)
  rownames(z_scores) <- rownames(expr)
  
  # 🗂️ Melt Z-scores into long format
  z_df <- z_scores %>%
    rownames_to_column("Taxon") %>%
    pivot_longer(-Taxon, names_to = "Sample", values_to = "Zscore") %>%
    left_join(metadata, by = c("Sample"))
  
  # 🔎 Filter samples to current location
  z_df <- z_df %>%
    filter(Location == location_name)
  
  if (nrow(z_df) == 0) {
    message("❌ No samples in ", location_name)
    return(NULL)
  }
  
  # 🧪 Step 2️⃣ Average Z-scores by Treatment within that location
  z_avg <- z_df %>%
    group_by(Taxon, Treatment) %>%
    summarise(MeanZ = mean(Zscore, na.rm = TRUE), .groups = "drop") %>%
    pivot_wider(names_from = Treatment, values_from = MeanZ) %>%
    column_to_rownames("Taxon")
  
  # 🔥 Define a consistent color gradient
  heatmap_colors <- colorRampPalette(rev(brewer.pal(9, "RdBu")))(100)
  
  # 📊 Generate heatmap
  heatmap_plot <- Heatmap(
    as.matrix(z_avg),
    name = "Z-score",
    col = heatmap_colors,
    cluster_rows = TRUE,
    cluster_columns = FALSE,
    show_row_names = TRUE,
    show_column_names = TRUE,
    column_title = paste("", tax_level, "in", location_name),
    column_title_gp = gpar(fontsize = 18, fontface = "bold"),
    row_names_gp = gpar(fontsize = 11),
    column_names_gp = gpar(fontsize = 16, fontface = "bold")
  )
  
  # Save PNG
  n_rows <- nrow(z_avg)
  height_px <- max(400, n_rows * 30)
  
  if (!is.null(output_path)) {
    png(output_path, width = 700, height = height_px, res = 150)
    draw(heatmap_plot)
    dev.off()
    message("✅ Heatmap saved to ", output_path)
  } else {
    draw(heatmap_plot)
  }
  
  return(heatmap_plot)
}


# === Main Script ===
metadata_ZnD5$Sample <- gsub("ZnD5\\.", "ZnD5-", metadata_ZnD5$Sample)

base_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression"
output_dir <- file.path(base_dir, "Heatmaps_Treatment")
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)

tax_levels <- c(
  S = "Species",
  G = "Genus",
  F = "Family",
  P = "Phylum"
)
locations <- c("intestine", "cecum", "colon")

for (tax_suffix in names(tax_levels)) {
  tax_level <- tax_levels[[tax_suffix]]
  
  for (loc in locations) {
    folder_name <- if (tax_suffix == "S") {
      paste0("bacteria_", loc)
    } else {
      paste0("bacteria_", loc, "_", tax_suffix)
    }
    
    results_path <- file.path(base_dir, folder_name, "all_results.tsv")
    expression_path <- file.path(base_dir, folder_name, paste0("combined_bacteria_", tax_suffix, ".csv"))
    output_path <- file.path(output_dir, paste0("heatmap_", tax_level, "_", loc, ".png"))
    
    generate_heatmap_per_location(
      results_path = results_path,
      expression_path = expression_path,
      metadata = metadata_ZnD5,
      output_path = output_path,
      tax_level = tax_level,
      location_name = loc
    )
  }
}

```

#MAY 28, 2025 BOXPLOTS FOR DIFF EXPRESSED TAXA USING TSS SCALING. DONE AT THE SPECIES LEVEL

```{r}
library(tidyverse)
library(ggpubr)

generate_tss_boxplot <- function(expression_file, results_file, metadata, location_name, output_path) {
  
  # Clean metadata
  metadata <- metadata %>%
    mutate(Sample = gsub("^downsampled_", "", Sample),
           Sample = gsub("\\.", "-", Sample))

  meta_loc <- metadata %>% filter(Location == location_name)

  # Load DE results and significant taxa
  results <- read.delim(results_file)
  sig_taxa <- results %>% filter(pval < 0.05) %>% pull(feature)

  # Load expression matrix
  expr <- read_csv(expression_file, show_col_types = FALSE)
  expr <- expr %>% column_to_rownames(var = colnames(expr)[1])
  colnames(expr) <- gsub("^downsampled_", "", colnames(expr))

  # Subset matrix
  expr <- expr[rownames(expr) %in% sig_taxa, meta_loc$Sample, drop = FALSE]

  # Normalize
  expr_tss <- sweep(expr, 2, colSums(expr), "/")
  expr_log <- log10(expr_tss + 1e-5)

  # Melt
  expr_log$Taxa <- rownames(expr_log)
  melted <- expr_log %>%
    pivot_longer(-Taxa, names_to = "Sample", values_to = "Reads") %>%
    left_join(meta_loc, by = "Sample")

  # Filter out taxa with all zeros in any treatment group
  taxa_with_data <- melted %>%
    group_by(Taxa, Treatment) %>%
    summarise(nonzero = any(Reads > -5), .groups = "drop") %>%
    pivot_wider(names_from = Treatment, values_from = nonzero, values_fill = FALSE) %>%
    filter(ZnA & ZnD) %>%
    pull(Taxa)

  melted <- melted %>% filter(Taxa %in% taxa_with_data)

  # Add log2FC for sorting
  fc_lookup <- results %>% select(feature, coef)
  colnames(fc_lookup) <- c("Taxa", "log2FC")
  melted <- left_join(melted, fc_lookup, by = "Taxa")
  melted$Taxa <- fct_reorder(melted$Taxa, melted$log2FC, .desc = FALSE)

  # Plot
  plot <- ggplot(melted, aes(x = Taxa, y = Reads, fill = Treatment)) +
    geom_boxplot(position = position_dodge(width = 0.8), width = 0.8, outlier.shape = NA) +
    geom_jitter(width = 0.15, alpha = 0.5, size = 1.5) +
    scale_fill_manual(values = c("ZnD" = "#E8B31A", "ZnA" = "#75AE33")) +
    labs(
      title = location_name,
      x = "Taxa",
      y = "Log10 Relative Abundance"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      plot.margin = margin(t = 10, r = 10, b = 10, l = 30),
      plot.title = element_text(size = 20, face = "bold"),
      plot.subtitle = element_text(size = 14),
      axis.title.x = element_text(size = 14, face = "bold"),
      axis.title.y = element_text(size = 14, face = "bold"),
      axis.text.x = element_text(angle = 45, hjust = 1, face = "bold", color = "black"),
      axis.text.y = element_text(size = 12),
      legend.position = "none"
    )

  ggsave(output_path, plot, width = 4.5, height = 6, dpi = 300) #EXPORT PARAMETERS WERE ADJUSTED TO 4.5 FOR THE INTESTINE AND CECUM
  return(plot)
}

# Run for genus and species


generate_tss_boxplot(
  expression_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/combined_bacteria_S.csv",
  results_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_colon/all_results.tsv",
  metadata = metadata_ZnD5,
  location_name = "colon",
  output_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/bacteria_species_colon_boxplot.png"
)

generate_tss_boxplot(
  expression_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/combined_bacteria_S.csv",
  results_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_intestine/all_results.tsv",
  metadata = metadata_ZnD5,
  location_name = "intestine",
  output_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/bacteria_species_intestine_boxplot.png"
)

generate_tss_boxplot(
  expression_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/combined_bacteria_S.csv",
  results_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_cecum/all_results.tsv",
  metadata = metadata_ZnD5,
  location_name = "cecum",
  output_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/bacteria_species_cecum_boxplot.png"
)



```
#MAY 28, 2025 BOXPLOTS FOR DIFF EXPRESSED TAXA USING TSS SCALING. DONE AT THE GENUS LEVEL

```{r}
library(tidyverse)
library(ggpubr)

generate_tss_boxplot <- function(expression_file, results_file, metadata, location_name, output_path) {
  
  # Clean metadata
  metadata <- metadata %>%
    mutate(Sample = gsub("^downsampled_", "", Sample),
           Sample = gsub("\\.", "-", Sample))

  meta_loc <- metadata %>% filter(Location == location_name)

  # Load DE results and significant taxa
  results <- read.delim(results_file)
  sig_taxa <- results %>% filter(pval < 0.05) %>% pull(feature)

  # Load expression matrix
  expr <- read_csv(expression_file, show_col_types = FALSE)
  expr <- expr %>% column_to_rownames(var = colnames(expr)[1])
  colnames(expr) <- gsub("^downsampled_", "", colnames(expr))

  # Subset matrix
  expr <- expr[rownames(expr) %in% sig_taxa, meta_loc$Sample, drop = FALSE]

  # Normalize
  expr_tss <- sweep(expr, 2, colSums(expr), "/")
  expr_log <- log10(expr_tss + 1e-5)

  # Melt
  expr_log$Taxa <- rownames(expr_log)
  melted <- expr_log %>%
    pivot_longer(-Taxa, names_to = "Sample", values_to = "Reads") %>%
    left_join(meta_loc, by = "Sample")

  # Filter out taxa with all zeros in any treatment group
  taxa_with_data <- melted %>%
    group_by(Taxa, Treatment) %>%
    summarise(nonzero = any(Reads > -5), .groups = "drop") %>%
    pivot_wider(names_from = Treatment, values_from = nonzero, values_fill = FALSE) %>%
    filter(ZnA & ZnD) %>%
    pull(Taxa)

  melted <- melted %>% filter(Taxa %in% taxa_with_data)

  # Add log2FC for sorting
  fc_lookup <- results %>% select(feature, coef)
  colnames(fc_lookup) <- c("Taxa", "log2FC")
  melted <- left_join(melted, fc_lookup, by = "Taxa")
  melted$Taxa <- fct_reorder(melted$Taxa, melted$log2FC, .desc = FALSE)

  # Plot
  plot <- ggplot(melted, aes(x = Taxa, y = Reads, fill = Treatment)) +
    geom_boxplot(position = position_dodge(width = 0.8), width = 0.8, outlier.shape = NA) +
    geom_jitter(width = 0.15, alpha = 0.5, size = 1.5) +
    scale_fill_manual(values = c("ZnD" = "#E8B31A", "ZnA" = "#75AE33")) +
    labs(
      title = location_name,
      x = "Taxa",
      y = "Log10 Relative Abundance"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      plot.margin = margin(t = 10, r = 10, b = 10, l = 30),
      plot.title = element_text(size = 20, face = "bold"),
      plot.subtitle = element_text(size = 14),
      axis.title.x = element_text(size = 14, face = "bold"),
      axis.title.y = element_text(size = 14, face = "bold"),
      axis.text.x = element_text(angle = 45, hjust = 1, face = "bold", color = "black"),
      axis.text.y = element_text(size = 12),
      legend.position = "none"
    )

  ggsave(output_path, plot, width = 2.25, height = 6, dpi = 300)
  return(plot)
}

# Run for genus and species


generate_tss_boxplot(
  expression_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/combined_bacteria_G.csv",
  results_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_colon_G/all_results.tsv",
  metadata = metadata_ZnD5,
  location_name = "colon",
  output_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/bacteria_colon_boxplot_G.png"
)

generate_tss_boxplot(
  expression_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/combined_bacteria_G.csv",
  results_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_intestine_G/all_results.tsv",
  metadata = metadata_ZnD5,
  location_name = "intestine",
  output_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/bacteria_intestine_boxplot_G.png"
)

generate_tss_boxplot(
  expression_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/combined_bacteria_G.csv",
  results_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_cecum_G/all_results.tsv",
  metadata = metadata_ZnD5,
  location_name = "cecum",
  output_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/bacteria_cecum_boxplot_G.png"
)



```

#BOXPLOTS FOR DIFF EXPRESSED TAXA

```{r}
library(ggplot2)
library(dplyr)
library(readr)
library(tidyr)
library(forcats)
library(ggpubr)

generate_boxplot_by_location <- function(expression_file, results_file, metadata, location_name, output_path) {
  
  # Clean metadata
  metadata <- metadata %>%
    mutate(
      Sample = gsub("^downsampled_", "", Sample),
      Sample = gsub("\\.", "-", Sample)
    )

  # Filter metadata for the specific location
  meta_loc <- metadata %>%
    filter(Location == location_name)

  # Load DE results and extract significant taxa
  results <- read.delim(results_file)
  sig_taxa <- results %>%
    filter(pval < 0.05) %>%
    pull(feature)

  # Load and clean expression matrix
  expr <- read_csv(expression_file, show_col_types = FALSE)
  expr <- expr %>%
    column_to_rownames(var = colnames(expr)[1])
  colnames(expr) <- gsub("^downsampled_", "", colnames(expr))

  # Subset expression matrix to significant taxa and samples in location
  expr <- expr[rownames(expr) %in% sig_taxa, meta_loc$Sample, drop = FALSE]

  # Convert to long format
  expr_long <- expr %>%
    t() %>%
    as.data.frame() %>%
    rownames_to_column("Sample") %>%
    pivot_longer(-Sample, names_to = "Taxa", values_to = "PercentReads") %>%
    left_join(meta_loc, by = "Sample")

  # Remove taxa that are not present in both treatment groups (ZnA & ZnD)
  taxa_with_data_in_both <- expr_long %>%
    group_by(Taxa, Treatment) %>%
    summarise(has_data = sum(PercentReads > 0, na.rm = TRUE) > 1, .groups = "drop") %>%
    group_by(Taxa) %>%
    summarise(n_groups = sum(has_data), .groups = "drop") %>%
    filter(n_groups == 2) %>%
    pull(Taxa)

  expr_long <- expr_long %>%
    filter(Taxa %in% taxa_with_data_in_both)

  # Plot
  p <- ggplot(expr_long, aes(x = fct_reorder(Taxa, PercentReads, .fun = median, na.rm = TRUE),
                             y = PercentReads, fill = Treatment)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.85, na.rm = TRUE) +
    stat_compare_means(
      comparisons = list(c("ZnA", "ZnD")), 
      method = "wilcox.test", 
      label = "p.signif")+
    scale_y_log10(labels = scales::comma, limits = c(1, NA)) +
    scale_fill_manual(values = c("ZnA" = "#75AE33", "ZnD" = "#E8B31A")) +
    labs(
      title = location_name,
      subtitle = paste("Differentially Expressed Taxa"),
      x = "Taxa",
      y = "Percentage Reads (Log Scale)"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, face = "bold"),
      plot.title = element_text(size = 22, face = "bold"),
      plot.subtitle = element_text(size = 16),
      legend.position = "right"
    )

  # Save and show plot
  ggsave(output_path, p, width = 6, height = 6)
  print(p)
}


generate_boxplot_by_location(
  expression_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/combined_bacteria_S.csv",
  results_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_colon/all_results.tsv",
  metadata = metadata_ZnD5,
  location_name = "colon",
  output_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/boxplot_bacteria_colon.png"
)

generate_boxplot_by_location(
  expression_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/combined_bacteria_S.csv",
  results_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_intestine/all_results.tsv",
  metadata = metadata_phy_ZnD5,
  location_name = "intestine",
  output_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/boxplot_bacteria_intestine.png"
)

generate_boxplot_by_location(
  expression_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/combined_bacteria_S.csv",
  results_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_cecum/all_results.tsv",
  metadata = metadata_phy_ZnD5,
  location_name = "cecum",
  output_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/boxplot_bacteria_cecum.png"
)

```


```{r}
library(ggplot2)
library(dplyr)
library(readr)
library(tidyr)
library(forcats)

# Function to generate boxplots for each GI location
generate_boxplot_by_location <- function(expression_file, results_file, metadata, location_name, output_path) {
  
  # Clean metadata
  metadata <- metadata_phy_ZnD5
  metadata$Sample <- gsub("\\.", "-", metadata$Sample)
  metadata$Sample <- gsub("^downsampled_", "", metadata$Sample)
  
  # Filter metadata for location
  meta_loc <- metadata %>% filter(Location == location_name)
  
  # Load DE results
  results <- read.delim(results_file)
  sig_taxa <- results %>% filter(pval < 0.05) %>% pull(feature)
  
  # Load expression data
  expr <- read_csv(expression_file, show_col_types = FALSE)
  expr <- column_to_rownames(expr, var = colnames(expr)[1])
  colnames(expr) <- gsub("^downsampled_", "", colnames(expr))
  
  # Subset by taxa and sample
  expr <- expr[rownames(expr) %in% sig_taxa, meta_loc$Sample, drop = FALSE]
  
  # Long format for ggplot
  expr_long <- as.data.frame(t(expr)) %>%
    rownames_to_column("Sample") %>%
    pivot_longer(-Sample, names_to = "Taxa", values_to = "PercentReads") %>%
    left_join(meta_loc, by = "Sample")
  
  # Plot
  p <- ggplot(expr_long, aes(x = fct_reorder(Taxa, PercentReads, .fun = median), y = PercentReads, fill = Treatment)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.85) +
    scale_y_log10() +
    scale_fill_manual(values = c("ZnA" = "#56B4E9", "ZnD" = "#E8B31A")) +
    labs(
      title = location_name,
      subtitle = paste("Differentially Expressed Taxa in", tolower(location_name), "- bacteria"),
      x = "Taxa",
      y = "Percentage Reads (Log Scale)"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      plot.title = element_text(size = 22, face = "bold"),
      plot.subtitle = element_text(size = 16),
      legend.position = "right"
    )
  
  ggsave(output_path, p, width = 12, height = 6)
  print(p)
}

# 🧪 Call the function for each GI site
generate_boxplot_by_location(
  expression_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/combined_bacteria_S.csv",
  results_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_colon/all_results.tsv",
  metadata = metadata_phy_ZnD5,
  location_name = "colon",
  output_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/boxplot_bacteria_colon.png"
)

generate_boxplot_by_location(
  expression_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/combined_bacteria_S.csv",
  results_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_intestine/all_results.tsv",
  metadata = metadata_phy_ZnD5,
  location_name = "intestine",
  output_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/boxplot_bacteria_intestine.png"
)

generate_boxplot_by_location(
  expression_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/combined_bacteria_S.csv",
  results_file = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_cecum/all_results.tsv",
  metadata = metadata_phy_ZnD5,
  location_name = "cecum",
  output_path = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/boxplot_bacteria_cecum.png"
)

```


```{r}
metadata <- metadata_phy_ZnD5
metadata$Sample <- gsub("\\.", "-", metadata$Sample)
metadata$Sample <- gsub("^downsampled_", "", metadata$Sample)
metadata 
  # Filter metadata for location
meta_loc <- metadata %>% filter(Location == "colon")
  
  # Load DE results
results <- read.delim("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_intestine/all_results.tsv")
sig_taxa <- results %>% filter(pval < 0.05) %>% pull(feature)

  # Load expression data
expr <- read_csv("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Differential_Expression_May2025/combined_bacteria_S.csv", show_col_types = FALSE)
expr <- column_to_rownames(expr, var = colnames(expr)[1])
colnames(expr) <- gsub("^downsampled_", "", colnames(expr))

  # Subset by taxa and sample
expr <- expr[rownames(expr) %in% sig_taxa, meta_loc$Sample, drop = FALSE]
expr  
  # Long format for ggplot
expr_long <- as.data.frame(t(expr)) %>%
  rownames_to_column("Sample") %>%
  pivot_longer(-Sample, names_to = "Taxa", values_to = "PercentReads") %>%
  left_join(meta_loc, by = "Sample")
expr  
  # Plot
p <- ggplot(expr_long, aes(x = fct_reorder(Taxa, PercentReads, .fun = median), y = PercentReads, fill = Treatment)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.85) +
    scale_y_log10() +
    scale_fill_manual(values = c("ZnA" = "#56B4E9", "ZnD" = "#E8B31A")) +
    labs(
      title = "colon",
      subtitle = paste("Differentially Expressed Taxa in", tolower("colon"), "- bacteria"),
      x = "Taxa",
      y = "Percentage Reads (Log Scale)"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      plot.title = element_text(size = 22, face = "bold"),
      plot.subtitle = element_text(size = 16),
      legend.position = "right"
    )
  
  ggsave(output_path, p, width = 12, height = 6)
  print(p)
}

```


```{r}
dir.exists(output_dir)
dir.create(file.path(output_dir, "DifferentialExpression_virus_cecum"), recursive = TRUE)

log_transformed_data <- log10(bacteria_transposed + 1)
log_transformed_data <- as.data.frame(log_transformed_data)
log_transformed_data

colnames(log_transformed_data)

unique(data_long$Taxa)

data_long %>%
  filter(Taxa == "Bacteroides caecimuris") %>%
  mutate(log_abundance = log10(Read_Percentage + 1)) %>%
  group_by(Treatment) %>%
  summarise(mean_log_abundance = mean(log_abundance, na.rm = TRUE))


data_long %>%
  filter(Taxa == "Bacteroides caecimuris") %>%
  group_by(Treatment) %>%
  summarise(sd_log_abundance = sd(log10(Read_Percentage + 1)))



data_long %>%
  filter(Taxa == "Bacteroides caecimuris") %>%
  group_by(Treatment) %>%
  summarise(mean_log_abundance = mean(log_transformed_data["Bacteroides caecimuris", ]))

ggplot(data_long %>% filter(Taxa == "Bacteroides caecimuris"), 
       aes(x = Treatment, y = log10(Read_Percentage + 1), fill = Treatment)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  theme_minimal() +
  labs(title = "Log Abundance of Bacteroides caecimuris", y = "Log10 Abundance", x = "Treatment")

```





#GENERATE HEATMAPS FOR BACTERIA, FUNGI, AND VIRUSES, SEPARATED BY LOCATION SELECTING THE TOP 30 MOST SIGNIFICANT DIFFERENTIALLY EXPRESSED TAXA FROM MAASLIN2

#HEATMAPS MADE BY LOCATION
```{r}
# Load required libraries
library(ComplexHeatmap)
library(RColorBrewer)
library(dplyr)
library(readr)
library(tibble)

# Define base path where new results are stored
base_path <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression"

# Define new heatmap output directory
heatmap_output_dir <- file.path(base_path, "Heatmaps_Location")
dir.create(heatmap_output_dir, showWarnings = FALSE, recursive = TRUE)

# Load metadata
metadata <- metadata_phy_ZnD5

# Function to generate heatmap for Location-based differential expression
generate_location_heatmap <- function(results_path, expression_path, output_name) {
  
  cat("\nProcessing:", results_path, "\n")
  
  if (!file.exists(results_path)) {
    cat("❌ Skipping:", results_path, "- File not found\n")
    return(NULL)
  }
  
  # Load significant taxa
  results_data <- read.delim(results_path)
  
  # Clean taxa names
  results_data$feature <- gsub("\\.", " ", results_data$feature)
  
  # Select significant taxa (pval < 0.05)
  significant_taxa <- results_data %>%
    filter(pval < 0.05) %>%
    pull(feature)
  
  cat("✔ Found", length(significant_taxa), "significant taxa\n")
  
  if (length(significant_taxa) == 0) {
    cat("❌ No significant taxa - skipping", output_name, "\n")
    return(NULL)
  }
  
  # Load expression data
  expression_data <- read_csv(expression_path) %>%
    column_to_rownames(var = colnames(.)[1])
  
  # Filter expression data for significant taxa
  expression_data <- expression_data[rownames(expression_data) %in% significant_taxa, , drop = FALSE]
  
  if (nrow(expression_data) == 0) {
    cat("❌ No matching taxa in expression data - skipping", output_name, "\n")
    return(NULL)
  }
  
  # Convert to matrix and compute Z-scores
  compute_zscore <- function(mat) {
    apply(mat, 1, function(x) (x - mean(x)) / sd(x))
  }
  
  z_score_data <- t(compute_zscore(as.matrix(expression_data)))
  
  # Clean sample names if needed (optional depending on your samples)
  # colnames(z_score_data) <- sub("^(\\d+_ZnD5\\.[A-Za-z]+\\d+).*", "\\1", colnames(z_score_data))
  
  # Match sample names with metadata
  sample_metadata <- metadata[colnames(z_score_data), , drop = FALSE]
  
  if (nrow(sample_metadata) == 0) {
    cat("❌ No matching sample names in metadata\n")
    return(NULL)
  }
  
  # Order samples by Location
  sample_metadata$Sample <- colnames(z_score_data)
  ordered_samples <- sample_metadata %>%
    arrange(factor(Location)) %>%
    pull(Sample)
  
  z_score_data <- z_score_data[, ordered_samples]
  
  # Color palettes
  location_colors <- c(
    "Colon" = "#56B4E9", 
    "Intestine" = "#E8B31A", 
    "Cecum" = "#75AE33"
  )
  
  column_annot <- HeatmapAnnotation(
    Location = factor(sample_metadata$Location, levels = names(location_colors)),
    col = list(Location = location_colors),
    annotation_name_side = "left"
  )
  
  heatmap_colors <- colorRampPalette(rev(brewer.pal(9, "RdBu")))(100)
  
  # Generate heatmap
  heatmap_plot <- Heatmap(
    z_score_data,
    name = "Z-score",
    col = heatmap_colors,
    cluster_rows = FALSE,
    column_split = sample_metadata$Location,
    cluster_columns = FALSE,
    show_row_names = TRUE,
    show_column_names = TRUE,
    row_names_side = "left",
    column_title = paste("Differential by Location:", output_name),
    top_annotation = column_annot,
    column_names_gp = gpar(fontsize = 12, fontface = "bold"),
    row_names_gp = gpar(fontsize = 12, fontface = "bold"),
    column_title_gp = gpar(fontsize = 16, fontface = "bold"),
    heatmap_legend_param = list(title = "Z-score",
                                title_gp = gpar(fontsize = 14, fontface = "bold"),
                                labels_gp = gpar(fontsize = 12, fontface = "bold"))
  )
  
  # Save heatmap
  output_file <- file.path(heatmap_output_dir, paste0("heatmap_location_", output_name, ".png"))
  png(output_file, width = 1200, height = 900, res = 150)
  draw(heatmap_plot)
  dev.off()
  
  cat("✅ Heatmap generated for:", output_name, "\n")
}

# === CALL THE FUNCTIONS ===

generate_location_heatmap(
  results_path = file.path(base_path, "masalin_results_bacteria_S_location/all_results.tsv"),
  expression_path = file.path(base_path, "combined_bacteria_S.csv"),
  output_name = "bacteria_S_location"
)

generate_location_heatmap(
  results_path = file.path(base_path, "masalin_results_bacteria_G_location/all_results.tsv"),
  expression_path = file.path(base_path, "combined_bacteria_G.csv"),
  output_name = "bacteria_G_location"
)

generate_location_heatmap(
  results_path = file.path(base_path, "masalin_results_bacteria_F_location/all_results.tsv"),
  expression_path = file.path(base_path, "combined_bacteria_F.csv"),
  output_name = "bacteria_F_location"
)

generate_location_heatmap(
  results_path = file.path(base_path, "masalin_results_bacteria_P_location/all_results.tsv"),
  expression_path = file.path(base_path, "combined_bacteria_P.csv"),
  output_name = "bacteria_P_location"
)

metadata_phy_ZnD5
combined_bacteria_S
```

```{r}
setdiff(colnames(combined_bacteria_S), rownames(metadata_phy_ZnD5))  # should return character(0)
setdiff(rownames(metadata_phy_ZnD5), colnames(combined_bacteria_S))  

metadata_phy_ZnD5

combined_bacteria_S

generate_heatmap(
  results_path = file.path(base_path, "masalin_results_bacteria_S_location/all_results.tsv"),
  expression_data_input = combined_bacteria_S,
  output_name = "bacteria_S_location"
)
```

```{r}
# Load required libraries
library(ComplexHeatmap)
library(RColorBrewer)
library(dplyr)
library(readr)
library(tibble)

# Define base path where new results are stored
base_path <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression"

# Define new heatmap output directory
heatmap_output_dir <- file.path(base_path, "Heatmaps_Location")
dir.create(heatmap_output_dir, showWarnings = FALSE, recursive = TRUE)

# Load metadata
metadata <- metadata_phy_ZnD5
# Clean up sample names by removing "downsampled_" prefix
rownames(metadata) <- gsub("^downsampled_", "", rownames(metadata))


# Function to generate heatmap for Location-based differential expression
generate_location_heatmap <- function(results_path, expression_path, output_name) {
  
  cat("\nProcessing:", results_path, "\n")
  
  if (!file.exists(results_path)) {
    cat("❌ Skipping:", results_path, "- File not found\n")
    return(NULL)
  }
  
  # Load significant taxa
  results_data <- read.delim(results_path)
  
  # Clean taxa names
  results_data$feature <- gsub("\\.", " ", results_data$feature)
  
  # Select significant taxa (pval < 0.05)
  significant_taxa <- results_data %>%
    filter(pval < 0.05) %>%
    pull(feature)
  
  cat("✔ Found", length(significant_taxa), "significant taxa\n")
  
  if (length(significant_taxa) == 0) {
    cat("❌ No significant taxa - skipping", output_name, "\n")
    return(NULL)
  }
  
  # Load expression data
  expression_data <- read_csv(expression_path) %>%
    column_to_rownames(var = colnames(.)[1])
  
  # Filter expression data for significant taxa
  expression_data <- expression_data[rownames(expression_data) %in% significant_taxa, , drop = FALSE]
  
  if (nrow(expression_data) == 0) {
    cat("❌ No matching taxa in expression data - skipping", output_name, "\n")
    return(NULL)
  }
  
  # Convert to matrix and compute Z-scores
  compute_zscore <- function(mat) {
    apply(mat, 1, function(x) (x - mean(x)) / sd(x))
  }
  
  z_score_data <- t(compute_zscore(as.matrix(expression_data)))
  
  # Clean sample names if needed (optional depending on your samples)
  # colnames(z_score_data) <- sub("^(\\d+_ZnD5\\.[A-Za-z]+\\d+).*", "\\1", colnames(z_score_data))
  
  # Match sample names with metadata
  sample_metadata <- metadata[colnames(z_score_data), , drop = FALSE]
  
  if (nrow(sample_metadata) == 0) {
    cat("❌ No matching sample names in metadata\n")
    return(NULL)
  }
  
  # Order samples by Location
  sample_metadata$Sample <- colnames(z_score_data)
  ordered_samples <- sample_metadata %>%
    arrange(factor(Location)) %>%
    pull(Sample)
  
  z_score_data <- z_score_data[, ordered_samples]
  
  # Color palettes
  location_colors <- c(
    "colon" = "#D55E00",
  "intestine" = "#56B4E9",
  "cecum" = "#009E73"
  )
  
  column_annot <- HeatmapAnnotation(
    Location = factor(sample_metadata$Location, levels = names(location_colors)),
    col = list(Location = location_colors),
    annotation_name_side = "left"
  )
  
  heatmap_colors <- colorRampPalette(rev(brewer.pal(9, "RdBu")))(100)
  
  # Generate heatmap
  heatmap_plot <- Heatmap(
    z_score_data,
    name = "Z-score",
    col = heatmap_colors,
    cluster_rows = FALSE,
    column_split = sample_metadata$Location,
    cluster_columns = FALSE,
    show_row_names = TRUE,
    show_column_names = TRUE,
    row_names_side = "left",
    column_title = paste("Differential by Location:", output_name),
    top_annotation = column_annot,
    column_names_gp = gpar(fontsize = 12, fontface = "bold"),
    row_names_gp = gpar(fontsize = 12, fontface = "bold"),
    column_title_gp = gpar(fontsize = 16, fontface = "bold"),
    heatmap_legend_param = list(title = "Z-score",
                                title_gp = gpar(fontsize = 14, fontface = "bold"),
                                labels_gp = gpar(fontsize = 12, fontface = "bold"))
  )
  
  # Save heatmap
  output_file <- file.path(heatmap_output_dir, paste0("heatmap_location_", output_name, ".png"))
  png(output_file, width = 1200, height = 900, res = 150)
  draw(heatmap_plot)
  dev.off()
  
  cat("✅ Heatmap generated for:", output_name, "\n")
}

# === CALL THE FUNCTIONS ===

generate_location_heatmap(
  results_path = file.path(base_path, "masalin_results_bacteria_S_location/all_results.tsv"),
  expression_path = file.path(base_path, "combined_bacteria_S.csv"),
  output_name = "bacteria_S_location"
)

generate_location_heatmap(
  results_path = file.path(base_path, "masalin_results_bacteria_G_location/all_results.tsv"),
  expression_path = file.path(base_path, "combined_bacteria_G.csv"),
  output_name = "bacteria_G_location"
)

generate_location_heatmap(
  results_path = file.path(base_path, "masalin_results_bacteria_F_location/all_results.tsv"),
  expression_path = file.path(base_path, "combined_bacteria_F.csv"),
  output_name = "bacteria_F_location"
)

generate_location_heatmap(
  results_path = file.path(base_path, "masalin_results_bacteria_P_location/all_results.tsv"),
  expression_path = file.path(base_path, "combined_bacteria_P.csv"),
  output_name = "bacteria_P_location"
)

combined_bacteria_F

```



#GENERATE THE HEATMAP FROM TEH DE RESULTS, BUT ALSO BY GROUPING ZNA AND ZND SAMPLES AND TAKING THE AVERAGE OF THEM

```{r}
library(ComplexHeatmap)
library(RColorBrewer)
library(dplyr)
library(readr)
library(tibble)
library(tidyr)
library(ggplot2)

# Base path
base_path <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression"
heatmap_output_dir <- file.path(base_path, "Heatmaps")
dir.create(heatmap_output_dir, showWarnings = FALSE, recursive = TRUE)

# Load metadata (adjust this as needed)
metadata <- metadata_phy_ZnD5

# Function
generate_heatmap <- function(results_path, expression_path, output_name) {
  
  cat("Processing:", output_name, "\n")
  
  # Check for results file
  if (!file.exists(results_path)) {
    cat("❌ Skipping:", results_path, "- File not found\n")
    return(NULL)
  }

  # Load and filter significant taxa
  results_data <- read.delim(results_path)
  results_data$feature <- gsub("\\.", " ", results_data$feature)
  significant_taxa <- results_data %>%
    filter(pval < 0.05) %>%
    pull(feature)
  
  if (length(significant_taxa) == 0) {
    cat("❌ No significant taxa found in results:", output_name, "\n")
    return(NULL)
  }

  cat("✔ Found", length(significant_taxa), "significant taxa\n")

  # Load expression data
  if (!file.exists(expression_path)) {
    cat("❌ Skipping:", expression_path, "- Expression data not found\n")
    return(NULL)
  }

  expression_data <- read_csv(expression_path) %>%
    column_to_rownames(var = colnames(.)[1])

  # Filter by significant taxa
  expression_data <- expression_data[rownames(expression_data) %in% significant_taxa, , drop = FALSE]
  if (nrow(expression_data) == 0) {
    cat("❌ No matching taxa in expression data for:", output_name, "\n")
    return(NULL)
  }

  # Compute Z-scores
  compute_zscore <- function(mat) {
    apply(mat, 1, function(x) (x - mean(x)) / sd(x))
  }
  z_score_data <- t(compute_zscore(as.matrix(expression_data)))

  # Clean column names (e.g., 01_ZnD5.CL1 from 01_ZnD5.CL1_10478_R1)
  colnames(z_score_data) <- sub("^(\\d+_ZnD5\\.[A-Za-z]+\\d+).*", "\\1", colnames(z_score_data))

  # Match metadata
  sample_treatments <- metadata[colnames(z_score_data), , drop = FALSE]
  sample_treatments$Sample <- colnames(z_score_data)

  # Reshape + merge
  z_score_long <- as.data.frame(z_score_data) %>%
    rownames_to_column("Taxa") %>%
    pivot_longer(-Taxa, names_to = "Sample", values_to = "Z") %>%
    left_join(sample_treatments, by = c("Sample" = "Sample"))

  # Compute mean Z-score per treatment
  z_summary <- z_score_long %>%
    group_by(Taxa, Treatment) %>%
    summarise(mean_z = mean(Z, na.rm = TRUE), .groups = "drop") %>%
    pivot_wider(names_from = Treatment, values_from = mean_z)

  # Convert to matrix
  z_summary_matrix <- as.matrix(z_summary[, -1])
  rownames(z_summary_matrix) <- z_summary$Taxa

  # Heatmap colors
  heatmap_colors <- colorRampPalette(rev(brewer.pal(9, "RdBu")))(100)

  # Plot heatmap with 2 columns: ZnD and ZnA
  heatmap_plot <- Heatmap(
    z_summary_matrix,
    name = "Mean Z-score",
    col = heatmap_colors,
    cluster_rows = TRUE,
    cluster_columns = FALSE,
    show_row_names = TRUE,
    show_column_names = TRUE,
    column_names_gp = gpar(fontsize = 14, fontface = "bold"),
    row_names_gp = gpar(fontsize = 12, fontface = "bold"),
    column_title = paste("", output_name),
    column_title_gp = gpar(fontsize = 16, fontface = "bold"),
    heatmap_legend_param = list(
      title = "Z-score",
      title_gp = gpar(fontsize = 14, fontface = "bold"),
      labels_gp = gpar(fontsize = 12)
    )
  )
  

  # Save
  output_file <- file.path(heatmap_output_dir, paste0("heatmap_meanZ_", output_name, ".png"))
  png(output_file, width = 900, height = 450, res = 150)
  draw(heatmap_plot)
  dev.off()

  cat("✅ Heatmap saved for:", output_name, "\n")
}

generate_heatmap(
  results_path = file.path(base_path, "bacteria_colon/all_results.tsv"),
  expression_path = file.path(base_path, "combined_bacteria_S.csv"),
  output_name = "bacteria_colon_grouped"
)

generate_heatmap(
  results_path = file.path(base_path, "bacteria_intestine/all_results.tsv"),
  expression_path = file.path(base_path, "combined_bacteria_S.csv"),
  output_name = "bacteria_intestine_grouped"
)

generate_heatmap(
  results_path = file.path(base_path, "bacteria_cecum/all_results.tsv"),
  expression_path = file.path(base_path, "combined_bacteria_S.csv"),
  output_name = "bacteria_cecum_grouped"
)
```


```{r}
generate_heatmap(
  results_path = file.path(base_path, "fungi_colon/significant_results.tsv"),
  expression_path = file.path(base_path, "combined_fungi_S.csv"),
  output_name = "fungi_colon"
)

generate_heatmap(
  results_path = file.path(base_path, "fungi_intestine/significant_results.tsv"),
  expression_path = file.path(base_path, "combined_fungi_S.csv"),
  output_name = "fungi_intestine"
)

generate_heatmap(
  results_path = file.path(base_path, "fungi_cecum/significant_results.tsv"),
  expression_path = file.path(base_path, "combined_fungi_S.csv"),
  output_name = "fungi_cecum"
)

generate_heatmap(
  results_path = file.path(base_path, "virus_colon/significant_results.tsv"),
  expression_path = file.path(base_path, "combined_virus_S.csv"),
  output_name = "virus_colon"
)

generate_heatmap(
  results_path = file.path(base_path, "virus_intestine/significant_results.tsv"),
  expression_path = file.path(base_path, "combined_virus_S.csv"),
  output_name = "virus_intestine"
)

generate_heatmap(
  results_path = file.path(base_path, "virus_cecum/significant_results.tsv"),
  expression_path = file.path(base_path, "combined_virus_S.csv"),
  output_name = "virus_cecum"
)

cat("🎉 All heatmaps saved in:", heatmap_output_dir, "\n")
```


#MAKE A VENN DIAGRAM TO SHOW THE OVERLAP IN BACTERIAL TAXA IN COLON, CECUM, AND INTESTINE 

```{r}
# Read the MaAsLin2 results file into R
results_colon <- read.delim(
  "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_colon/all_results.tsv", header = TRUE, sep = "\t", stringsAsFactors = FALSE)
results_cecum <- read.delim(
  "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_cecum/all_results.tsv", header = TRUE, sep = "\t", stringsAsFactors = FALSE)
results_intestine <- read.delim(
  "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_intestine/all_results.tsv", header = TRUE, sep = "\t", stringsAsFactors = FALSE)
results_colon
results_cecum
results_intestine

# Filter for FDR < 0.05 and meaningful effect size
colon_up   <- results_colon$feature[results_colon$pval < 0.05 & results_colon$coef > 0]
colon_down <- results_colon$feature[results_colon$pval < 0.05 & results_colon$coef < 0]

cecum_up   <- results_cecum$feature[results_cecum$pval < 0.05 & results_cecum$coef > 0]
cecum_down <- results_cecum$feature[results_cecum$pval < 0.05 & results_cecum$coef < 0]

intestine_up   <- results_intestine$feature[results_intestine$pval < 0.05 & results_intestine$coef > 0]
intestine_down <- results_intestine$feature[results_intestine$pval < 0.05 & results_intestine$coef < 0]

library(ggvenn)

upregulated_taxa <- list(
  Colon = colon_up,
  Intestine = intestine_up,
  Cecum = cecum_up
)

venn_up <- ggvenn(upregulated_taxa,
       fill_color = c("skyblue", "lightgreen", "pink"),
       text_size = 8,
       set_name_size = 6,
       stroke_size = 0.3,
       show_percentage = FALSE) + ggtitle("Upregulated Taxa Across Intestinal Regions") +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    text = element_text(face = "bold"),
    legend.text = element_text(face = "bold")
  )

venn_up

shared_up <- Reduce(intersect, list(colon_up, intestine_up, cecum_up))
print(shared_up)

ggsave(
  filename = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/upregulated_taxa_venn.png",
  plot = venn_up,
  width = 5,
  height = 4,
  dpi = 300
)

downregulated_taxa <- list(
  Colon = colon_down,
  Intestine = intestine_down,
  Cecum = cecum_down
)

venn_down <- ggvenn(downregulated_taxa,
       fill_color = c("skyblue", "lightgreen", "pink"),
       text_size = 8,
       set_name_size = 6,
       stroke_size = 0.3,
       show_percentage = FALSE) + ggtitle("downregulated Taxa Across Intestinal Regions") +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    text = element_text(face = "bold"),
    legend.text = element_text(face = "bold"))

shared_down <- Reduce(intersect, list(colon_down, intestine_down, cecum_down))
print(shared_down)

ggsave(
  filename = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/downregulated_taxa_venn.png",
  plot = venn_down,
  width = 5,
  height = 4,
  dpi = 300
)

# Shared upregulated taxa between Colon and Cecum
intersect(colon_up, cecum_up)
intersect(colon_down, cecum_down)
intersect(colon_down, intestine_down)


```




#COMPARE HUMAN AND MOUSE GENERA. FIRST I WANT TO SHOW HOW MANY GENERA OVERLAP BETWEEN HUMANS AND OUR MICE. THEN I WANT TO MAKE TWO SEPARATE VENN DIAGRAMS AFTER THAT TO SHOW SHARED UPREGULATED AND DOWNREGULATED GENERA

```{r}

ZnD_samples <- metadata_ZnD5 %>%
  filter(Treatment == "ZnD") %>%
  pull(Sample) %>%
  gsub("ZnD5-", "ZnD5.", .)

ZnA_samples <- metadata_ZnD5 %>%
  filter(Treatment == "ZnA") %>%
  pull(Sample) %>%
  gsub("ZnD5-", "ZnD5.", .)  # Adjust if you also have "ZnA5-"

ZnD_samples
ZnA_samples
combined_bacteria_G

ZnD <- combined_bacteria_G[,ZnD_samples]
ZnA <- combined_bacteria_G[,ZnA_samples]
rownames(ZnD) <- paste0("g__", rownames(ZnD))
rownames(ZnA) <- paste0("g__", rownames(ZnA))
ZnD
ZnA
# Make sure Sample names match the format in your column names
metadata_ZnD5 <- metadata_ZnD5 %>%
  mutate(Sample_fixed = gsub("ZnD5-", "ZnD5.", Sample))

# Subset ZnD samples by location
ZnD_colon_samples <- metadata_ZnD5 %>%
  filter(Treatment == "ZnD", Location == "colon") %>%
  pull(Sample_fixed)

ZnD_intestine_samples <- metadata_ZnD5 %>%
  filter(Treatment == "ZnD", Location == "intestine") %>%
  pull(Sample_fixed)

ZnD_cecum_samples <- metadata_ZnD5 %>%
  filter(Treatment == "ZnD", Location == "cecum") %>%
  pull(Sample_fixed)

# Subset ZnA samples by location
ZnA_colon_samples <- metadata_ZnD5 %>%
  filter(Treatment == "ZnA", Location == "colon") %>%
  pull(Sample_fixed)

ZnA_intestine_samples <- metadata_ZnD5 %>%
  filter(Treatment == "ZnA", Location == "intestine") %>%
  pull(Sample_fixed)

ZnA_cecum_samples <- metadata_ZnD5 %>%
  filter(Treatment == "ZnA", Location == "cecum") %>%
  pull(Sample_fixed)

# Now subset the actual expression matrices
ZnD_colon <- ZnD[, ZnD_colon_samples]
ZnD_intestine <- ZnD[, ZnD_intestine_samples]
ZnD_cecum <- ZnD[, ZnD_cecum_samples]

ZnA_colon <- ZnA[, ZnA_colon_samples]
ZnA_intestine <- ZnA[, ZnA_intestine_samples]
ZnA_cecum <- ZnA[, ZnA_cecum_samples]

remove_zero_rows <- function(df) {
  df[rowSums(df) != 0, ]
}

# Apply to all subsets
ZnD_colon <- remove_zero_rows(ZnD_colon)
ZnD_intestine <- remove_zero_rows(ZnD_intestine)
ZnD_cecum <- remove_zero_rows(ZnD_cecum)

ZnA_colon <- remove_zero_rows(ZnA_colon)
ZnA_intestine <- remove_zero_rows(ZnA_intestine)
ZnA_cecum <- remove_zero_rows(ZnA_cecum)


ZnD_colon 
ZnD_intestine 
ZnD_cecum 
ZnA_colon 
ZnA_intestine 
ZnA_cecum 
```


```{r}
combined_bacteria_G

# Assuming you already have a metadata dataframe, e.g., `metadata_phy_ZnD5`
# And it contains a column named something like "ZnStatus" with values like "ZnD" and "ZnA"
metadata_ZnD5


# Top 25 genera in IBD
IBD_genera <- c(
  "g__Bacteroides", "g__Faecalibacterium", "g__Eubacterium", "g__Alistipes",
  "g__Roseburia", "g__Parabacteroides", "g__Subdoligranulum", "g__Escherichia",
  "g__Clostridium", "g__Prevotella", "g__Veillonella", "g__Blautia",
  "g__Oscillibacter", "g__Acidaminococcus", "g__Dialister", "g__Akkermansia",
  "g__Coprococcus", "g__Bifidobacterium", "g__Lachnospiraceae_noname", "g__Ruminococcus",
  "g__Paraprevotella", "g__Barnesiella", "g__Klebsiella", "g__Odoribacter", "g__Dorea"
)

# Top 25 genera in healthy humans
healthy_genera <- c(
  "g__Bacteroides", "g__Eubacterium", "g__Faecalibacterium", "g__Bifidobacterium",
  "g__Subdoligranulum", "g__Ruminococcus", "g__Alistipes", "g__Escherichia",
  "g__Blautia", "g__Roseburia", "g__Prevotella", "g__Coprococcus",
  "g__Collinsella", "g__Akkermansia", "g__Parabacteroides", "g__Dorea",
  "g__Streptococcus", "g__Dialister", "g__Butyrivibrio", "g__Lachnospiraceae_noname",
  "g__Megamonas", "g__Barnesiella", "g__Clostridium", "g__Phascolarctobacterium",
  "g__Erysipelotrichaceae_noname"
)

library(ggvenn)
library(ggplot2)

# Get genus names (from rownames) present in ZnD and ZnA
ZnD_present <- rownames(ZnD)
ZnA_present <- rownames(ZnA)

# Venn for ZnD vs IBD-associated genera
venn_ibd <- ggvenn(
  list(
    ZnD = ZnD_present,
    IBD = IBD_genera
  ),
  fill_color = c("lightcoral", "lightgray"),
  text_size = 6,
  set_name_size = 7,
  stroke_size = 0.3,
  show_percentage = FALSE
) +
  ggtitle("Overlap: ZnD vs. IBD-Associated Genera") +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.1),
    text = element_text(face = "bold"),
    plot.margin = margin(t = -5, r = 10, b = 10, l = 10)
  )

# Venn for ZnA vs Healthy-associated genera
venn_healthy <- ggvenn(
  list(
    ZnA = ZnA_present,
    Healthy = healthy_genera
  ),
  fill_color = c("lightblue", "lightgreen"),
  text_size = 6,
  set_name_size = 7,
  stroke_size = 0.3,
  show_percentage = FALSE
) +
  ggtitle("Overlap: ZnA vs. Healthy-Associated Genera") +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    text = element_text(face = "bold"),
    plot.margin = margin(t = -5, r = 10, b = 10, l = 10)
  )

# Display the plots
venn_ibd
venn_healthy

# Save ZnD vs IBD Venn
ggsave(
  filename = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/VennDiagrams/venn_ZnD_IBD.png",
  plot = venn_ibd,
  width = 5,
  height = 6,
  dpi = 300
)

# Save ZnA vs Healthy Venn
ggsave(
  filename = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/VennDiagrams/venn_ZnA_Healthy.png",
  plot = venn_healthy,
  width = 5,
  height = 6,
  dpi = 300
)



```

```{r}
library(ggvenn)
library(ggplot2)

# Custom function to create and save Venn diagrams
save_venn_plot <- function(set1, set2, label1, label2, title, colors, filename) {
  venn_plot <- ggvenn(
    setNames(list(set1, set2), c(label1, label2)),  # ✅ Proper naming
    fill_color = colors,
    text_size = 6,
    set_name_size = 3,
    stroke_size = 0.3,
    show_percentage = FALSE
  ) +
    ggtitle(title) +
    theme(
      plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 5)),
      text = element_text(face = "bold"),
      legend.text = element_text(face = "bold", size = 10),
      legend.title = element_text(face = "bold", size = 10),
      plot.margin = margin(t = 2, r = 10, b = 10, l = 10)
    )

  # Save as PNG
  ggsave(
    filename = filename,
    plot = venn_plot,
    width = 3, height = 3, dpi = 300
  )
}

# Set output directory
output_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/VennDiagrams/"

# Save all Venn diagrams
save_venn_plot(rownames(ZnD_colon), IBD_genera, "ZnD Colon", "IBD", "ZnD Colon vs IBD Genera",
               c("#D55E00", "lightgray"), paste0(output_dir, "venn_ZnD_colon.png"))

save_venn_plot(rownames(ZnD_intestine), IBD_genera, "ZnD Intestine", "IBD", "ZnD Intestine vs IBD Genera",
               c("#56B4E9", "lightgray"), paste0(output_dir, "venn_ZnD_intestine.png"))

save_venn_plot(rownames(ZnD_cecum), IBD_genera, "ZnD Cecum", "IBD", "ZnD Cecum vs IBD Genera",
               c("#009E73", "lightgray"), paste0(output_dir, "venn_ZnD_cecum.png"))

save_venn_plot(rownames(ZnA_colon), healthy_genera, "ZnA Colon", "Healthy", "ZnA Colon vs Healthy Genera",
               c("#D55E00", "lightgreen"), paste0(output_dir, "venn_ZnA_colon.png"))

save_venn_plot(rownames(ZnA_intestine), healthy_genera, "ZnA Intestine", "Healthy", "ZnA Intestine vs Healthy Genera",
               c("#56B4E9", "lightgreen"), paste0(output_dir, "venn_ZnA_intestine.png"))

save_venn_plot(rownames(ZnA_cecum), healthy_genera, "ZnA Cecum", "Healthy", "ZnA Cecum vs Healthy Genera",
               c("#009E73", "lightgreen"), paste0(output_dir, "venn_ZnA_cecum.png"))

```


```{r}
library(ggvenn)
library(ggplot2)

# Venn: ZnD_colon vs IBD
venn_ZnD_colon <- ggvenn(
  list(ZnD_colon = rownames(ZnD_colon), IBD = IBD_genera),
  fill_color = c("#D55E00", "lightgray"),
  text_size = 6, set_name_size = 7, stroke_size = 0.3, show_percentage = FALSE
) +
  ggtitle("ZnD Colon vs IBD Genera") +
  theme(plot.title = element_text(size = 16, face = "bold"),
    plot.margin = margin(t = 5, r = 10, b = 10, l = 10),
    legend.text = element_text(face = "bold"),
    legend.title = element_text(face = "bold"))

# Venn: ZnD_intestine vs IBD
venn_ZnD_intestine <- ggvenn(
  list(ZnD_intestine = rownames(ZnD_intestine), IBD = IBD_genera),
  fill_color = c("#56B4E9", "lightgray"),
  text_size = 6, set_name_size = 7, stroke_size = 0.3, show_percentage = FALSE
) +
  ggtitle("ZnD Intestine vs IBD Genera") +
  theme(plot.title = element_text(size = 16, face = "bold"))

# Venn: ZnD_cecum vs IBD
venn_ZnD_cecum <- ggvenn(
  list(ZnD_cecum = rownames(ZnD_cecum), IBD = IBD_genera),
  fill_color = c("#009E73", "lightgray"),
  text_size = 6, set_name_size = 7, stroke_size = 0.3, show_percentage = FALSE
) +
  ggtitle("ZnD Cecum vs IBD Genera") +
  theme(plot.title = element_text(size = 16, face = "bold"))

# Venn: ZnA_colon vs Healthy
venn_ZnA_colon <- ggvenn(
  list(ZnA_colon = rownames(ZnA_colon), Healthy = healthy_genera),
  fill_color = c("#D55E00", "lightgreen"),
  text_size = 6, set_name_size = 7, stroke_size = 0.3, show_percentage = FALSE
) +
  ggtitle("ZnA Colon vs Healthy Genera") +
  theme(plot.title = element_text(size = 16, face = "bold"))

# Venn: ZnA_intestine vs Healthy
venn_ZnA_intestine <- ggvenn(
  list(ZnA_intestine = rownames(ZnA_intestine), Healthy = healthy_genera),
  fill_color = c("#56B4E9", "lightgreen"),
  text_size = 6, set_name_size = 7, stroke_size = 0.3, show_percentage = FALSE
) +
  ggtitle("ZnA Intestine vs Healthy Genera") +
  theme(plot.title = element_text(size = 16, face = "bold"))

# Venn: ZnA_cecum vs Healthy
venn_ZnA_cecum <- ggvenn(
  list(ZnA_cecum = rownames(ZnA_cecum), Healthy = healthy_genera),
  fill_color = c("#009E73", "lightgreen"),
  text_size = 6, set_name_size = 7, stroke_size = 0.3, show_percentage = FALSE
) +
  ggtitle("ZnA Cecum vs Healthy Genera") +
  theme(plot.title = element_text(size = 16, face = "bold"))

venn_ZnD_colon
venn_ZnD_intestine
venn_ZnD_cecum
venn_ZnA_colon
venn_ZnA_intestine
venn_ZnA_cecum
```

#MAKE STACKED BAR CHARTS AT THE SPECIES LEVEL FOR BACTERIA/FUNGI/VIRUSES. THIS PLOT USES RELATIVE ABUNDANCE 

```{r}

# Load necessary library
library(data.table)

# Define file paths
bacteria_F <- fread("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_bacteria_F.csv", header = TRUE, sep = ",")
bacteria_G <- fread("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_bacteria_G.csv", header = TRUE, sep = ",")
bacteria_P <- fread("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_bacteria_P.csv", header = TRUE, sep = ",")
bacteria_S <- fread("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_bacteria_S.csv", header = TRUE, sep = ",")

bacteria_S
fungi_F <- fread("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_fungi_F.csv", header = TRUE, sep = ",")
fungi_G <- fread("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_fungi_G.csv", header = TRUE, sep = ",")
fungi_P <- fread("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_fungi_P.csv", header = TRUE, sep = ",")
fungi_S <- fread("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_fungi_S.csv", header = TRUE, sep = ",")

virus_F <- fread("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_virus_F.csv", header = TRUE, sep = ",")
virus_G <- fread("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_virus_G.csv", header = TRUE, sep = ",")
virus_P <- fread("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_virus_P.csv", header = TRUE, sep = ",")
virus_S <- fread("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/Bracken_Data_Sep_Kingdom/combined_virus_S.csv", header = TRUE, sep = ",")

setnames(bacteria_S, "V1", "name", skip_absent = TRUE)


fungi_F <- fungi_F %>% select(-sample, -sample.y, -sample.x)
fungi_G <- fungi_G %>% select(-sample, -sample.y, -sample.x)
fungi_P <- fungi_P %>% select(-sample, -sample.y, -sample.x)
setnames(fungi_S, "V1", "name", skip_absent = TRUE)
setnames(virus_S, "V1", "name", skip_absent = TRUE)

library(tibble)

bacteria_F <- bacteria_F %>% column_to_rownames(var = "name")
bacteria_G <- bacteria_G %>% column_to_rownames(var = "name")
bacteria_P <- bacteria_P %>% column_to_rownames(var = "name")
bacteria_S <- bacteria_S %>% column_to_rownames(var = "name")
bacteria_S 
fungi_F <- fungi_F %>% column_to_rownames(var = "name")
fungi_G <- fungi_G %>% column_to_rownames(var = "name")
fungi_P <- fungi_P %>% column_to_rownames(var = "name")
fungi_S <- fungi_S %>% column_to_rownames(var = "Name")
virus_F <- virus_F %>% column_to_rownames(var = "name")
virus_G <- virus_G %>% column_to_rownames(var = "name")
virus_P <- virus_P %>% column_to_rownames(var = "name")
virus_S <- virus_S %>% column_to_rownames(var = "name")
virus_S
dataframes <- list(
  "bacteria_F" = bacteria_F,
  "bacteria_G" = bacteria_G,
  "bacteria_P" = bacteria_P,
  "bacteria_S" = bacteria_S,
  "fungi_F" = fungi_F,
  "fungi_G" = fungi_G,
  "fungi_P" = fungi_P,
  "fungi_S" = fungi_S,
  "virus_F" = virus_F,
  "virus_G" = virus_G,
  "virus_P" = virus_P,
  "virus_S" = virus_S
)

# Update column names for all dataframes
dataframes <- lapply(dataframes, function(df) {
  colnames(df) <- gsub("ZnD5-(CL|Ce|IL)", "ZnD5.\\1", colnames(df))
  return(df)
})

# Assign back to individual dataframes
list2env(dataframes, envir = .GlobalEnv)




bacteria_F
bacteria_G 
bacteria_P
bacteria_S

fungi_F
fungi_G
fungi_P
fungi_S

virus_F
virus_G
virus_P
virus_S

```

#STACKED BAR CHARTS BY TREATMENT GROUP
```{r}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(tibble)

# 🔹 Function to generate stacked bar charts
generate_stacked_bar_chart <- function(data, metadata, title, output_path) {
  
  # Ensure rownames (taxa names) are preserved as a column
  data$Taxa <- rownames(data)
  
  # Convert to long format
  long_data <- data %>%
    pivot_longer(cols = -Taxa, names_to = "Sample", values_to = "Abundance") %>%
    left_join(metadata, by = "Sample")  

  # Normalize relative abundance within each sample
  long_data <- long_data %>%
    group_by(Sample) %>%
    mutate(Relative_Abundance = Abundance / sum(Abundance))

  # Aggregate by taxa to find the top 30 most abundant taxa
  top_30_taxa <- long_data %>%
    group_by(Taxa) %>%
    summarise(Total_Abundance = sum(Relative_Abundance, na.rm = TRUE)) %>%
    arrange(desc(Total_Abundance)) %>%
    slice_head(n = 30) %>%
    pull(Taxa)

  # Filter data to include only the top 30 taxa
  filtered_data <- long_data %>%
    filter(Taxa %in% top_30_taxa)

  # Aggregate by treatment group (mean relative abundance per treatment)
  summarized_data <- filtered_data %>%
    group_by(Treatment, Taxa) %>%
    summarise(Mean_Abundance = mean(Relative_Abundance, na.rm = TRUE), .groups = "drop")

  # Define a color palette
  color_palette <- colorRampPalette(c("#E8B31A", "#56B4E9", "#009E73", "#F0E442", "#75AE33", "#D55E00", "#CC79A7"))(30)

  # 🔹 Generate the stacked bar plot with improved spacing
  stacked_bar_plot <- ggplot(summarized_data, aes(x = Treatment, y = Mean_Abundance, fill = Taxa)) +
    geom_bar(stat = "identity", position = "fill", color = "black", width = 0.4) +  # Make bars slightly thinner
    scale_fill_manual(values = color_palette) +
    scale_x_discrete(expand = c(0, 0)) +
    coord_cartesian(xlim = c(0.5, length(unique(summarized_data$Treatment)) + 0.8)) +# Reduce space between bars
    theme_minimal() +
    labs(
      title = title,
      x = "Treatment Group",
      y = "Relative Abundance",
      fill = "Taxa"
    ) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 17, face = "bold"),
      axis.title.x = element_text(size = 16, face = "bold"),
      axis.title.y = element_text(size = 16, face = "bold"),
      axis.text.x = element_text(size = 14, face = "bold", angle = 45, hjust = 1),
      axis.text.y = element_text(size = 14, face = "bold"),
      legend.position = "bottom",  # Move legend below
      legend.title = element_text(size = 14, face = "bold"),  
      legend.text = element_text(size = 8, face = "bold"),  # Reduce legend text size
      legend.key.size = unit(0.5, "cm"),  # Adjust legend spacing
      legend.spacing.x = unit(0.2, "cm"),  # Reduce space between legend items
      legend.box = "horizontal"  # Keep legend in one row
    ) +
    guides(fill = guide_legend(ncol = 2, byrow = TRUE))+
    theme(aspect.ratio = 1)# Reduce legend height by making it multiple rows

  # Save the plot
  ggsave(output_path, plot = stacked_bar_plot, width = 4.5, height = 14, dpi = 300, limitsize = FALSE)

  return(stacked_bar_plot)
}


# 🔹 Define a mapping of dataset names to human-readable names
name_mapping <- list(
  "Bacteria_S" = "Bacterial Species",
  "Bacteria_G" = "Bacterial Genera",
  "Bacteria_F" = "Bacterial Families",
  "Bacteria_P" = "Bacterial Phyla"
  #"Fungi_S" = "Fungal Species",
  #"Fungi_G" = "Fungal Genera",
  #"Fungi_F" = "Fungal Families",
  #"Fungi_P" = "Fungal Phyla",
  #"Virus_S" = "Viral Species",
  #"Virus_G" = "Viral Genera",
  #"Virus_F" = "Viral Families",
  #"Virus_P" = "Viral Phyla"
)

# 🔹 Define datasets
datasets <- list(
  "Bacteria_S" = bacteria_S,
  "Bacteria_G" = bacteria_G,
  "Bacteria_F" = bacteria_F,
  "Bacteria_P" = bacteria_P
  #"Fungi_S" = fungi_S,
  #"Fungi_G" = fungi_G,
  #"Fungi_F" = fungi_F,
  #"Fungi_P" = fungi_P,
  #"Virus_S" = virus_S,
  #"Virus_G" = virus_G,
  #"Virus_F" = virus_F,
  #"Virus_P" = virus_P
)

# 🔹 Define locations
locations <- c("colon", "intestine", "cecum")

# Define directory for saving plots
output_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/figures/StackedBarCharts/Treatment"

# 🔹 Generate and save stacked bar charts for each dataset and location
plots <- list()
for (name in names(datasets)) {
  for (location in locations) {
    
    # Filter metadata for location
    metadata_location <- metadata_ZnD5 %>%
      filter(Location == location)

    # Filter dataset to keep only samples in this location
    dataset_location <- datasets[[name]][, colnames(datasets[[name]]) %in% metadata_location$Sample, drop = FALSE]

    # Convert dataset name to readable title
    readable_name <- name_mapping[[name]]

    # Define output path
    output_path <- paste0(output_dir, "stacked_bar_", name, "_", location, ".png")

    # Generate plot
    if (ncol(dataset_location) > 0) {  # Ensure dataset is not empty
      plots[[paste(name, location, sep = "_")]] <- generate_stacked_bar_chart(
        dataset_location, 
        metadata_location, 
        paste("Stacked Bar Chart of\n", readable_name, "in", location), 
        output_path
      )
    }
  }
}

# Display all plots
plots

```

#STACKED BAR CHARTS SEPARATED BY LOCATION, NOT TREATMENT GROUP

```{r}
metadata_ZnD5$Sample <- gsub("ZnD5\\.", "ZnD5-", metadata_ZnD5$Sample)
metadata_ZnD5

generate_stacked_bar_chart_by_location <- function(data, metadata, title, output_path) {
  
  data$Taxa <- rownames(data)
  
  long_data <- data %>%
    pivot_longer(cols = -Taxa, names_to = "Sample", values_to = "Abundance") %>%
    left_join(metadata, by = "Sample")  
  
  long_data$Location <- factor(long_data$Location, levels = c("intestine", "cecum", "colon"))

  long_data <- long_data %>%
    group_by(Sample) %>%
    mutate(Relative_Abundance = Abundance / sum(Abundance))

  top_30_taxa <- long_data %>%
    group_by(Taxa) %>%
    summarise(Total_Abundance = sum(Relative_Abundance, na.rm = TRUE)) %>%
    arrange(desc(Total_Abundance)) %>%
    slice_head(n = 30) %>%
    pull(Taxa)
  
  coverage_data <- long_data %>%
    group_by(Location, Sample) %>%
    summarise(Total_RelAbundance = sum(Relative_Abundance, na.rm = TRUE), .groups = "drop")

  top_30_coverage_data <- long_data %>%
    filter(Taxa %in% top_30_taxa) %>%
    group_by(Location, Sample) %>%
    summarise(Top30_RelAbundance = sum(Relative_Abundance, na.rm = TRUE), .groups = "drop")

# Join and calculate percentage
  coverage_summary <- left_join(coverage_data, top_30_coverage_data, by = c("Location", "Sample")) %>%
    mutate(Top30_Coverage = 100 * (Top30_RelAbundance / Total_RelAbundance)) %>%
    group_by(Location) %>%
    summarise(Mean_Top30_Coverage = mean(Top30_Coverage, na.rm = TRUE))

  print("Mean % of reads captured by global top 30 taxa per location:")
  print(coverage_summary)

  filtered_data <- long_data %>%
    filter(Taxa %in% top_30_taxa)

  summarized_data <- filtered_data %>%
    group_by(Location, Taxa) %>%
    summarise(Mean_Abundance = mean(Relative_Abundance, na.rm = TRUE), .groups = "drop")
  top_30_per_location <- summarized_data %>%
  group_by(Location) %>%
  arrange(desc(Mean_Abundance)) %>%
  slice_head(n = 30)

# Print it to console
print(top_30_per_location)

  color_palette <- colorRampPalette(c("#E8B31A", "#56B4E9", "#009E73", "#F0E442", "#75AE33", "#D55E00", "#CC79A7"))(30)

  stacked_bar_plot <- ggplot(summarized_data, aes(x = Location, y = Mean_Abundance, fill = Taxa)) +
    geom_bar(stat = "identity", position = "fill", color = "black", width = 0.6) +
    scale_fill_manual(values = color_palette) +
    theme_minimal() +
    labs(
      title = title,
      x = "",
      y = "Relative Abundance",
      fill = "Taxa"
    ) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
      axis.title.x = element_text(size = 14, face = "bold"),
      axis.title.y = element_text(size = 14, face = "bold"),
      axis.text.x = element_text(size = 14, face = "bold", angle = 45, hjust = 1,color = "black"),
      axis.text.y = element_text(size = 14, face = "bold",color = "black"),
      legend.position = "none",
      legend.title = element_text(size = 14, face = "bold"),  
      legend.text = element_text(size = 8, face = "bold"),
      legend.key.size = unit(0.5, "cm"),
      legend.spacing.x = unit(0.2, "cm"),
      legend.box = "horizontal"
    ) +
    guides(fill = guide_legend(ncol = 2, byrow = TRUE))

  #ggsave(output_path, plot = stacked_bar_plot, width = 2.3, height = 5, dpi = 300, limitsize = FALSE)

  return(stacked_bar_plot)
}

metadata_ZnD5$Sample <- gsub("ZnD5\\.", "ZnD5-", metadata_ZnD5$Sample)
metadata_ZnD5

name_mapping <- list(
  "Bacteria_S" = "Bacterial Species",
  "Bacteria_G" = "Bacterial Genera",
  "Bacteria_F" = "Bacterial Families",
  "Bacteria_P" = "Bacterial Phyla",
  "Fungi_S" = "Fungal Species",
  "Fungi_G" = "Fungal Genera",
  "Fungi_F" = "Fungal Families",
  "Fungi_P" = "Fungal Phyla",
  "Virus_S" = "Viral Species",
  "Virus_G" = "Viral Genera",
  "Virus_F" = "Viral Families",
  "Virus_P" = "Viral Phyla"
)

# 🔹 Define datasets
datasets <- list(
  "Bacteria_S" = bacteria_S,
  "Bacteria_G" = bacteria_G,
  "Bacteria_F" = bacteria_F,
  "Bacteria_P" = bacteria_P#,
  #"Fungi_S" = fungi_S,
  #"Fungi_G" = fungi_G,
  #"Fungi_F" = fungi_F,
  #"Fungi_P" = fungi_P,
  #"Virus_S" = virus_S,
  #"Virus_G" = virus_G,
  #"Virus_F" = virus_F,
  #"Virus_P" = virus_P
)

# 🔹 Define locations
locations <- c("colon", "intestine", "cecum")

# Define directory for saving plots
output_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/StackedBarCharts/Location"

# 🔹 Generate and save stacked bar charts for each dataset and location
plots <- list()

for (name in names(datasets)) {
  dataset <- datasets[[name]]
  dataset <- dataset[, colnames(dataset) %in% metadata_ZnD5$Sample, drop = FALSE]
  readable_name <- name_mapping[[name]]
  output_path <- paste0(output_dir, "stacked_bar_by_location_", name, ".png")

  if (ncol(dataset) > 0) {
    plots[[paste(name, "location", sep = "_")]] <- generate_stacked_bar_chart_by_location(
      dataset, 
      metadata_ZnD5, 
      paste("", readable_name, ""),
      output_path
    )
  }
}

plots


bacteria_P
bacteria_S
metadata_ZnD5


```

#FOR EXPORTING LEGEND ABOVE
```{r}
library(tidyverse)
library(ggplot2)
library(grid)
library(gridExtra)

# Function to extract just the legend from a ggplot object
extract_legend <- function(p) {
  g <- ggplotGrob(p + theme(legend.position = "right"))
  legend <- g$grobs[which(sapply(g$grobs, function(x) x$name) == "guide-box")][[1]]
  return(legend)
}

# Main function to generate and save the stacked bar chart + legend
generate_stacked_bar_chart_by_location <- function(data, metadata, title, output_path) {
  
  data$Taxa <- rownames(data)
  
  long_data <- data %>%
    pivot_longer(cols = -Taxa, names_to = "Sample", values_to = "Abundance") %>%
    left_join(metadata, by = "Sample")  

  long_data <- long_data %>%
    group_by(Sample) %>%
    mutate(Relative_Abundance = Abundance / sum(Abundance))

  top_30_taxa <- long_data %>%
    group_by(Taxa) %>%
    summarise(Total_Abundance = sum(Relative_Abundance, na.rm = TRUE)) %>%
    arrange(desc(Total_Abundance)) %>%
    slice_head(n = 30) %>%
    pull(Taxa)

  filtered_data <- long_data %>%
    filter(Taxa %in% top_30_taxa)

  summarized_data <- filtered_data %>%
    group_by(Location, Taxa) %>%
    summarise(Mean_Abundance = mean(Relative_Abundance, na.rm = TRUE), .groups = "drop")

  color_palette <- colorRampPalette(c(
    "#E8B31A", "#56B4E9", "#009E73", "#F0E442", 
    "#75AE33", "#D55E00", "#CC79A7"
  ))(30)

  stacked_bar_plot <- ggplot(summarized_data, aes(x = Location, y = Mean_Abundance, fill = Taxa)) +
    geom_bar(stat = "identity", position = "fill", color = "black", width = 0.6) +
    scale_fill_manual(values = color_palette) +
    theme_minimal() +
    labs(
      title = title,
      x = "Location",
      y = "Relative Abundance",
      fill = "Taxa"
    ) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 17, face = "bold"),
      axis.title.x = element_text(size = 16, face = "bold"),
      axis.title.y = element_text(size = 16, face = "bold"),
      axis.text.x = element_text(size = 14, face = "bold", angle = 45, hjust = 1),
      axis.text.y = element_text(size = 14, face = "bold"),
      legend.title = element_text(size = 14, face = "bold"),  
      legend.text = element_text(size = 8, face = "bold"),
      legend.key.size = unit(0.5, "cm"),
      legend.spacing.x = unit(0.2, "cm"),
      legend.box = "horizontal"
    ) +
    guides(fill = guide_legend(ncol = 2, byrow = TRUE))

  # Save full stacked bar chart

  # Extract and save legend only
  legend <- extract_legend(stacked_bar_plot)
  legend_path <- gsub(".png", "_legend.png", output_path)
  png(legend_path, width = 2000, height = 1000, res = 300)
  grid.draw(legend)
  dev.off()

  return(stacked_bar_plot)
}

# Mapping dataset names to human-readable names
name_mapping <- list(
  "Bacteria_S" = "Bacterial Species",
  "Bacteria_G" = "Bacterial Genera",
  "Bacteria_F" = "Bacterial Families",
  "Bacteria_P" = "Bacterial Phyla",
  "Fungi_S" = "Fungal Species",
  "Fungi_G" = "Fungal Genera",
  "Fungi_F" = "Fungal Families",
  "Fungi_P" = "Fungal Phyla",
  "Virus_S" = "Viral Species",
  "Virus_G" = "Viral Genera",
  "Virus_F" = "Viral Families",
  "Virus_P" = "Viral Phyla"
)

# List of datasets
datasets <- list(
  "Bacteria_S" = bacteria_S,
  "Bacteria_G" = bacteria_G,
  "Bacteria_F" = bacteria_F,
  "Bacteria_P" = bacteria_P,
  "Fungi_S" = fungi_S,
  "Fungi_G" = fungi_G,
  "Fungi_F" = fungi_F,
  "Fungi_P" = fungi_P,
  "Virus_S" = virus_S,
  "Virus_G" = virus_G,
  "Virus_F" = virus_F,
  "Virus_P" = virus_P
)

# Output directory
output_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/StackedBarCharts/Location/"

# Generate and save plots and legends
plots <- list()

for (name in names(datasets)) {
  dataset <- datasets[[name]]
  dataset <- dataset[, colnames(dataset) %in% metadata_ZnD5$Sample, drop = FALSE]
  readable_name <- name_mapping[[name]]
  output_path <- file.path(output_dir, paste0("stacked_bar_by_location_", name, ".png"))

  if (ncol(dataset) > 0) {
    plots[[paste(name, "location", sep = "_")]] <- generate_stacked_bar_chart_by_location(
      dataset, 
      metadata_ZnD5, 
      paste("", readable_name, "\nby Location"),
      output_path
    )
  }
}

```

#JUNE 3, 2025. GENERATING STACKED BAR CHARTS BY LOCATION, BUT CALCULATING THE TOP 30 TAXA INDEPENDANTLY FOR EACH LOCATION, RATHER THAN THE TOP 30 TAXA ACROSS THE ENTIRE DATASETS. I WILL NOT BE USING THIS BECAUSE I WILL JUSTIIFY IN THE RESULTS THAT THE TOP 30 TAXA SELECTED ACROSS ALL LOCATIONS STILL REPRESENTS 99.99% OF THE TAXA IN EACH OF THE LOCATIONS. 

```{r}
metadata_ZnD5$Sample <- gsub("ZnD5\\.", "ZnD5-", metadata_ZnD5$Sample)
metadata_ZnD5


generate_stacked_bar_chart_by_location <- function(data, metadata, title, output_path) {
  
  data$Taxa <- rownames(data)
  
  long_data <- data %>%
    pivot_longer(cols = -Taxa, names_to = "Sample", values_to = "Abundance") %>%
    left_join(metadata, by = "Sample")  
  
  long_data$Location <- factor(long_data$Location, levels = c("intestine", "cecum", "colon"))

  # Calculate relative abundance within each sample
  long_data <- long_data %>%
    group_by(Sample) %>%
    mutate(Relative_Abundance = Abundance / sum(Abundance)) %>%
    ungroup()
  
  # Summarize mean relative abundance per Location and Taxa
  summarized_data <- long_data %>%
    group_by(Location, Taxa) %>%
    summarise(Mean_Abundance = mean(Relative_Abundance, na.rm = TRUE), .groups = "drop")
  
  # For each location, select top 30 taxa
  top_30_taxa_per_location <- summarized_data %>%
    group_by(Location) %>%
    arrange(desc(Mean_Abundance)) %>%
    slice_head(n = 30)
  
  # Filter the summarized data to keep only these taxa
  summarized_data_filtered <- summarized_data %>%
    semi_join(top_30_taxa_per_location, by = c("Location", "Taxa"))
  
  # Print for debugging
  print(top_30_taxa_per_location)
  
  # Color palette
  color_palette <- colorRampPalette(c(
    "#E8B31A", "#56B4E9", "#009E73", "#F0E442", 
    "#75AE33", "#D55E00", "#CC79A7"
  ))(55)
  
  # Plot
  stacked_bar_plot <- ggplot(summarized_data_filtered, aes(x = Location, y = Mean_Abundance, fill = Taxa)) +
    geom_bar(stat = "identity", position = "fill", color = "black", width = 0.6) +
    scale_fill_manual(values = color_palette) +
    theme_minimal() +
    labs(
      title = title,
      x = "Location",
      y = "Relative Abundance",
      fill = "Taxa"
    ) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 17, face = "bold"),
      axis.title.x = element_text(size = 16, face = "bold"),
      axis.title.y = element_text(size = 16, face = "bold"),
      axis.text.x = element_text(size = 14, face = "bold", angle = 45, hjust = 1),
      axis.text.y = element_text(size = 14, face = "bold"),
      legend.title = element_text(size = 14, face = "bold"),  
      legend.text = element_text(size = 8, face = "bold"),
      legend.key.size = unit(0.5, "cm"),
      legend.spacing.x = unit(0.2, "cm"),
      legend.box = "horizontal"
    ) +
    guides(fill = guide_legend(ncol = 2, byrow = TRUE))
  
  ggsave(output_path, plot = stacked_bar_plot, width = 10, height = 6, dpi = 300)
  return(stacked_bar_plot)
}


name_mapping <- list(
  "Bacteria_S" = "Bacterial Species",
  "Bacteria_G" = "Bacterial Genera",
  "Bacteria_F" = "Bacterial Families",
  "Bacteria_P" = "Bacterial Phyla"
)

# 🔹 Define datasets
datasets <- list(
  "Bacteria_S" = bacteria_S,
  "Bacteria_G" = bacteria_G,
  "Bacteria_F" = bacteria_F,
  "Bacteria_P" = bacteria_P
)

# 🔹 Define locations
locations <- c("colon", "intestine", "cecum")

# Define directory for saving plots
output_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/StackedBarCharts/Location/June2025"

# 🔹 Generate and save stacked bar charts for each dataset and location
plots <- list()

for (name in names(datasets)) {
  dataset <- datasets[[name]]
  dataset <- dataset[, colnames(dataset) %in% metadata_ZnD5$Sample, drop = FALSE]
  readable_name <- name_mapping[[name]]
  output_path <- paste0(output_dir, "stacked_bar_by_location_", name, ".png")

  if (ncol(dataset) > 0) {
    plots[[paste(name, "location", sep = "_")]] <- generate_stacked_bar_chart_by_location(
      dataset, 
      metadata_ZnD5, 
      paste("", readable_name, ""),
      output_path
    )
  }
}

```


#JUNE 2, 2025 BY TREATMENT GROUP 

```{r}
library(tidyverse)
library(ggplot2)
library(grid)
library(gridExtra)
library(scales)
library(data.table)

# Helper function to read data with rownames
read_data_with_rownames <- function(file_path) {
  dt <- fread(file_path, header = TRUE, sep = ",")
  df <- as.data.frame(dt)
  rownames(df) <- df[[1]]
  df <- df[, -1, drop = FALSE]
  return(df)
}

# Load datasets
bacteria_F <- read_data_with_rownames("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_cecum/combined_bacteria_F.csv")
bacteria_G <- read_data_with_rownames("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_cecum/combined_bacteria_G.csv")
bacteria_P <- read_data_with_rownames("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_cecum/combined_bacteria_P.csv")
bacteria_S <- read_data_with_rownames("/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/DifferentialExpression/bacteria_cecum/combined_bacteria_S.csv")

# Clean metadata
metadata_ZnD5$Sample <- gsub("ZnD5\\.", "ZnD5-", metadata_ZnD5$Sample)
metadata_ZnD5$Location <- factor(metadata_ZnD5$Location, levels = c("intestine", "cecum", "colon"))
metadata_ZnD5$Treatment <- factor(metadata_ZnD5$Treatment, levels = c("ZnA", "ZnD"))

# Extract legend function
extract_legend <- function(p) {
  g <- ggplotGrob(p + theme(legend.position = "right"))
  legend <- g$grobs[which(sapply(g$grobs, function(x) x$name) == "guide-box")][[1]]
  return(legend)
}

# Stacked bar chart by treatment and location
generate_stacked_bar_chart_by_treatment <- function(data, metadata, location, title, output_path) {
  
  data$Taxa <- rownames(data)
  
  long_data <- data %>%
    pivot_longer(cols = -Taxa, names_to = "Sample", values_to = "Abundance") %>%
    left_join(metadata, by = "Sample") %>%
    filter(Location == location)
  
  if (nrow(long_data) == 0) {
    message("⚠️ Skipping ", location, " (no data)")
    return(NULL)
  }
  
  long_data <- long_data %>%
    group_by(Sample) %>%
    mutate(Relative_Abundance = Abundance / sum(Abundance))
  
  top_30_taxa <- long_data %>%
    group_by(Taxa) %>%
    summarise(Total_Abundance = sum(Relative_Abundance, na.rm = TRUE), .groups = "drop") %>%
    arrange(desc(Total_Abundance)) %>%
    slice_head(n = 30) %>%
    pull(Taxa)
  
  filtered_data <- long_data %>%
    filter(Taxa %in% top_30_taxa)
  
  summarized_data <- filtered_data %>%
    group_by(Treatment, Taxa) %>%
    summarise(Mean_Abundance = mean(Relative_Abundance, na.rm = TRUE), .groups = "drop")
  
  num_unique_terms <- summarized_data %>% pull(Taxa) %>% unique() %>% length()
  color_palette <- colorRampPalette(c(
    "#E8B31A", "#56B4E9", "#009E73", "#F0E442", 
    "#75AE33", "#D55E00", "#CC79A7"
  ))(num_unique_terms)
  
  stacked_bar_plot <- ggplot(summarized_data, aes(x = Treatment, y = Mean_Abundance, fill = Taxa)) +
    geom_bar(stat = "identity", position = "fill", color = "black", width = 0.6) +
    scale_fill_manual(values = color_palette) +
    scale_y_continuous(labels = scales::number_format(accuracy = 0.01)) +
    theme_minimal() +
    labs(
      title = title,
      x = "Treatment",
      y = "Relative Abundance",
      fill = "Taxa"
    ) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
      axis.title.x = element_text(size = 16, face = "bold"),
      axis.title.y = element_text(size = 16, face = "bold"),
      axis.text.x = element_text(size = 14, face = "bold", angle = 45, hjust = 1,  color = "black"),
      axis.text.y = element_text(size = 14, face = "bold",  color = "black"),
      legend.position = "none",
      legend.title = element_text(size = 14, face = "bold"),
      legend.text = element_text(size = 8, face = "bold"),
      legend.key.size = unit(0.5, "cm"),
      legend.spacing.x = unit(0.2, "cm"),
      legend.box = "horizontal"
    ) +
    guides(fill = guide_legend(ncol = 2,byrow = TRUE))
  
  ggsave(output_path, plot = stacked_bar_plot, width = 2.3, height = 5, dpi = 300, limitsize = FALSE)
  
  legend <- extract_legend(stacked_bar_plot)
  legend_path <- gsub(".png", "_legend.png", output_path)
  png(legend_path, width = 1500, height = 2000, res = 300)
  grid.draw(legend)
  dev.off()
  
  return(stacked_bar_plot)
}

# Taxonomic level mapping
name_mapping <- list(
  "Bacteria_S" = "Bacterial Species",
  "Bacteria_G" = "Bacterial Genera",
  "Bacteria_F" = "Bacterial Families",
  "Bacteria_P" = "Bacterial Phyla"
)

datasets <- list(
  "Bacteria_S" = bacteria_S,
  "Bacteria_G" = bacteria_G,
  "Bacteria_F" = bacteria_F,
  "Bacteria_P" = bacteria_P
)

output_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/PlusPF_Database/figures/StackedBarCharts/Treatment_by_Location/"
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)

locations <- c("intestine", "cecum", "colon")
plots <- list()

for (name in names(datasets)) {
  dataset <- datasets[[name]]
  dataset <- dataset[, colnames(dataset) %in% metadata_ZnD5$Sample, drop = FALSE]
  
  readable_name <- name_mapping[[name]]
  
  for (loc in locations) {
    output_path <- file.path(output_dir, paste0("stacked_bar_", name, "_", loc, ".png"))
    metadata_loc <- metadata_ZnD5 %>% filter(Location == loc)
    
    if (!is.null(dataset) && ncol(dataset) > 0 && !is.null(metadata_loc) && nrow(metadata_loc) > 0) {
      plots[[paste(name, loc, sep = "_")]] <- generate_stacked_bar_chart_by_treatment(
        dataset,
        metadata_ZnD5,
        loc,
        paste(readable_name, "\nby Treatment in", loc),
        output_path
      )
    } else {
      message("⚠️ Skipping ", name, " - ", loc, " (insufficient data)")
    }
  }
}

```




#NOW I WANT TO DO DIFFERENTIAL EXPRESSION ANALYSIS USING THE HUMANN3 DATA 

```{r}
library(dplyr) # For data manipulation

input_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/humann_output/ZnDvZnA/"
output_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/humann_output/ZnDvsZnA_NORM"   

# Create output directory if it doesn't exist
if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)

# Get a list of all pathabundance.tsv files in subdirectories
file_list <- list.files(input_dir, pattern = "pathabundance.tsv$", full.names = TRUE, recursive = TRUE)

# Initialize a list to store processed dataframes
data_list <- list()

# Loop through each file and process
for (file in file_list) {
  # Read the data
  data <- read.delim(file, header = TRUE, sep = "\t", row.names = 1)
  
  # Remove metadata rows (e.g., UNMAPPED, UNINTEGRATED) if present
  data_clean <- data[!grepl("UNMAPPED|UNINTEGRATED", rownames(data)), , drop = FALSE]
  
  # Check if data_clean has any rows or numeric columns
  if (nrow(data_clean) == 0 || !any(sapply(data_clean, is.numeric))) {
    cat("Skipping file (no valid data):", file, "\n")
    next
  }
  
  # Ensure only numeric columns remain
  data_numeric <- data_clean[, sapply(data_clean, is.numeric), drop = FALSE]
  
  # Convert all numeric values to integers
  data_integer <- data.frame(lapply(data_numeric, function(x) as.integer(as.numeric(as.character(x)))), 
                             row.names = rownames(data_numeric))
  
  # Add the sample name as a prefix to column names
  sample_name <- basename(dirname(file)) # Extract the sample folder name
  colnames(data_integer) <- paste0(sample_name, "_", colnames(data_integer))
  
  # Save the integer data to a new file
  output_file <- file.path(output_dir, paste0(sample_name, "_pathabundance_integer.tsv"))
  write.table(data_integer, output_file, sep = "\t", quote = FALSE, col.names = NA)
  
  # Add the dataframe to the list
  data_list[[sample_name]] <- data_integer
  
  # Print progress
  cat("Processed:", file, "\n")
}

# Combine all dataframes in the list by row names
library(tidyverse)

# Assuming `data_list` contains your 11 dataframes
# Initialize combined_data with the first dataframe in the list
combined_data <- data_list[[1]] %>%
  rownames_to_column(var = "Pathway") # Convert row names to a column

# Loop through the remaining dataframes and merge them one by one
for (i in 2:length(data_list)) {
  current_data <- data_list[[i]] %>%
    rownames_to_column(var = "Pathway") # Convert row names to a column
  
  # Merge with the accumulated combined_data
  combined_data <- full_join(combined_data, current_data, by = "Pathway")
}

# Convert "Pathway" column back to row names
combined_data <- column_to_rownames(combined_data, "Pathway")

# Save the combined dataframe to a CSV file
combined_output_file <- file.path(output_dir, "combined_pathabundance_integer.csv")
write.csv(combined_data, combined_output_file, row.names = TRUE)

cat("Combined dataframe saved to:", combined_output_file, "\n")


```

```{r}
combined_data
colnames(combined_data) <- gsub("_humann_output.*", "_humann_output", colnames(combined_data))
colnames(combined_data) <- gsub("(_R1).*", "\\1", colnames(combined_data))
# Replace the first hyphen with a period in column names
colnames(combined_data) <- gsub("-", ".", colnames(combined_data))
combined_data
```


```{r}
# Subset metadata_ZnD5 to include only samples that are in the colnames of combined_data
metadata_ZnD5_subset <- metadata_phy_ZnD5[metadata_phy_ZnD5$Sample %in% colnames(combined_data), ]

# Check the subset
metadata_ZnD5_subset


colnames(combined_data)

```


```{r}
library(tidyverse)
library(data.table)

# List all normalized files
normalized_files <- list.files(output_dir, pattern = "_pathabundance_integer.tsv$", full.names = TRUE)
print(normalized_files)

# Initialize an empty list to store data
data_list <- list()

# Loop through each file and prepare the data
for (file in normalized_files) {
  # Read the file
  data <- read.delim(file, header = TRUE, sep = "\t", row.names = 1)
  
  # Extract sample name from file name
  sample_name <- gsub("_humann_output_pathabundance_integer.tsv", "", basename(file))
  
  # Convert row names to a column for joining
  data <- data %>%
    rownames_to_column(var = "Pathway") %>%
    rename_with(~ sample_name, .cols = 2)  # Dynamically rename the second column
  
  # Add to list
  data_list[[sample_name]] <- data
}

library(tidyverse)
# Merge all dataframes by Pathway
combined_data <- purrr::reduce(data_list, full_join, by = "Pathway")
# Set Pathway as row names
combined_data <- combined_data %>%
  column_to_rownames(var = "Pathway")

# Replace NA values with 0
combined_data[is.na(combined_data)] <- 0

threshold <- ncol(combined_data) / 2

# Filter rows where the number of zeros is less than the threshold
filtered_data <- combined_data[rowSums(combined_data == 0) < threshold, ]

```


```{r}
library(Maaslin2)

combined_data_t <- t(combined_data)
combined_data_t <- as.data.frame(combined_data_t)
combined_data_t

# Replace the first hyphen (-) with a period (.) in rownames
rownames(combined_data_t) <- gsub("(?<=\\d{2}_ZnD5)-", ".", rownames(combined_data_t), perl = TRUE)



masalin_results_S_refC_c <- Maaslin2(
  combined_data_t,
  metadata_ZnD5_subset,
  output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/humann_output/Maaslin2_results_ZnD5_humann3_refc",     # Output directory
  fixed_effects = c("Treatment")  # Specify the grouping variable in your metadata
)

masalin_results_S_refC_c_location <- Maaslin2(
combined_data_t,
metadata_ZnD5_subset,
output = "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/humann_output/Maaslin2_results_ZnD5_humann3_refc_location",     # Output directory
fixed_effects = c("Location")  # Specify the grouping variable in your metadata
)


combined_data_t
levels(metadata_phy_ZnD5$Treatment)
metadata_phy_ZnD5
```

#HUMANN3 DIFFERENTIAL EXPRESSION, SEPARATED BY LOCATION

```{r}
# Load necessary libraries
library(Maaslin2)
library(dplyr)
library(tidyr)

# Ensure rownames of `combined_data_t` match the sample names in metadata
rownames(combined_data_t) <- gsub("(?<=\\d{2}_ZnD5)-", ".", rownames(combined_data_t), perl = TRUE)
combined_data_t
# Define output base directory
output_base_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/humann_output/Maaslin2_results_ZnD5_humann3_refc"

# Ensure the output directory exists
if (!dir.exists(output_base_dir)) dir.create(output_base_dir, recursive = TRUE)

# Define locations
locations <- c("colon", "intestine", "cecum")

# Loop through each location and perform differential expression
for (location in locations) {
  
  # Filter metadata for the current location
  metadata_location <- metadata_ZnD5_subset %>%
    filter(Location == location)

  # Extract sample names for the current location
  sample_names <- metadata_location$Sample

  # Filter `combined_data_t` to only include samples from this location
  combined_data_location <- combined_data_t[sample_names, , drop = FALSE]

  # Check if there are enough samples for analysis
  if (nrow(combined_data_location) < 2) {
    cat("Skipping location", location, "- Not enough samples for differential expression analysis\n")
    next
  }

  # Define location-specific output directory
  output_dir <- file.path(output_base_dir, paste0("Maaslin2_", location))
  if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)

  # Run Maaslin2 for ZnD vs ZnA within this location
  maaslin_results <- Maaslin2(
    input_data = combined_data_location,
    input_metadata = metadata_location,
    output = output_dir,
    fixed_effects = c("Treatment") # Compare ZnD vs ZnA
  )

  cat("Differential expression analysis completed for:", location, "\n")
}

```

#DIFFERENTIAL EXPRESSION SEPARATED BY COLON, INTESTNE, AND CECUM AND BACTERIA/FUNGI/VIRUSES
```{r}
# Load Maaslin2
library(Maaslin2)
library(dplyr)

# 1️⃣ **Filter metadata for each location**
metadata_colon <- metadata_phy_ZnD5 %>% filter(Location == "colon")
metadata_intestine <- metadata_phy_ZnD5 %>% filter(Location == "intestine")
metadata_cecum <- metadata_phy_ZnD5 %>% filter(Location == "cecum")

# 2️⃣ **Subset expression data to match metadata for each location**
filter_data_by_location <- function(data, metadata) {
  data_filtered <- data[rownames(data) %in% metadata$Sample, ]
  return(data_filtered)
}

# **Filter Bacteria**
bacteria_colon <- filter_data_by_location(bacteria_transposed, metadata_colon)
bacteria_intestine <- filter_data_by_location(bacteria_transposed, metadata_intestine)
bacteria_cecum <- filter_data_by_location(bacteria_transposed, metadata_cecum)

# **Filter Fungi**
fungi_colon <- filter_data_by_location(fungi_transposed, metadata_colon)
fungi_intestine <- filter_data_by_location(fungi_transposed, metadata_intestine)
fungi_cecum <- filter_data_by_location(fungi_transposed, metadata_cecum)

# **Filter Virus**
virus_colon <- filter_data_by_location(virus_transposed, metadata_colon)
virus_intestine <- filter_data_by_location(virus_transposed, metadata_intestine)
virus_cecum <- filter_data_by_location(virus_transposed, metadata_cecum)

# 3️⃣ **Run Maaslin2 for Each Intestinal Site**
run_maaslin2 <- function(data, metadata, output_dir, label) {
  Maaslin2(
    input_data = data,
    input_metadata = metadata,
    output = paste0(output_dir, "_", label),
    min_prevalence = 0.05,
    fixed_effects = c("Treatment")
  )
}

# **Define output directory**
output_dir <- "/Users/savitasastry/Downloads/Zinc_Deficiency_SS/Metagenomics/DifferentialExpression"

# **Run Maaslin2 for Bacteria**
run_maaslin2(bacteria_colon, metadata_colon, output_dir, "bacteria_colon")
run_maaslin2(bacteria_intestine, metadata_intestine, output_dir, "bacteria_intestine")
run_maaslin2(bacteria_cecum, metadata_cecum, output_dir, "bacteria_cecum")

# **Run Maaslin2 for Fungi**
run_maaslin2(fungi_colon, metadata_colon, output_dir, "fungi_colon")
run_maaslin2(fungi_intestine, metadata_intestine, output_dir, "fungi_intestine")
run_maaslin2(fungi_cecum, metadata_cecum, output_dir, "fungi_cecum")

# **Run Maaslin2 for Virus**
run_maaslin2(virus_colon, metadata_colon, output_dir, "virus_colon")
run_maaslin2(virus_intestine, metadata_intestine, output_dir, "virus_intestine")
run_maaslin2(virus_cecum, metadata_cecum, output_dir, "virus_cecum")

bacteria_transposed
metadata_colon

```

